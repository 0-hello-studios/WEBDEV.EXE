<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>WEBDEV.EXE</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&family=Bebas+Neue&family=Playfair+Display:wght@400;700;800&family=Inter:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700;800&family=Syne:wght@400;700;800&display=swap');
:root{--bg:#0a0a0e;--surface:#131318;--s2:#1a1a20;--s3:#222228;--border:#2a2a32;--bl:#3a3a44;--text:#b8b8c4;--dim:#5a5a68;--acc:#7c8af0;--ag:rgba(124,138,240,.2);--a2:#7c8af0;--a2g:rgba(124,138,240,.15);--green:#4ade80;--cyan:#67d4e8;--orange:#f0a050;--red:#f06060;--pink:#d080c0;--head:'Inter',sans-serif;--mono:'JetBrains Mono',monospace;--body:'Inter',sans-serif;--radius:6px}
*{margin:0;padding:0;box-sizing:border-box}
::selection{background:rgba(124,138,240,.2);color:#a0aaff}
body{background:var(--bg);color:var(--text);font-family:var(--body);height:100vh;overflow:hidden;user-select:none;display:flex;flex-direction:column;font-size:13px;line-height:1.5;-webkit-font-smoothing:antialiased}

/* ═══ TOPBAR ═══ */
.topbar{display:flex;flex-direction:column;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface);z-index:100}
.tb-row1{display:flex;align-items:center;height:34px;gap:5px;padding:0 10px;overflow-x:auto;scrollbar-width:none}
.tb-row1::-webkit-scrollbar{display:none}
.tb-row1>*{flex-shrink:0}
.tb-row2{display:flex;align-items:center;height:28px;gap:4px;padding:0 10px;border-top:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.tb-row2::-webkit-scrollbar{display:none}
.tb-row2>*{flex-shrink:0}
.topbar h1{font-family:var(--mono);font-weight:700;font-size:12px;color:#e0e0e8;letter-spacing:1px;text-transform:uppercase}
.topbar h1 span{color:var(--acc);font-weight:400}
.sep{width:1px;height:16px;background:var(--border);margin:0 2px;flex-shrink:0}
.abtn{background:transparent;border:1px solid var(--border);color:var(--dim);font-family:var(--mono);font-size:8px;font-weight:500;padding:3px 8px;border-radius:4px;cursor:pointer;transition:all .15s;letter-spacing:.3px;display:flex;align-items:center;gap:4px;white-space:nowrap}
.abtn:hover{border-color:var(--bl);color:var(--text);background:var(--s2)}
.abtn .dot{width:4px;height:4px;border-radius:50%;flex-shrink:0;opacity:.7}
.spacer{flex:1}
.xbtn{background:transparent;border:1px solid var(--green);color:var(--green);font-family:var(--mono);font-size:8px;font-weight:500;padding:3px 8px;border-radius:4px;cursor:pointer;transition:all .15s}
.xbtn:hover{background:rgba(74,222,128,.08);color:#6ee8a0}
.catl{font-size:7px;font-weight:700;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;font-family:var(--mono)}

/* ═══ WORKSPACE ═══ */
.workspace{flex:1;position:relative;overflow:hidden;background:var(--bg)}
.ws-scroll-h{position:absolute;bottom:0;left:0;right:14px;height:14px;background:var(--surface);border-top:1px solid var(--border);z-index:90}
.ws-scroll-v{position:absolute;top:0;right:0;bottom:14px;width:14px;background:var(--surface);border-left:1px solid var(--border);z-index:90}
.ws-scroll-corner{position:absolute;bottom:0;right:0;width:14px;height:14px;background:var(--s2);border-top:1px solid var(--border);border-left:1px solid var(--border);z-index:91}
.ws-thumb{position:absolute;background:var(--dim);border-radius:4px;opacity:.5;transition:opacity .15s;cursor:pointer;min-width:30px;min-height:30px}
.ws-thumb:hover,.ws-thumb.active{opacity:.8;background:var(--text)}
.ws-scroll-h .ws-thumb{height:8px;top:3px}
.ws-scroll-v .ws-thumb{width:8px;left:3px}
@media(pointer:coarse){.ws-scroll-h{height:22px;right:22px}.ws-scroll-v{width:22px;bottom:22px}.ws-scroll-corner{width:22px;height:22px}.ws-scroll-h .ws-thumb{height:14px;top:4px;border-radius:7px}.ws-scroll-v .ws-thumb{width:14px;left:4px;border-radius:7px}}
.ws-inner{position:relative;min-width:3000px;min-height:2000px}

/* ═══ PREVIEW WINDOW ═══ */
.lp-viewport{width:1280px;transform-origin:top left}

/* ═══ FLOATING WINDOWS ═══ */
.win{position:absolute;background:var(--surface);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;box-shadow:0 4px 24px rgba(0,0,0,.4);min-width:200px;min-height:80px;z-index:10}
.win.focused{z-index:50;border-color:var(--bl);box-shadow:0 8px 40px rgba(0,0,0,.5)}
.win.hidden{display:none}
.wh{display:flex;align-items:center;padding:0 10px;height:30px;gap:6px;cursor:move;flex-shrink:0;border-bottom:1px solid var(--border);background:var(--s2);border-radius:8px 8px 0 0}
.wc{width:3px;height:14px;border-radius:2px;flex-shrink:0;opacity:.6}
.wt{font-family:var(--mono);font-weight:600;font-size:10px;color:#d0d0d8;letter-spacing:.3px}
.wtag{font-size:6px;color:var(--dim);letter-spacing:1px;text-transform:uppercase;font-family:var(--mono)}
.wctrls{margin-left:auto;display:flex;gap:3px}
.wb{background:none;border:1px solid var(--border);color:var(--dim);font-size:8px;font-weight:700;width:18px;height:16px;border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;padding:0;font-family:var(--mono)}
.wb:hover{border-color:var(--dim);color:var(--text)}
.wb.close:hover{border-color:var(--red);color:var(--red)}
.wbody{flex:1;overflow:auto;padding:8px 10px}
.win.collapsed .wbody{display:none}
.win.collapsed{min-height:auto!important;height:auto!important}
.win.collapsed .wh{border-radius:6px;border-bottom:none}
.wresize{position:absolute;bottom:0;right:0;width:14px;height:14px;cursor:nwse-resize;z-index:10}
.wresize::after{content:'';position:absolute;bottom:3px;right:3px;width:6px;height:6px;border-right:2px solid var(--bl);border-bottom:2px solid var(--bl)}

/* ═══ TOOL FORM ELEMENTS ═══ */
label{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:600;color:var(--dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px;font-family:var(--mono)}
label .tip{display:inline-flex;align-items:center;justify-content:center;width:12px;height:12px;border-radius:50%;background:var(--s3);color:var(--dim);font-size:7px;font-weight:700;cursor:help}
select,input[type="text"],input[type="number"],textarea{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:var(--body);font-size:11px;color:var(--text);background:var(--s2);transition:all .12s;outline:none}
select:focus,input[type="text"]:focus,input[type="number"]:focus,textarea:focus{border-color:var(--acc);box-shadow:0 0 0 2px rgba(124,138,240,.08)}
select{cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 24 24' fill='none' stroke='%234a4a5e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 6px center;padding-right:22px}
textarea{resize:vertical;min-height:50px;font-family:var(--mono);font-size:10px;line-height:1.5}
input[type="range"]{-webkit-appearance:none;width:100%;height:3px;background:var(--border);border-radius:2px;outline:none;margin:6px 0}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;border-radius:50%;background:var(--acc);cursor:pointer;box-shadow:0 0 0 2px var(--surface)}
input[type="color"]{-webkit-appearance:none;border:1px solid var(--border);border-radius:4px;width:32px;height:26px;cursor:pointer;padding:2px;background:var(--s2)}
input[type="color"]::-webkit-color-swatch-wrapper{padding:0}
input[type="color"]::-webkit-color-swatch{border:none;border-radius:2px}
.field{margin-bottom:10px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}
.chips{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px}
.chip{padding:3px 8px;border:1px solid var(--border);border-radius:4px;font-size:9px;cursor:pointer;color:var(--dim);background:transparent;transition:all .1s;user-select:none;font-weight:500}
.chip:hover{border-color:var(--bl);color:var(--text)}
.chip.on{background:rgba(124,138,240,.08);border-color:rgba(124,138,240,.25);color:#a0aaff;font-weight:600}
.btn{display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border:none;border-radius:4px;font-family:var(--body);font-size:10px;font-weight:600;cursor:pointer;transition:all .12s}
.btn-primary{background:var(--acc);color:#fff;box-shadow:0 1px 4px rgba(124,138,240,.15)}.btn-primary:hover{box-shadow:0 2px 8px rgba(124,138,240,.25);filter:brightness(1.1)}
.btn-secondary{background:var(--s3);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--bl)}
.btn-sm{padding:3px 8px;font-size:9px;border-radius:3px}
.btn-copy{background:transparent;color:var(--dim);border:1px solid var(--border)}.btn-copy:hover{border-color:rgba(74,222,128,.3);color:var(--green)}
.actions{display:flex;gap:4px;margin-top:10px;flex-wrap:wrap}
.output{margin-top:12px;background:var(--s2);border:1px solid var(--border);border-radius:4px;overflow:hidden}
.win:not(.dev-active) .output{display:none}
.output-bar{display:flex;align-items:center;justify-content:space-between;padding:5px 8px;background:rgba(255,255,255,.01);border-bottom:1px solid var(--border)}
.output-bar span{font-size:8px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-family:var(--mono)}
.output-body{padding:8px 10px;font-family:var(--mono);font-size:10px;line-height:1.6;color:var(--text);white-space:pre-wrap;word-break:break-word;min-height:30px;max-height:200px;overflow:auto}
.output-body:empty::after{content:'Output appears here...';color:var(--dim);font-style:italic;font-family:var(--body);font-size:10px}
.preview-box{background:var(--s3);border:1px solid var(--border);border-radius:4px;padding:12px;margin-top:10px;display:flex;align-items:center;justify-content:center;min-height:100px;position:relative;overflow:hidden}
.preview-lg{min-height:160px}
.preview-full{width:100%;min-height:120px}
.score-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:6px}
.score-card{background:var(--s2);border:1px solid var(--border);border-radius:6px;padding:10px;text-align:center}
.score-card h4{font-size:7px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-family:var(--mono)}
.score-card .val{font-size:16px;font-weight:800;font-family:var(--head);color:var(--text)}
.color-swatch{width:100%;aspect-ratio:1;border-radius:6px;cursor:pointer;transition:transform .12s;position:relative;overflow:hidden}
.color-swatch:hover{transform:scale(1.05)}
.color-swatch .hex{position:absolute;bottom:4px;left:0;right:0;text-align:center;font-family:var(--mono);font-size:8px;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.6);font-weight:600}
.palette-row{display:flex;gap:0;border-radius:4px;overflow:hidden;height:80px}
.palette-row .swatch{flex:1;cursor:pointer;position:relative;transition:flex .2s}
.palette-row .swatch:hover{flex:1.3}
.palette-row .swatch .hex{position:absolute;bottom:6px;left:0;right:0;text-align:center;font-family:var(--mono);font-size:8px;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.7);opacity:0;transition:opacity .12s;font-weight:600}
.palette-row .swatch:hover .hex{opacity:1}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--s3);color:var(--text);padding:6px 16px;border-radius:4px;font-size:10px;font-weight:600;z-index:300;transition:transform .2s;pointer-events:none;border:1px solid var(--bl);font-family:var(--mono);box-shadow:0 8px 24px rgba(0,0,0,.5)}
.toast.show{transform:translateX(-50%) translateY(0)}
.colt{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:600;color:var(--dim);cursor:pointer;padding:5px 0;margin-bottom:5px;user-select:none;font-family:var(--mono)}
.colt:hover{color:var(--acc)}.colt .ar{transition:transform .12s;font-size:8px}.colt.open .ar{transform:rotate(90deg)}
.colb{display:none}.colb.open{display:block}
.fs{margin-bottom:14px}
.fst{font-size:8px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;font-family:var(--mono);display:flex;align-items:center;gap:6px}
.fst::after{content:'';flex:1;height:1px;background:var(--border)}

/* ═══ MODULE TABS ═══ */
.mod-tabs{display:flex;gap:1px;border-bottom:1px solid var(--border);margin:-8px -10px 10px;background:var(--s2)}
.mod-tab{flex:1;padding:6px 4px;font-size:8px;font-weight:600;font-family:var(--mono);letter-spacing:.3px;text-align:center;color:var(--dim);cursor:pointer;transition:all .12s;background:transparent;border:none;border-bottom:2px solid transparent}
.mod-tab:hover{color:var(--text);background:rgba(255,255,255,.02)}
.mod-tab.active{color:var(--acc);border-bottom-color:var(--acc);background:rgba(124,138,240,.03)}
.mod-section{display:none}.mod-section.active{display:block}
.mod-insert{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.mod-insert button{background:transparent;border:1px solid var(--border);color:var(--dim);font-family:var(--mono);font-size:7px;font-weight:600;padding:4px 8px;border-radius:3px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:3px}
.mod-insert button:hover{border-color:var(--bl);color:var(--text)}
/* Text module */
.tm-swatch{width:18px;height:18px;border-radius:3px;cursor:pointer;border:1px solid rgba(255,255,255,.06);transition:transform .1s}
.tm-swatch:hover{transform:scale(1.15)}
.tm-align{background:transparent;border:1px solid var(--border);color:var(--dim);font-size:10px;padding:4px 10px;border-radius:3px;cursor:pointer;transition:all .1s;font-family:var(--mono)}
.tm-align:hover{border-color:var(--bl);color:var(--text)}
.tm-align.active{border-color:var(--acc);color:var(--acc);background:rgba(124,138,240,.06)}
/* Dev mode toggle */
.dev-toggle{width:auto!important;padding:0 6px!important;font-size:8px!important;letter-spacing:-.5px!important;color:var(--dim)!important;border-color:var(--border)!important;gap:0!important}
.dev-toggle:hover{color:var(--green)!important;border-color:rgba(74,222,128,.3)!important}
.dev-toggle.active{background:rgba(74,222,128,.06)!important;border-color:rgba(74,222,128,.3)!important;color:var(--green)!important}
/* Dev mode banner */
.dev-banner{display:flex;align-items:center;gap:6px;padding:6px 10px;margin:-8px -10px 0;background:rgba(74,222,128,.03);border-bottom:1px solid rgba(74,222,128,.08);font-size:8px;font-weight:600;font-family:var(--mono);color:var(--green);letter-spacing:.5px}
.dev-banner span{font-size:10px}
.dev-tabs{margin-top:0!important;border-top:none!important}
.dev-tabs .mod-tab.active{color:var(--green);border-bottom-color:var(--green);background:rgba(74,222,128,.03)}

/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--bl)}
.ws-tex-opt{width:100%;aspect-ratio:1;border:1px solid var(--border);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--dim);transition:all .12s;padding:4px;background:var(--s2)}
.ws-tex-opt:hover{border-color:var(--bl);color:var(--text)}
.ws-tex-opt.active{border-color:var(--acc);color:var(--acc);background:rgba(124,138,240,.06)}
::-webkit-scrollbar-corner{background:var(--bg)}

/* ═══ LP TOKENS BAR (fixed at bottom of viewport) ═══ */
/* lp-bar hidden */

/* ═══ BLOCK SELECTION ═══ */
.dk-block{position:absolute;cursor:default;transition:box-shadow .08s}
.dk-block:hover{outline:1px solid rgba(168,85,247,.25);outline-offset:1px}
.dk-block.selected{outline:1.5px solid var(--acc);outline-offset:2px}
.dk-block.selected::after{content:attr(data-label);position:absolute;top:0;left:0;transform:translateY(-100%);background:var(--acc);color:#fff;font-size:7px;font-weight:600;padding:1px 6px;font-family:'JetBrains Mono',monospace;letter-spacing:.5px;z-index:5;pointer-events:none;white-space:nowrap;line-height:1.5;border-radius:2px 2px 0 0}
.dk-text{outline:none;cursor:inherit;-webkit-user-select:text;user-select:text}
.dk-text:focus{outline:none!important;box-shadow:none!important;cursor:text!important}
.dk-text[data-textgrad="1"]{-webkit-background-clip:text!important;background-clip:text!important;-webkit-text-fill-color:transparent!important}
.dk-block[data-editing="true"]{cursor:text!important;outline:none!important}
.dk-block[data-editing="true"] .dk-handle{display:none!important}
.dk-block[data-editing="true"]::after{display:none!important}
.dk-page{-webkit-user-select:none;user-select:none}
/* Resize handles */
.dk-handle{position:absolute;width:7px;height:7px;background:var(--acc);border:1px solid #fff;border-radius:1px;z-index:6;display:none}
.dk-block.selected .dk-handle{display:block}
.dk-handle.nw{top:-4px;left:-4px;cursor:nwse-resize}
.dk-handle.ne{top:-4px;right:-4px;cursor:nesw-resize}
.dk-handle.sw{bottom:-4px;left:-4px;cursor:nesw-resize}
.dk-handle.se{bottom:-4px;right:-4px;cursor:nwse-resize}
.dk-handle.rot{top:-28px;left:50%;margin-left:-5px;width:10px;height:10px;border-radius:50%;cursor:grab;background:var(--acc)}
.dk-handle.rot::before{content:'';position:absolute;left:50%;top:10px;width:1px;height:14px;background:#06b6d4;transform:translateX(-50%)}
/* Mode buttons */
.mode-btn.active{border-color:var(--acc)!important;color:var(--acc)!important;background:rgba(124,138,240,.06)!important}
/* Draw preview rect */
.dk-drawrect{position:absolute;border:2px dashed var(--acc);background:rgba(168,85,247,.06);pointer-events:none;z-index:10}
/* Page canvas */
.dk-page{position:relative!important;overflow:visible!important}
/* Cursor states */
.dk-page.mode-draw{cursor:crosshair!important;touch-action:none}
.dk-page.mode-text{touch-action:none}
.dk-page.mode-text{cursor:text!important}
.dk-page.mode-select{cursor:default!important}

/* ═══ TOUCH / TABLET / MOBILE ═══ */
@media(pointer:coarse){
  /* Bigger touch targets everywhere */
  .abtn{font-size:9px;padding:6px 12px;min-height:36px;border-radius:6px;gap:6px}
  .abtn .dot{width:6px;height:6px}
  .xbtn{font-size:9px;padding:6px 12px;min-height:36px;border-radius:6px}
  .sep{height:20px;margin:0 4px}

  /* Topbar rows */
  .tb-row1{height:44px;gap:4px;padding:0 8px;-webkit-overflow-scrolling:touch}
  .tb-row2{height:38px;gap:4px;padding:0 8px;-webkit-overflow-scrolling:touch}
  .topbar h1{font-size:13px}

  /* Scroll hints for toolbars */
  .tb-row1::after,.tb-row2::after{content:'';position:sticky;right:0;width:28px;min-width:28px;height:100%;background:linear-gradient(to right,transparent,var(--surface));pointer-events:none;flex-shrink:0}

  /* Windows — bigger headers, easier to grab */
  .win{min-width:280px;border-radius:12px}
  .wh{height:40px;padding:0 12px;gap:8px;border-radius:12px 12px 0 0}
  .wt{font-size:12px}
  .wtag{font-size:8px}
  .wb{width:28px;height:28px;font-size:12px;border-radius:6px}
  .wbody{padding:10px 12px}
  .win .resize{width:24px;height:24px;right:-4px;bottom:-4px}
  /* Window resize grip — bigger on touch */
  .wresize{width:28px;height:28px}
  .wresize::after{bottom:4px;right:4px;width:10px;height:10px;border-width:3px}

  /* Form elements */
  input[type="range"]{height:8px;min-height:36px;touch-action:none}
  input[type="range"]::-webkit-slider-thumb{width:24px;height:24px;border-radius:50%;margin-top:-8px;box-shadow:0 0 0 3px var(--surface),0 2px 8px rgba(0,0,0,.4)}
  input[type="range"]::-webkit-slider-runnable-track{height:8px;border-radius:4px}
  input[type="text"],input[type="number"],input[type="color"],select,textarea{
    font-size:14px!important;min-height:36px;padding:6px 10px!important;border-radius:6px}
  select{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='6'%3E%3Cpath d='M0 0l4 6 4-6' fill='%235a5a68'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px!important}

  /* Chips / toggle buttons */
  .chip,.pbtn,.tm-align{min-height:32px;font-size:10px!important;padding:6px 12px!important;border-radius:6px}

  /* Code output areas */
  .out{font-size:11px!important;padding:10px!important;border-radius:8px;-webkit-overflow-scrolling:touch}

  /* Tab buttons in modules */
  .mod-tab{font-size:10px;padding:6px 14px;min-height:32px}

  /* Block selection handles bigger for touch */
  .dk-handle{width:16px!important;height:16px!important;border-radius:4px!important;border-width:2px!important}
  .dk-handle.nw{top:-8px!important;left:-8px!important}
  .dk-handle.ne{top:-8px!important;right:-8px!important}
  .dk-handle.sw{bottom:-8px!important;left:-8px!important}
  .dk-handle.se{bottom:-8px!important;right:-8px!important}
  .dk-handle.rot{width:22px!important;height:22px!important;top:-36px!important;margin-left:-11px!important}
  .dk-handle.rot::before{top:12px!important;height:18px!important}

  /* Canvas/workspace */
  .workspace{overscroll-behavior:contain}

  /* Mode toolbar at bottom of page builder */
  .mode-bar{gap:4px}
  .mode-bar button{min-height:36px;font-size:10px;padding:4px 12px}

  /* Scrollbars — always visible on touch */
  .wbody::-webkit-scrollbar{width:6px}
  .wbody::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  /* Field labels */
  .field label{font-size:10px!important}
  .field{margin-bottom:8px}

  /* Color swatches bigger */
  .swatch,.pal-swatch{min-width:36px;min-height:36px;border-radius:6px}

  /* Toast */
  .toast{font-size:12px;padding:10px 20px;border-radius:8px}
}

/* Tablet landscape (iPad) */
@media(min-width:768px) and (max-width:1200px) and (pointer:coarse){
  .win{max-width:calc(100vw - 40px)}
  .lp-viewport{width:100%!important}
}

/* Small screens (phone) */
@media(max-width:768px){
  .abtn{font-size:8px;padding:4px 8px;min-height:32px}
  .xbtn{font-size:8px;padding:4px 8px;min-height:32px}
  .win{min-width:calc(100vw - 20px);max-width:calc(100vw - 20px);left:10px!important}
  .wh{height:36px}
  .wbody{padding:8px 10px}
  .topbar h1{font-size:11px}
  .tb-row1{height:40px}
  .tb-row2{height:34px}
}

/* Prevent iOS zoom on double-tap */
*{touch-action:manipulation}

.dk-page{touch-action:none}
.wh{touch-action:none}
.win .resize{touch-action:none}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- TOPBAR -->
<div class="topbar">
<div class="tb-row1">
<h1>WEBDEV<span>.EXE</span></h1>
<div class="sep"></div>
<button class="abtn" onclick="openModule('text')"><span class="dot" style="background:#8b8bf0"></span>Text</button>
<button class="abtn" onclick="openModule('color')"><span class="dot" style="background:#d080a0"></span>Color</button>
<button class="abtn" onclick="openModule('effects')"><span class="dot" style="background:#60b8c8"></span>Effects</button>
<button class="abtn" onclick="openModule('shape')"><span class="dot" style="background:#60c890"></span>Shape</button>
<button class="abtn" onclick="openModule('layout')"><span class="dot" style="background:#d0a860"></span>Layout</button>
<button class="abtn" onclick="openModule('animate')"><span class="dot" style="background:#d07070"></span>Animate</button>
<button class="abtn" onclick="openModule('export')"><span class="dot" style="background:#9080d0"></span>Export</button>
<button class="abtn" onclick="openModule('code')"><span class="dot" style="background:#707880"></span>Code</button>
<div class="spacer"></div>
<button class="xbtn" onclick="openPreview()" style="border-color:var(--green);color:var(--green)">PREVIEW</button>
<button class="xbtn" onclick="exportPage()">EXPORT HTML</button>
<button class="abtn" onclick="toggleSettings()" id="btn-settings" style="font-size:10px;padding:3px 6px" title="Settings">⚙</button>
<button class="abtn" onclick="openLearn()" style="font-size:10px;padding:3px 8px;border-color:rgba(124,138,240,.3);color:var(--acc)" title="Learn">?</button>
</div>
<div id="settings-overlay" onclick="toggleSettings()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:199"></div>
<div id="settings-panel" style="position:fixed;top:0;right:-280px;bottom:0;width:280px;background:var(--surface);border-left:1px solid var(--border);z-index:200;box-shadow:-4px 0 24px rgba(0,0,0,.3);display:flex;flex-direction:column;transition:right .2s ease">
<!-- Header -->
<div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0">
<span style="font-family:var(--mono);font-size:10px;font-weight:600;color:var(--text);letter-spacing:.5px">Settings</span>
<button onclick="toggleSettings()" style="background:none;border:1px solid var(--border);color:var(--dim);font-size:9px;width:20px;height:20px;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center">✕</button>
</div>
<!-- Scrollable body -->
<div style="flex:1;overflow-y:auto;padding:14px 16px;scrollbar-width:thin">
<!-- Themes -->
<div style="font-family:var(--mono);font-size:7px;font-weight:600;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px">Theme</div>
<div style="display:flex;gap:3px;margin-bottom:12px">
<button class="theme-cat-btn" data-cat="all" onclick="filterThemes('all',this)" style="font-family:var(--mono);font-size:7px;padding:3px 10px;border:1px solid var(--acc);border-radius:3px;background:rgba(124,138,240,.08);color:var(--acc);cursor:pointer;transition:all .12s">All</button>
<button class="theme-cat-btn" data-cat="dark" onclick="filterThemes('dark',this)" style="font-family:var(--mono);font-size:7px;padding:3px 10px;border:1px solid var(--border);border-radius:3px;background:transparent;color:var(--dim);cursor:pointer;transition:all .12s">Dark</button>
<button class="theme-cat-btn" data-cat="vibrant" onclick="filterThemes('vibrant',this)" style="font-family:var(--mono);font-size:7px;padding:3px 10px;border:1px solid var(--border);border-radius:3px;background:transparent;color:var(--dim);cursor:pointer;transition:all .12s">Vibrant</button>
<button class="theme-cat-btn" data-cat="light" onclick="filterThemes('light',this)" style="font-family:var(--mono);font-size:7px;padding:3px 10px;border:1px solid var(--border);border-radius:3px;background:transparent;color:var(--dim);cursor:pointer;transition:all .12s">Light</button>
</div>
<div id="theme-list" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px"></div>
<!-- Interface -->
<div style="border-top:1px solid var(--border);margin-top:16px;padding-top:16px">
<div style="font-family:var(--mono);font-size:7px;font-weight:600;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px">Interface</div>
<div style="display:flex;flex-direction:column;gap:10px">
<div style="display:flex;align-items:center;justify-content:space-between"><label style="font-size:9px;margin:0">Grid Dots</label><input type="checkbox" id="set-grid" checked onchange="toggleGrid(this.checked)" style="width:14px;height:14px;accent-color:var(--acc)"></div>
<div style="display:flex;align-items:center;justify-content:space-between"><label style="font-size:9px;margin:0">Snap to Grid</label><input type="checkbox" id="set-snap" onchange="if(this.checked!==snapGrid)toggleSnap()" style="width:14px;height:14px;accent-color:var(--acc)"></div>
<div style="display:flex;align-items:center;justify-content:space-between"><label style="font-size:9px;margin:0">Canvas Width</label><select onchange="setCanvasWidth(this.value)" style="width:90px;font-size:9px;padding:3px 6px"><option value="1280" selected>1280px</option><option value="1440">1440px</option><option value="1920">1920px</option><option value="960">960px</option><option value="768">768px</option><option value="390">390px</option></select></div>
</div>
</div>
<!-- Workspace -->
<div style="border-top:1px solid var(--border);margin-top:16px;padding-top:16px">
<div style="font-family:var(--mono);font-size:7px;font-weight:600;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px">Workspace</div>
<div style="display:flex;flex-direction:column;gap:10px">
<div style="display:flex;align-items:center;justify-content:space-between"><label style="font-size:9px;margin:0">Background</label><input type="color" id="ws-bg-color" value="#0a0a0e" oninput="setWsBg()" style="width:28px;height:20px;border-radius:3px;padding:1px;border:1px solid var(--border);cursor:pointer"></div>
<div><label style="font-size:9px;margin:0 0 6px">Texture</label>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:3px;margin-top:4px">
<div class="ws-tex-opt active" data-tex="dots" onclick="setWsTex('dots',this)" title="Dots"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><circle cx="6" cy="6" r="1" fill="currentColor" opacity=".4"/><circle cx="18" cy="6" r="1" fill="currentColor" opacity=".4"/><circle cx="6" cy="18" r="1" fill="currentColor" opacity=".4"/><circle cx="18" cy="18" r="1" fill="currentColor" opacity=".4"/><circle cx="12" cy="12" r="1" fill="currentColor" opacity=".4"/></svg></div>
<div class="ws-tex-opt" data-tex="grid" onclick="setWsTex('grid',this)" title="Grid"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><path d="M0 8h24M0 16h24M8 0v24M16 0v24" stroke="currentColor" stroke-width=".5" opacity=".3" fill="none"/></svg></div>
<div class="ws-tex-opt" data-tex="cross" onclick="setWsTex('cross',this)" title="Cross"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><path d="M10 12h4M12 10v4" stroke="currentColor" stroke-width=".7" opacity=".35" fill="none"/></svg></div>
<div class="ws-tex-opt" data-tex="lines" onclick="setWsTex('lines',this)" title="Lines"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><path d="M0 6h24M0 12h24M0 18h24" stroke="currentColor" stroke-width=".5" opacity=".25" fill="none"/></svg></div>
<div class="ws-tex-opt" data-tex="diag" onclick="setWsTex('diag',this)" title="Diagonal"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><path d="M0 24L24 0M-6 18L18-6M6 30L30 6" stroke="currentColor" stroke-width=".4" opacity=".2" fill="none"/></svg></div>
<div class="ws-tex-opt" data-tex="iso" onclick="setWsTex('iso',this)" title="Isometric"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><path d="M0 12l12-7 12 7M0 12l12 7 12-7" stroke="currentColor" stroke-width=".5" opacity=".25" fill="none"/></svg></div>
<div class="ws-tex-opt" data-tex="noise" onclick="setWsTex('noise',this)" title="Noise"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><circle cx="3" cy="5" r=".6" fill="currentColor" opacity=".2"/><circle cx="15" cy="7" r=".5" fill="currentColor" opacity=".25"/><circle cx="6" cy="11" r=".5" fill="currentColor" opacity=".2"/><circle cx="18" cy="11" r=".6" fill="currentColor" opacity=".22"/><circle cx="10" cy="21" r=".5" fill="currentColor" opacity=".2"/></svg></div>
<div class="ws-tex-opt" data-tex="none" onclick="setWsTex('none',this)" title="None"><svg viewBox="0 0 24 24" style="width:100%;height:100%"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width=".7" opacity=".25" fill="none"/></svg></div>
</div>
</div>
<div style="display:flex;align-items:center;justify-content:space-between"><label style="font-size:9px;margin:0">Size</label><input type="range" id="ws-tex-size" min="10" max="60" value="20" oninput="setWsBg()" style="width:100px;margin:0"></div>
<div style="display:flex;align-items:center;justify-content:space-between"><label style="font-size:9px;margin:0">Opacity</label><input type="range" id="ws-tex-op" min="1" max="15" value="2" oninput="setWsBg()" style="width:100px;margin:0"></div>
<div style="display:flex;gap:3px;flex-wrap:wrap" id="ws-presets"></div>
</div>
</div>
</div>
<div style="padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0">
<div style="font-family:var(--mono);font-size:7px;color:var(--dim);text-align:center;letter-spacing:.5px">WEBDEV.EXE — 0-HELLO Studios</div>
</div>
</div>
<div class="tb-row2">
<span class="catl">MODE</span>
<div class="sep" style="height:12px"></div>
<button class="abtn mode-btn active" data-mode="select" onclick="setMode('select')">Select</button>
<button class="abtn mode-btn" data-mode="draw" onclick="setMode('draw')">Draw</button>
<button class="abtn mode-btn" data-mode="text" onclick="setMode('text')">Text</button>
<div class="sep" style="height:12px"></div>
<span class="catl">ROLE</span>
<select id="draw-role" style="padding:2px 6px;font-size:8px;width:80px;font-family:var(--mono)">
<option value="frame">Frame</option>
<option value="text">Text</option>
<option value="heading">Heading</option>
<option value="button">Button</option>
<option value="image">Image</option>
<option value="link">Link</option>
<option value="input">Input</option>
<option value="icon">Icon</option>
</select>
<button class="abtn" onclick="imgInsert()" title="Upload Image">IMG</button>
<div class="sep" style="height:12px"></div>
<span class="catl">SNAP</span>
<button class="abtn" id="snap-btn" onclick="toggleSnap()" style="font-size:7px">Grid: ON</button>
<div class="sep" style="height:12px"></div>
<button class="abtn" onclick="undo()" title="Undo (Ctrl+Z)" id="btn-undo" style="opacity:.3">↶</button>
<button class="abtn" onclick="redo()" title="Redo (Ctrl+Y)" id="btn-redo" style="opacity:.3">↷</button>
<div class="spacer"></div>
<span id="sel-info" style="font-size:7px;color:var(--dim);font-family:var(--mono);letter-spacing:.5px">No selection</span>
<button class="abtn" id="desel-btn" onclick="clearSelection()" style="display:none;border-color:rgba(168,85,247,.4);color:#a855f7;font-weight:800;font-size:9px;padding:4px 10px">ESC</button>
<select id="sel-type" onchange="reTypeBlock(this.value)" style="display:none;font-size:7px;padding:0 2px;background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.3);border-radius:3px;color:#a855f7;font-family:var(--mono);font-weight:700;cursor:pointer;max-width:60px;height:16px">
<option>frame</option><option>heading</option><option>text</option><option>button</option><option>link</option><option>image</option><option>input</option><option>icon</option><option>nav</option><option>section</option><option>card</option><option>badge</option><option>divider</option><option>video</option>
</select>
<span id="sel-dims" style="font-size:7px;color:var(--dim);font-family:var(--mono)"></span>
<div class="sep" style="height:12px"></div>
<span style="font-size:7px;color:var(--dim)">↻</span>
<input type="number" id="rot-input" value="0" min="-360" max="360" step="15" onchange="setBlockRotation(+this.value)" style="width:40px;font-size:8px;padding:1px 3px;text-align:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:3px;color:var(--dim);font-family:var(--mono)">
<span style="font-size:7px;color:var(--dim)">°</span>
<div class="sep" style="height:12px"></div>
<button class="abtn" onclick="moveZ(-1)" title="Send back">↓</button>
<button class="abtn" onclick="moveZ(1)" title="Bring front">↑</button>
<button class="abtn" onclick="dupBlock()" title="Duplicate">+</button>
<button class="abtn" onclick="delBlock()" title="Delete" style="border-color:rgba(239,68,68,.3);color:rgba(239,68,68,.6)">✕</button>
</div>
</div>

<!-- WORKSPACE -->
<input type="file" id="dk-img-upload" accept="image/*" onchange="imgUpload(this)" style="display:none">
<div class="workspace" id="workspace" style="background-image:radial-gradient(circle,rgba(255,255,255,.03) 1px,transparent 1px);background-size:20px 20px">
<div class="ws-inner" id="wsI">
</div>
<div class="ws-scroll-h" id="wsScrollH"><div class="ws-thumb" id="wsThumbH"></div></div>
<div class="ws-scroll-v" id="wsScrollV"><div class="ws-thumb" id="wsThumbV"></div></div>
<div class="ws-scroll-corner"></div>
</div>

<!-- LP DESIGN TOKENS (hidden, accessed by theme system) -->
<div id="lp-bar" style="display:none">
<input type="color" id="lp-primary" value="#a855f7" oninput="updateLP()">
<input type="color" id="lp-secondary" value="#ec4899" oninput="updateLP()">
<input type="color" id="lp-accent" value="#06b6d4" oninput="updateLP()">
<input type="color" id="lp-bgc" value="#09090f" oninput="updateLP()">
<input type="color" id="lp-surface" value="#12121a" oninput="updateLP()">
<input type="color" id="lp-text" value="#f0f0f5" oninput="updateLP()">
<select id="lp-headfont" onchange="updateLP()"><option value="Syne">Syne</option><option value="Space Grotesk">Space Grotesk</option><option value="Playfair Display">Playfair</option><option value="Outfit">Outfit</option><option value="Poppins">Poppins</option><option value="system-ui,sans-serif">System</option></select>
<select id="lp-bodyfont" onchange="updateLP()"><option value="DM Sans">DM Sans</option><option value="Inter">Inter</option><option value="Nunito">Nunito</option><option value="system-ui,sans-serif">System</option></select>
<input type="range" id="lp-radius" min="0" max="24" value="12" oninput="updateLP()">
</div>

<script>
// ═══ WINDOW SYSTEM ═══
let topZ=10;let _dr=null;let _rs=null;
const ws=document.getElementById('workspace');
const wsI=document.getElementById('wsI');
const TOOL_META={"palette": {"name": "Palette Generator", "icon": "●"}, "gradient": {"name": "Gradient Maker", "icon": "◐"}, "shadow": {"name": "Shadow Generator", "icon": "■"}, "glass": {"name": "Glassmorphism", "icon": "◇"}, "type": {"name": "Typography Lab", "icon": "Aa"}, "pattern": {"name": "Pattern Maker", "icon": "◈"}, "noise": {"name": "Noise & Texture", "icon": "▤"}, "mesh": {"name": "Mesh Gradient", "icon": "◎"}, "sizes": {"name": "Canvas Sizes", "icon": "□"}, "contrast": {"name": "Contrast Checker", "icon": "◑"}, "colorconv": {"name": "Color Converter", "icon": "↺"}, "radius": {"name": "Border Radius Generator", "icon": "▢"}, "filters": {"name": "CSS Filter Playground", "icon": "◫"}, "textgrad": {"name": "Text Gradient", "icon": "A"}, "icons": {"name": "Icon Gallery", "icon": "★"}, "blob": {"name": "Blob Maker", "icon": "◠"}, "wave": {"name": "Wave Divider", "icon": "∿"}, "grid": {"name": "Grid Layout Builder", "icon": "⊞"}, "ratio": {"name": "Aspect Ratio Calculator", "icon": "⬚"}, "units": {"name": "Unit Converter", "icon": "↔"}, "placeholder": {"name": "Placeholder Generator", "icon": "▣"}, "neumorph": {"name": "Neumorphism Generator", "icon": "◉"}, "animate": {"name": "CSS Animation Builder", "icon": "▸"}, "cursor": {"name": "Cursor Customizer", "icon": "↗"}, "clip": {"name": "Clip Path Editor", "icon": "✂"}, "easing": {"name": "Easing Curves", "icon": "⌇"}, "spacing": {"name": "Spacing Scale Calculator", "icon": "⬚"}, "cbsim": {"name": "Color Blindness Simulator", "icon": "◐"}, "breakpoint": {"name": "Responsive Breakpoints", "icon": "▯"}, "favicon": {"name": "Favicon Generator", "icon": "★"}, "qr": {"name": "QR Code Generator", "icon": "▦"}, "mockup": {"name": "Device Mockup", "icon": "▭"}, "cheat": {"name": "CSS Cheat Sheet", "icon": "≡"}};
const TOOL_SIZES={"palette": [440, 380], "gradient": [420, 480], "shadow": [420, 520], "glass": [420, 520], "type": [500, 520], "pattern": [420, 400], "noise": [380, 370], "mesh": [380, 320], "sizes": [440, 400], "contrast": [420, 440], "colorconv": [380, 340], "radius": [440, 480], "filters": [440, 520], "textgrad": [420, 440], "icons": [440, 400], "blob": [400, 380], "wave": [500, 520], "grid": [420, 400], "ratio": [400, 420], "units": [380, 380], "placeholder": [420, 420], "neumorph": [440, 520], "animate": [440, 480], "cursor": [400, 400], "clip": [420, 420], "easing": [440, 520], "spacing": [420, 380], "cbsim": [440, 400], "breakpoint": [420, 380], "favicon": [420, 440], "qr": [400, 400], "mockup": [420, 380], "cheat": [500, 420]};
const openWindows={};

document.addEventListener('mousemove',e=>{
  if(_dr){const d=_dr;const wr=ws.getBoundingClientRect();const mx=e.clientX-wr.left+(window._wsScrollX?window._wsScrollX():0),my=e.clientY-wr.top+(window._wsScrollY?window._wsScrollY():0);d.w.style.left=Math.max(0,mx-d.ox)+'px';d.w.style.top=Math.max(0,my-d.oy)+'px'}
  if(_rs){const r=_rs;r.w.style.width=Math.max(220,r.sw+(e.clientX-r.sx))+'px';r.w.style.height=Math.max(100,r.sh+(e.clientY-r.sy))+'px'}
});
document.addEventListener('mouseup',()=>{_dr=null;_rs=null});
document.addEventListener('touchmove',e=>{
  if(_dr||_rs){e.preventDefault();const t=e.touches[0];
    if(_dr){const d=_dr;const wr=ws.getBoundingClientRect();const mx=t.clientX-wr.left+(window._wsScrollX?window._wsScrollX():0),my=t.clientY-wr.top+(window._wsScrollY?window._wsScrollY():0);d.w.style.left=Math.max(0,mx-d.ox)+'px';d.w.style.top=Math.max(0,my-d.oy)+'px'}
    if(_rs){const r=_rs;r.w.style.width=Math.max(280,r.sw+(t.clientX-r.sx))+'px';r.w.style.height=Math.max(150,r.sh+(t.clientY-r.sy))+'px'}
  }
},{passive:false});
document.addEventListener('touchend',()=>{_dr=null;_rs=null});

// Touch: double-tap window header to maximize/restore
const _isTouch='ontouchstart' in window||navigator.maxTouchPoints>0;
function toggleMaximize(win){
  if(win._maximized){
    win.style.left=win._restoreRect.l;win.style.top=win._restoreRect.t;
    win.style.width=win._restoreRect.w;win.style.height=win._restoreRect.h;
    win._maximized=false;
  }else{
    win._restoreRect={l:win.style.left,t:win.style.top,w:win.style.width,h:win.style.height};
    const wr=ws.getBoundingClientRect();
    win.style.left=(window._wsScrollX?window._wsScrollX():0)+'px';win.style.top=(window._wsScrollY?window._wsScrollY():0)+'px';
    win.style.width=wr.width+'px';win.style.height=wr.height+'px';
    win._maximized=true;
  }
}

// ═══ MODULE SYSTEM ═══
const MODULES={
  text:{name:'Text',icon:'Aa',color:'#8b8bf0',w:340,h:560,
    tools:['textmod'],tabs:['Style'],
    devTools:['type','textgrad','icons'],devTabs:['Typography','Text Grad','Icons']},
  color:{name:'Color',icon:'●',color:'#d080a0',w:380,h:480,
    tools:['colormod','palette','pattern'],tabs:['Fill','Palette','Pattern'],
    devTools:['palette','gradient','contrast','colorconv','cbsim'],devTabs:['Palette','Gradient','Contrast','Convert','Blindness']},
  effects:{name:'Effects',icon:'◇',color:'#60b8c8',w:420,h:520,
    tools:['stylemod','effectsmod','shadow','glass','filters','neumorph'],tabs:['Style','FX','Shadow','Glass','Filters','Neumorph'],
    devTools:['shadow','glass','filters','neumorph'],devTabs:['Shadow','Glass','Filters','Neumorph']},
  shape:{name:'Shape',icon:'◆',color:'#60c890',w:420,h:560,
    tools:['clip','radius','blob','wave','texture','noise','mesh'],
    tabs:['Shapes','Radius','Blob','Wave','Texture','Noise','Mesh'],
    devTools:['clip','radius','blob','wave','texture','noise','mesh'],devTabs:['Shapes','Radius','Blob','Wave','Texture','Noise','Mesh']},
  layout:{name:'Layout',icon:'⊞',color:'#d0a860',w:380,h:420,
    tools:['align','pagesize'],
    tabs:['Align','Page'],
    devTools:['grid','sizes','ratio','units','placeholder','spacing','breakpoint'],devTabs:['Grid','Sizes','Ratio','Units','Placeholder','Spacing','Breakpoints']},
  animate:{name:'Animate',icon:'▸',color:'#d07070',w:380,h:420,
    tools:['animblock','transitions'],
    tabs:['Animate','Transitions'],
    devTools:['animate','easing','cursor'],devTabs:['Animation','Easing','Cursor']},
  export:{name:'Export',icon:'↗',color:'#9080d0',w:400,h:440,
    tools:['expproject','exphtml','expdownload'],
    tabs:['Project','HTML','Download'],
    devTools:['favicon','qr','mockup','cheat'],devTabs:['Favicon','QR Code','Mockup','Cheat Sheet']},
  code:{name:'Code',icon:'&lt;/&gt;',color:'#707880',w:560,h:600,
    tools:['codeeditor'],
    tabs:['Editor'],
    devTools:['codeeditor'],devTabs:['Editor']}
};

function openModule(modId){
  const winId='_mod_'+modId;
  if(openWindows[winId]){
    const w=openWindows[winId];
    w.classList.remove('hidden');
    document.querySelectorAll('.win').forEach(x=>x.classList.remove('focused'));
    w.classList.add('focused');w.style.zIndex=++topZ;
    return;
  }
  const mod=MODULES[modId];
  if(!mod)return;
  
  const vx=(window._wsScrollX?window._wsScrollX():0)+ws.clientWidth/2-mod.w/2+(Math.random()-.5)*80;
  const vy=(window._wsScrollY?window._wsScrollY():0)+ws.clientHeight/2-mod.h/2+(Math.random()-.5)*60;
  
  const el=document.createElement('div');
  el.className='win focused';
  el.style.cssText=`left:${Math.max(10,Math.round(vx))}px;top:${Math.max(10,Math.round(vy))}px;width:${mod.w}px;height:${mod.h}px;z-index:${++topZ}`;
  el.dataset.tool=winId;
  
  const hd=document.createElement('div');hd.className='wh';
  const hasDevTools=mod.devTools&&mod.devTools.length>0;
  const toolCount=mod.tools.length;
  const devLabel=hasDevTools?`<button class="wb dev-toggle" title="Developer Mode" onclick="toggleDevMode(this,'${modId}')">⟨/⟩</button>`:'';
  hd.innerHTML=`<div class="wc" style="background:${mod.color}"></div><span class="wt">${mod.icon} ${mod.name}</span><span class="wtag">${toolCount} TOOL${toolCount>1?'S':''}</span><div class="wctrls">${devLabel}<button class="wb max" title="Maximize">☐</button><button class="wb min" title="Collapse">—</button><button class="wb close" title="Close">✕</button></div>`;
  
  const bd=document.createElement('div');bd.className='wbody';
  
  // Build tabs (skip if only 1 tool)
  let tabsHTML='';
  if(mod.tabs.length>1){
    tabsHTML='<div class="mod-tabs">';
    mod.tabs.forEach((tab,i)=>{
      tabsHTML+=`<button class="mod-tab${i===0?' active':''}" data-idx="${i}" onclick="switchModTab(this)">${tab}</button>`;
    });
    tabsHTML+='</div>';
  }
  
  // Build sections from existing templates
  let sectionsHTML='';
  mod.tools.forEach((toolId,i)=>{
    const tmpl=document.getElementById('tmpl-'+toolId);
    let content=tmpl?tmpl.innerHTML:'<p style="color:var(--dim);font-size:10px">Tool not found</p>';
    
    // Add insert buttons for text module
    let insertHTML='';
    if(modId==='text'&&toolId==='type'){
      insertHTML=`<div class="mod-insert">
        <button onclick="createBlock(100,100,300,40,'heading');setMode('select')">+ Heading</button>
        <button onclick="createBlock(100,160,400,30,'text');setMode('select')">+ Text</button>
        <button onclick="createBlock(100,210,140,44,'button');setMode('select')">+ Button</button>
        <button onclick="createBlock(100,270,120,30,'link');setMode('select')">+ Link</button>
      </div>`;
    }
    
    sectionsHTML+=`<div class="mod-section${i===0?' active':''}" data-idx="${i}">${insertHTML}${content}</div>`;
  });
  
  bd.innerHTML=tabsHTML+sectionsHTML;
  
  const rsz=document.createElement('div');rsz.className='wresize';
  el.append(hd,bd,rsz);
  
  // Window events (focus, drag, resize, collapse, close)
  el.addEventListener('mousedown',()=>{document.querySelectorAll('.win').forEach(x=>x.classList.remove('focused'));el.classList.add('focused');el.style.zIndex=++topZ});
  hd.addEventListener('mousedown',e=>{if(e.target.closest('.wb'))return;e.preventDefault();el.classList.add('focused');el.style.zIndex=++topZ;const wr=ws.getBoundingClientRect();const mx=e.clientX-wr.left+(window._wsScrollX?window._wsScrollX():0),my=e.clientY-wr.top+(window._wsScrollY?window._wsScrollY():0);_dr={w:el,ox:mx-el.offsetLeft,oy:my-el.offsetTop}});
  hd.addEventListener('touchstart',e=>{if(e.target.closest('.wb'))return;e.preventDefault();el.classList.add('focused');el.style.zIndex=++topZ;const t=e.touches[0];const wr=ws.getBoundingClientRect();const mx=t.clientX-wr.left+(window._wsScrollX?window._wsScrollX():0),my=t.clientY-wr.top+(window._wsScrollY?window._wsScrollY():0);_dr={w:el,ox:mx-el.offsetLeft,oy:my-el.offsetTop}},{passive:false});
  rsz.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();_rs={w:el,sx:e.clientX,sy:e.clientY,sw:el.offsetWidth,sh:el.offsetHeight}});
  rsz.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();const t=e.touches[0];_rs={w:el,sx:t.clientX,sy:t.clientY,sw:el.offsetWidth,sh:el.offsetHeight}},{passive:false});
  hd.querySelector('.min').addEventListener('click',()=>el.classList.toggle('collapsed'));
  hd.querySelector('.max').addEventListener('click',()=>toggleMaximize(el));
  hd.querySelector('.close').addEventListener('click',()=>{el.remove();delete openWindows[winId]});
  // Double-tap header to maximize on touch
  let _lastTap=0;
  hd.addEventListener('touchend',e=>{
    if(e.target.closest('.wb'))return;
    const now=Date.now();
    if(now-_lastTap<300){toggleMaximize(el);e.preventDefault()}
    _lastTap=now;
  });
  
  wsI.appendChild(el);
  openWindows[winId]=el;
  
  // Init chips in this window
  el.querySelectorAll('.chips').forEach(g=>{g.querySelectorAll('.chip').forEach(c=>{c.addEventListener('click',()=>{g.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));c.classList.add('on');const fn=g.dataset.fn;if(fn&&window[fn])window[fn]()})})});
  
  // Init the first tool
  initTool(mod.tools[0]);
}

function switchModTab(tabEl){
  const parent=tabEl.closest('.wbody');
  const idx=parseInt(tabEl.dataset.idx);
  parent.querySelectorAll('.mod-tab').forEach(t=>t.classList.toggle('active',t.dataset.idx===String(idx)));
  parent.querySelectorAll('.mod-section').forEach(s=>s.classList.toggle('active',s.dataset.idx===String(idx)));
  // Find which module this belongs to and init the tool
  const win=tabEl.closest('.win');
  const winId=win?.dataset.tool?.replace('_mod_','');
  const mod=MODULES[winId];
  if(!mod)return;
  // Check if in dev mode
  const isDev=win.querySelector('.dev-toggle.active')!==null;
  const tools=isDev?mod.devTools:mod.tools;
  if(tools&&tools[idx]){
    // Init chips in newly visible section
    const section=parent.querySelectorAll('.mod-section')[idx];
    if(section){
      section.querySelectorAll('.chips').forEach(g=>{
        if(g.dataset.bound)return;
        g.dataset.bound='1';
        g.querySelectorAll('.chip').forEach(c=>{c.addEventListener('click',()=>{g.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));c.classList.add('on');const fn=g.dataset.fn;if(fn&&window[fn])window[fn]()})});
      });
    }
    initTool(tools[idx]);
  }
}

function toggleDevMode(btn,modId){
  const win=btn.closest('.win');
  if(!win)return;
  const bd=win.querySelector('.wbody');
  const mod=MODULES[modId];
  if(!mod)return;
  
  const isDev=btn.classList.toggle('active');
  win.classList.toggle('dev-active',isDev);
  const tools=isDev?mod.devTools:mod.tools;
  const tabs=isDev?mod.devTabs:mod.tabs;
  
  // Update tag
  const tag=win.querySelector('.wtag');
  if(tag)tag.textContent=isDev?`DEV · ${tools.length}`:`${tools.length} TOOL${tools.length>1?'S':''}`;
  
  // Rebuild body
  let html='';
  
  if(!isDev){
    // Visual mode - single tool, no tabs for text module
    if(tabs.length>1){
      html+='<div class="mod-tabs">';
      tabs.forEach((tab,i)=>html+=`<button class="mod-tab${i===0?' active':''}" data-idx="${i}" onclick="switchModTab(this)">${tab}</button>`);
      html+='</div>';
    }
    tools.forEach((toolId,i)=>{
      const tmpl=document.getElementById('tmpl-'+toolId);
      html+=`<div class="mod-section${i===0?' active':''}" data-idx="${i}">${tmpl?tmpl.innerHTML:''}</div>`;
    });
  }else{
    // Dev mode - tabbed reference tools with proper headers
    html+='<div class="dev-banner"><span>⟨/⟩</span> Developer Reference</div>';
    html+='<div class="mod-tabs dev-tabs">';
    tabs.forEach((tab,i)=>html+=`<button class="mod-tab${i===0?' active':''}" data-idx="${i}" onclick="switchModTab(this)">${tab}</button>`);
    html+='</div>';
    tools.forEach((toolId,i)=>{
      const tmpl=document.getElementById('tmpl-'+toolId);
      const content=tmpl?tmpl.innerHTML:'';
      html+=`<div class="mod-section${i===0?' active':''}" data-idx="${i}">${content}</div>`;
    });
  }
  
  bd.innerHTML=html;
  
  // Init all chips in this window
  bd.querySelectorAll('.chips').forEach(g=>{
    g.querySelectorAll('.chip').forEach(c=>{
      c.addEventListener('click',()=>{
        g.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));
        c.classList.add('on');
        const fn=g.dataset.fn;
        if(fn&&window[fn])window[fn]();
      });
    });
  });
  
  // Init first tool with slight delay for DOM
  if(tools[0])setTimeout(()=>initTool(tools[0]),60);
  
  // Resize window if switching to dev mode (dev tools need more width)
  if(isDev&&win.offsetWidth<440){
    win.style.width='460px';
  }else if(!isDev&&modId==='text'){
    win.style.width=mod.w+'px';
  }
}


function initTool(id){
  const inits={
    palette:()=>genPalette(),colormod:()=>cmReadSelection(),effectsmod:()=>fxReadSelection(),gradient:()=>updateGrad(),shadow:()=>updateShadow(),glass:()=>updateGlass(),
    type:()=>updateType(),textmod:()=>tmReadSelection(),pattern:()=>updatePattern(),noise:()=>updateNoise(),mesh:()=>updateMesh(),
    sizes:()=>renderSizes(),contrast:()=>updateContrast(),colorconv:()=>convertColor('#a855f7'),
    radius:()=>updateRadius(),filters:()=>updateFilters(),textgrad:()=>updateTextGrad(),
    icons:()=>renderIcons(),blob:()=>genBlob(),wave:()=>genWave(),grid:()=>updateGrid(),
    ratio:()=>calcRatio(),units:()=>convertUnits(),placeholder:()=>updatePlaceholder(),
    neumorph:()=>updateNeu(),animate:()=>updateAnim(),cursor:()=>updateCursor(),
    align:()=>alReadSelection(),padmar:()=>pmReadSelection(),texture:()=>genTexture(),stylemod:()=>pmReadSelection(),pagesize:()=>pgReadSelection(),animblock:()=>abReadSelection(),transitions:()=>{},exphtml:()=>expInitHTML(),expcss:()=>expInitCSS(),expdownload:()=>expUpdateInfo(),expproject:()=>projUpdateInfo(),codeeditor:()=>{},
    clip:()=>updateClip(),easing:()=>drawEase(),spacing:()=>genSpacing(),
    cbsim:()=>updateCBSim(),breakpoint:()=>renderBreakpoints(),favicon:()=>genFavicon(),
    qr:()=>genQR(),mockup:()=>updateMockup(),cheat:()=>renderCheat()
  };
  // Init chips in this window
  const win=openWindows[id];
  if(win){
    win.querySelectorAll('.chips').forEach(g=>{g.querySelectorAll('.chip').forEach(c=>{c.addEventListener('click',()=>{g.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));c.classList.add('on');const fn=g.dataset.fn;if(fn&&window[fn])window[fn]()})})});
  }
  if(inits[id]){_initingTab=true;setTimeout(()=>{inits[id]();_initingTab=false},50)}
}
let _initingTab=false;


// ═══ CORE (original tools) ═══
function gv(id){const el=document.getElementById(id);return el?el.value:''}
function sv(id,val){const el=document.getElementById(id);if(el)el.value=val}
function st(id,txt){const el=document.getElementById(id);if(el)el.textContent=txt}
function getPageW(){const vp=document.getElementById('lp-viewport');return parseInt(vp?.style.width)||1280}
function getChip(id){return document.querySelector(`#${id} .chip.on`)?.dataset.v||''}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
function copyFrom(id,btn){const t=document.getElementById(id).textContent;if(!t){toast('Nothing to copy');return}navigator.clipboard.writeText(t);toast('Copied!');if(btn){const o=btn.innerHTML;btn.innerHTML='✓';setTimeout(()=>btn.innerHTML=o,1200)}}
function randHex(){return '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0')}
function hsl2hex(h,s,l){s/=100;l/=100;const a=s*Math.min(l,1-l);const f=n=>{const k=(n+h/30)%12;const c=l-a*Math.max(Math.min(k-3,9-k,1),-1);return Math.round(255*c).toString(16).padStart(2,'0')};return`#${f(0)}${f(8)}${f(4)}`}

// ═══ PALETTE GENERATOR ═══
let palColors=['#a855f7','#ec4899','#06b6d4','#f59e0b','#10b981'];
let palLocked=[false,false,false,false,false];
function genPalette(){
  const mode=getChip('pal-mode');const baseH=Math.random()*360;
  for(let i=0;i<5;i++){
    if(palLocked[i])continue;
    if(mode==='random')palColors[i]=randHex();
    else if(mode==='analogous')palColors[i]=hsl2hex((baseH+i*30)%360,70+Math.random()*20,50+Math.random()*20);
    else if(mode==='complementary'){const h=i<3?baseH:(baseH+180)%360;palColors[i]=hsl2hex(h+i*10,65+Math.random()*25,40+Math.random()*30)}
    else if(mode==='triadic')palColors[i]=hsl2hex((baseH+i*120)%360,65+Math.random()*25,45+Math.random()*25);
    else if(mode==='monochromatic')palColors[i]=hsl2hex(baseH,50+Math.random()*30,20+i*15+Math.random()*10);
    else if(mode==='pastel')palColors[i]=hsl2hex(Math.random()*360,40+Math.random()*30,75+Math.random()*15);
    else if(mode==='dark')palColors[i]=hsl2hex(Math.random()*360,30+Math.random()*40,10+Math.random()*25);
    else if(mode==='neon')palColors[i]=hsl2hex(Math.random()*360,90+Math.random()*10,55+Math.random()*15);
  }
  renderPalette();
}
function renderPalette(){
  const row=document.getElementById('pal-row');const locks=document.getElementById('pal-locks');
  row.innerHTML=palColors.map((c,i)=>`<div class="swatch" style="background:${c}" onclick="copyColor('${c}')"><span class="hex">${c.toUpperCase()}</span></div>`).join('');
  locks.innerHTML=palColors.map((c,i)=>`<div class="chip ${palLocked[i]?'on':''}" onclick="palLocked[${i}]=!palLocked[${i}];this.classList.toggle('on')" style="font-size:10px;padding:3px 10px">${palLocked[i]?'▪':'▫'} ${i+1}</div>`).join('');
  const css=palColors.map((c,i)=>`  --color-${i+1}: ${c};`).join('\n');
  document.getElementById('pal-out').textContent=`:root {\n${css}\n}`;
}
function copyColor(hex){navigator.clipboard.writeText(hex);toast(`Copied ${hex}`)}

// ═══ SHAPE INSERT HELPERS ═══
function insertShapeBlock(w,h,applyFn){
  const page=document.querySelector('.dk-page');
  if(!page)return;
  // Place in center of visible area
  const vp=document.getElementById('lp-viewport');
  const scale=parseFloat(vp?.style.transform?.match(/scale\(([^)]+)\)/)?.[1])||1;
  const bd=page.closest('.wbody');
  const scrollTop=bd?bd.scrollTop/scale:0;
  const visW=getPageW();
  const visH=bd?(bd.clientHeight/scale):600;
  const x=Math.round((visW-w)/2);
  const y=Math.round(scrollTop+(visH-h)/2);
  const el=createBlock(x,y,w,h,'frame');
  if(el){
    selectBlock(el);
    if(applyFn)applyFn(el);
    setMode('select');
    saveState();
  }
}
function insertPattern(){
  if(!window._lastPatternCSS){updatePattern()}
  insertShapeBlock(400,300,el=>{
    el.style.cssText+=';'+window._lastPatternCSS;
  });
}
function insertNoise(){
  insertShapeBlock(400,300,el=>{
    const bg=gv('noise-bg');
    const int=gv('noise-int')/100;
    el.style.background=bg;el.style.overflow='hidden';
    const preview=document.getElementById('noise-preview');
    const svgEl=preview?.querySelector('svg');
    if(svgEl){
      const svgClone=document.createElement('div');svgClone.className='dk-noise-svg';svgClone.style.cssText='position:absolute;width:0;height:0;overflow:hidden';svgClone.innerHTML=svgEl.outerHTML;
      const ov=document.createElement('div');ov.className='dk-noise-overlay';ov.style.cssText=`position:absolute;inset:0;filter:url(#noiseFilter);opacity:${int};pointer-events:none`;
      el.appendChild(svgClone);el.appendChild(ov);
    }
  });
}
function insertMesh(){
  if(!window._lastMeshCSS){updateMesh()}
  insertShapeBlock(400,300,el=>{
    el.style.cssText+=';'+window._lastMeshCSS;
  });
}
function insertBlob(){
  if(!window._lastBlobPoly){genBlob()}
  insertShapeBlock(200,200,el=>{
    el.style.background='transparent';
    el.style.overflow='visible';
    el.dataset.shape='blob';
    const inner=document.createElement('div');
    inner.className='dk-shape-fill';
    inner.style.cssText=`position:absolute;inset:0;clip-path:polygon(${window._lastBlobPoly});background:${window._lastBlobFill||'#a855f7'};pointer-events:none;z-index:0`;
    el.insertBefore(inner,el.firstChild);
  });
}
function insertWave(){
  if(!window._lastWaveSvg){genWave()}
  const h=window._lastWaveH||150;
  insertShapeBlock(800,h,el=>{
    let svg=window._lastWaveSvg;
    // Replace fixed height with 100% so SVG scales with block
    svg=svg.replace(/height="\d+"/g,'height="100%"');
    const wrapper=document.createElement('div');
    wrapper.className='dk-shape-content';
    wrapper.style.cssText='position:absolute;inset:0;pointer-events:none;overflow:hidden';
    wrapper.innerHTML=svg;
    // Also force the SVG element to fill
    const svgEl=wrapper.querySelector('svg');
    if(svgEl){svgEl.setAttribute('width','100%');svgEl.setAttribute('height','100%');svgEl.style.display='block'}
    el.appendChild(wrapper);
    el.style.overflow='hidden';
    el.style.background='transparent';
  });
}
function insertClip(){
  const val=window._lastClipVal;if(!val){updateClip()}
  insertShapeBlock(200,200,el=>{
    el.style.background='transparent';
    el.style.overflow='visible';
    el.dataset.shape='clip';
    el.dataset.clipval=window._lastClipVal;
    const inner=document.createElement('div');
    inner.className='dk-shape-fill';
    inner.style.cssText=`position:absolute;inset:0;clip-path:${window._lastClipVal};background:var(--p,#a855f7);pointer-events:none;z-index:0`;
    el.insertBefore(inner,el.firstChild);
  });
}
function applyPaletteAsTheme(){
  if(!palColors||palColors.length<5)return toast('Generate a palette first');
  const lum=hex=>{const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return 0.299*r+0.587*g+0.114*b};
  const sorted=[...palColors].map((c,i)=>({c,i,l:lum(c)})).sort((a,b)=>a.l-b.l);
  document.getElementById('lp-primary').value=sorted[2].c;
  document.getElementById('lp-secondary').value=sorted[3].c;
  document.getElementById('lp-accent').value=sorted[4].c;
  updateLP();
  updateThemeSwatches();
  toast('Theme colors applied!');
}
function updateThemeSwatches(){
  const colors=[gv('lp-primary'),gv('lp-secondary'),gv('lp-accent'),gv('lp-bgc'),gv('lp-surface'),gv('lp-text')];
  // Add palette colors if available
  if(palColors)palColors.forEach(c=>{if(!colors.includes(c))colors.push(c)});
  // Cap at 9
  const swatches=colors.slice(0,9);
  // Update cm-bg-swatches
  const bgRow=document.getElementById('cm-bg-swatches');
  if(bgRow){
    bgRow.innerHTML=swatches.map(c=>`<div class="tm-swatch" style="background:${c}" onclick="cmSetBg('${c}')"></div>`).join('');
  }
  // Update text color swatches if present
  const txtRow=document.getElementById('tm-color-swatches');
  if(txtRow){
    txtRow.innerHTML=swatches.map(c=>`<div class="tm-swatch" style="background:${c}" onclick="tmSetColor('${c}')"></div>`).join('');
  }
  // Update gradient color defaults
  const gc1=document.getElementById('cm-grad-c1');
  const gc2=document.getElementById('cm-grad-c2');
  if(gc1&&swatches[0])gc1.value=swatches[0];
  if(gc2&&swatches[1])gc2.value=swatches[1];
  // Update border color default
  const bc=document.getElementById('cm-border-c');
  if(bc&&swatches[0])bc.value=swatches[0];
}

// ═══ GRADIENT MAKER ═══
function updateGrad(){
  const type=getChip('grad-type'),c1=gv('grad-c1'),c2=gv('grad-c2'),c3=gv('grad-c3t'),angle=gv('grad-angle');
  document.getElementById('grad-c1t').value=c1;document.getElementById('grad-c2t').value=c2;
  document.getElementById('grad-angle-val').textContent=angle+'°';
  const colors=c3?`${c1}, ${c3}, ${c2}`:`${c1}, ${c2}`;
  let css='';
  if(type==='linear')css=`linear-gradient(${angle}deg, ${colors})`;
  else if(type==='radial')css=`radial-gradient(circle, ${colors})`;
  else css=`conic-gradient(from ${angle}deg, ${colors})`;
  document.getElementById('grad-preview').style.background=css;
  document.getElementById('grad-out').textContent=`background: ${css};`;
}
function randomGrad(){
  document.getElementById('grad-c1').value=randHex();document.getElementById('grad-c2').value=randHex();
  document.getElementById('grad-c3t').value=Math.random()>.5?randHex():'';
  document.getElementById('grad-angle').value=Math.floor(Math.random()*360);
  updateGrad();
}

// ═══ SHADOW GENERATOR ═══
function updateShadow(){
  const x=gv('shad-x'),y=gv('shad-y'),b=gv('shad-blur'),s=gv('shad-spread'),c=gv('shad-color'),op=gv('shad-op')/100;
  document.getElementById('shad-x-val').textContent=x+'px';document.getElementById('shad-y-val').textContent=y+'px';
  document.getElementById('shad-blur-val').textContent=b+'px';document.getElementById('shad-spread-val').textContent=s+'px';
  document.getElementById('shad-op-val').textContent=op.toFixed(2);document.getElementById('shad-color-t').value=c;
  const r=parseInt(c.slice(1,3),16),g=parseInt(c.slice(3,5),16),bl=parseInt(c.slice(5,7),16);
  const shadow=`${x}px ${y}px ${b}px ${s}px rgba(${r},${g},${bl},${op})`;
  const tgt=document.getElementById('shad-target');
  if(tgt)tgt.style.boxShadow=shadow;
  document.getElementById('shad-out').textContent=`box-shadow: ${shadow};`;
  if(selectedEl&&!_initingTab){selectedEl.style.boxShadow=shadow;saveState()}
}
function shadowPreset(p){
  const presets={subtle:[0,2,8,0,'#000000',15],medium:[0,8,24,0,'#000000',25],heavy:[0,20,50,0,'#000000',40],neon:[0,0,30,5,'#a855f7',60],layered:[0,4,6,-1,'#000000',20],inset:[0,4,12,0,'#000000',30]};
  const v=presets[p];if(!v)return;
  document.getElementById('shad-x').value=v[0];document.getElementById('shad-y').value=v[1];document.getElementById('shad-blur').value=v[2];
  document.getElementById('shad-spread').value=v[3];document.getElementById('shad-color').value=v[4];document.getElementById('shad-op').value=v[5];
  updateShadow();
}

// ═══ GLASSMORPHISM ═══
function updateGlass(){
  const blur=gv('glass-blur'),op=gv('glass-op')/100,bdr=gv('glass-bdr')/100,rad=gv('glass-rad'),clr=getChip('glass-clr'),bg=getChip('glass-bg');
  document.getElementById('glass-blur-val').textContent=blur+'px';document.getElementById('glass-op-val').textContent=op.toFixed(2);
  document.getElementById('glass-bdr-val').textContent=bdr.toFixed(2);document.getElementById('glass-rad-val').textContent=rad+'px';
  const base=clr==='white'?'255,255,255':clr==='dark'?'0,0,0':'168,85,247';
  const el=document.getElementById('glass-target');
  if(el){el.style.background=`rgba(${base},${op})`;el.style.backdropFilter=`blur(${blur}px)`;el.style.webkitBackdropFilter=`blur(${blur}px)`;
  el.style.border=`1px solid rgba(${base},${bdr})`;el.style.borderRadius=rad+'px';}
  const wrap=document.getElementById('glass-preview-wrap');
  if(wrap){if(bg==='gradient')wrap.style.background='linear-gradient(135deg,#a855f7,#ec4899,#06b6d4)';
  else if(bg==='image')wrap.style.background='linear-gradient(45deg,#a855f7 0%,#ec4899 25%,#06b6d4 50%,#10b981 75%,#f59e0b 100%)';
  else wrap.style.background='#1a1a26';}
  const out=document.getElementById('glass-out');
  if(out)out.textContent=`background: rgba(${base}, ${op});\nbackdrop-filter: blur(${blur}px);\n-webkit-backdrop-filter: blur(${blur}px);\nborder: 1px solid rgba(${base}, ${bdr});\nborder-radius: ${rad}px;`;
  if(selectedEl&&!_initingTab){
    selectedEl.style.background=`rgba(${base},${op})`;
    selectedEl.style.backdropFilter=`blur(${blur}px)`;
    selectedEl.style.webkitBackdropFilter=`blur(${blur}px)`;
    selectedEl.style.border=`1px solid rgba(${base},${bdr})`;
    selectedEl.style.borderRadius=rad+'px';
    saveState();
  }
}

// ═══ TYPOGRAPHY LAB ═══
function updateType(){
  const hf=gv('type-h-font'),bf=gv('type-b-font'),hs=gv('type-hs'),bs=gv('type-bs'),lh=(gv('type-lh')/10).toFixed(1),wt=getChip('type-wt'),ls=gv('type-ls');
  document.getElementById('type-hs-val').textContent=hs+'px';document.getElementById('type-bs-val').textContent=bs+'px';
  document.getElementById('type-lh-val').textContent=lh;document.getElementById('type-ls-val').textContent=ls+'px';
  // Load fonts
  const link=document.getElementById('type-gfont')||document.createElement('link');
  link.id='type-gfont';link.rel='stylesheet';
  link.href=`https://fonts.googleapis.com/css2?family=${hf.replace(/ /g,'+')}:wght@400;700;900&family=${bf.replace(/ /g,'+')}:wght@400;500;700&display=swap`;
  if(!document.getElementById('type-gfont'))document.head.appendChild(link);
  const h=document.getElementById('type-heading');const b=document.getElementById('type-body');
  h.style.fontFamily=`'${hf}',sans-serif`;h.style.fontSize=hs+'px';h.style.fontWeight=wt;h.style.letterSpacing=ls+'px';h.style.lineHeight='1.2';
  b.style.fontFamily=`'${bf}',sans-serif`;b.style.fontSize=bs+'px';b.style.lineHeight=lh;b.style.color='var(--t2)';
  document.getElementById('type-out').textContent=`/* Heading */\nfont-family: '${hf}', sans-serif;\nfont-size: ${hs}px;\nfont-weight: ${wt};\nletter-spacing: ${ls}px;\n\n/* Body */\nfont-family: '${bf}', sans-serif;\nfont-size: ${bs}px;\nline-height: ${lh};`;
}

// ═══ PATTERN MAKER ═══
function updatePattern(){
  const type=getChip('pat-type'),size=parseInt(gv('pat-size')),color=gv('pat-color'),bg=gv('pat-bg'),op=gv('pat-op')/100;
  st('pat-size-val',size+'px');st('pat-op-val',op.toFixed(2));
  const r=parseInt(color.slice(1,3),16),g=parseInt(color.slice(3,5),16),b=parseInt(color.slice(5,7),16);
  const c=`rgba(${r},${g},${b},${op})`;
  let css='';const s=size;
  if(type==='dots')css=`background-color:${bg};background-image:radial-gradient(${c} 1px,transparent 1px);background-size:${s}px ${s}px`;
  else if(type==='grid')css=`background-color:${bg};background-image:linear-gradient(${c} 1px,transparent 1px),linear-gradient(90deg,${c} 1px,transparent 1px);background-size:${s}px ${s}px`;
  else if(type==='diagonal')css=`background-color:${bg};background-image:repeating-linear-gradient(45deg,${c} 0,${c} 1px,transparent 0,transparent 50%);background-size:${s}px ${s}px`;
  else if(type==='zigzag')css=`background-color:${bg};background-image:linear-gradient(135deg,${c} 25%,transparent 25%),linear-gradient(225deg,${c} 25%,transparent 25%),linear-gradient(315deg,${c} 25%,transparent 25%),linear-gradient(45deg,${c} 25%,transparent 25%);background-size:${s}px ${s}px;background-position:0 0,${s/2}px 0,${s/2}px -${s/2}px,0 ${s/2}px`;
  else if(type==='checkerboard')css=`background-color:${bg};background-image:linear-gradient(45deg,${c} 25%,transparent 25%,transparent 75%,${c} 75%),linear-gradient(45deg,${c} 25%,transparent 25%,transparent 75%,${c} 75%);background-size:${s}px ${s}px;background-position:0 0,${s/2}px ${s/2}px`;
  else if(type==='triangles'){const h2=Math.round(s*0.866);css=`background-color:${bg};background-image:linear-gradient(60deg,${c} 25%,transparent 25%),linear-gradient(-60deg,${c} 25%,transparent 25%),linear-gradient(60deg,transparent 75%,${c} 75%),linear-gradient(-60deg,transparent 75%,${c} 75%);background-size:${s}px ${h2}px;background-position:0 0,0 0,${s/2}px ${h2/2}px,${s/2}px ${h2/2}px`}
  else if(type==='hexagons')css=`background-color:${bg};background-image:radial-gradient(circle farthest-side at 0% 50%,${bg} 23.5%,transparent 0)${s*1.4}px ${s}px,radial-gradient(circle farthest-side at 0% 50%,${c} 24%,transparent 0)${s*1.3}px ${s}px;background-size:${s*2}px ${Math.round(s*3.5)}px`;
  else css=`background-color:${bg};background-image:repeating-linear-gradient(0deg,transparent,transparent ${s/2}px,${c} ${s/2}px,${c} ${s}px);background-size:${s}px ${s}px`;
  document.getElementById('pat-preview').style.cssText=css+';min-height:200px;border-radius:12px;border:1px solid var(--bdr)';
  document.getElementById('pat-out').textContent=css.split(';').join(';\n');
  // Store for insert
  window._lastPatternCSS=css;
}
function applyPattern(){
  const css=window._lastPatternCSS;if(!css)return;
  if(selectedEl){selectedEl.style.cssText+=';'+css;saveState()}
  else{const page=document.querySelector('.dk-page');if(page){page.style.cssText+=';'+css;saveState()}}
}

// ═══ TEXTURE GENERATOR ═══
const _texSeed=[];for(let i=0;i<512;i++)_texSeed[i]=Math.random();
function texNoise(x,y){const n=Math.sin(x*127.1+y*311.7+_texSeed[Math.abs(Math.floor(x*7+y*13))%512]*100)*43758.5453;return n-Math.floor(n)}
function texSmooth(x,y){
  const ix=Math.floor(x),iy=Math.floor(y),fx=x-ix,fy=y-iy;
  const sx=fx*fx*(3-2*fx),sy=fy*fy*(3-2*fy);
  const a=texNoise(ix,iy),b=texNoise(ix+1,iy),c=texNoise(ix,iy+1),d=texNoise(ix+1,iy+1);
  return a+(b-a)*sx+(c-a)*sy+(a-b-c+d)*sx*sy;
}
function texFBM(x,y,octaves){let v=0,amp=0.5,freq=1;for(let i=0;i<octaves;i++){v+=amp*texSmooth(x*freq,y*freq);freq*=2;amp*=0.5}return v}
function texVoronoi(x,y){
  const ix=Math.floor(x),iy=Math.floor(y);let minD=99;
  for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){
    const cx=ix+dx+texNoise(ix+dx,iy+dy)*0.8,cy=iy+dy+texNoise(iy+dy,ix+dx)*0.8;
    const d=Math.sqrt((x-cx)**2+(y-cy)**2);if(d<minD)minD=d;
  }
  return Math.min(1,minD);
}
function hexToRGB(h){return[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)]}
function genTexture(){
  const type=getChip('tex-type');
  const scale=gv('tex-scale')/10;
  const detail=+gv('tex-detail');
  const contrast=gv('tex-contrast')/10;
  const opacity=gv('tex-op')/100;
  const c1=hexToRGB(gv('tex-c1')),c2=hexToRGB(gv('tex-c2')),bg=hexToRGB(gv('tex-bg'));
  st('tex-scale-v',scale.toFixed(1));st('tex-detail-v',detail);
  st('tex-contrast-v',contrast.toFixed(1));st('tex-op-v',opacity.toFixed(2));
  const cvs=document.getElementById('tex-canvas');if(!cvs)return;
  const ctx=cvs.getContext('2d');const W=cvs.width,H=cvs.height;
  const img=ctx.createImageData(W,H);
  // Seed offset for variety
  const sx=_texSeed[0]*1000,sy=_texSeed[1]*1000;
  for(let y=0;y<H;y++){for(let x=0;x<W;x++){
    const nx=(x/W)*scale*4+sx,ny=(y/H)*scale*4+sy;
    let v=0;
    if(type==='marble'){
      const n=texFBM(nx,ny,detail);
      v=Math.sin(nx*2+n*6)*0.5+0.5;
      v=Math.pow(v,contrast);
    }else if(type==='wood'){
      const n=texFBM(nx*0.5,ny*0.5,detail);
      const dist=Math.sqrt((nx-sx)**2*0.1+(ny-sy)**2);
      v=Math.sin(dist*3+n*4)*0.5+0.5;
      v=Math.pow(v,contrast*0.8);
    }else if(type==='stone'){
      v=texFBM(nx,ny,detail);
      v=Math.pow(v,contrast*0.6);
      const crack=texFBM(nx*3,ny*3,2);
      if(crack>0.65)v*=0.3;
    }else if(type==='crack'){
      const v1=texVoronoi(nx,ny);
      v=v1<0.12?0:1;
      v*=texFBM(nx,ny,detail)*0.5+0.5;
      v=1-Math.pow(1-v,contrast);
    }else if(type==='voronoi'){
      v=texVoronoi(nx,ny);
      v=Math.pow(v,contrast*0.7);
    }else if(type==='organic'){
      const a=texFBM(nx,ny,detail);
      const b=texFBM(nx+a*2,ny+a*2,detail);
      v=b;v=Math.pow(v,contrast*0.5);
    }else if(type==='crystal'){
      const v1=texVoronoi(nx*1.5,ny*1.5);
      const v2=texVoronoi(nx*0.7+5,ny*0.7+5);
      v=Math.abs(v1-v2);
      v=Math.pow(v,contrast*0.4);
      const edge=texVoronoi(nx*1.5,ny*1.5);
      if(edge<0.08)v=1;
    }else if(type==='lava'){
      const n=texFBM(nx,ny,detail);
      const warp=texFBM(nx+n*3,ny+n*3,3);
      v=Math.sin(warp*6)*0.5+0.5;
      v=Math.pow(v,contrast*0.5);
    }
    v=Math.max(0,Math.min(1,v));
    const r=bg[0]+(c1[0]-bg[0])*v*opacity+(c2[0]-bg[0])*(1-v)*opacity*0.3;
    const g=bg[1]+(c1[1]-bg[1])*v*opacity+(c2[1]-bg[1])*(1-v)*opacity*0.3;
    const b2=bg[2]+(c1[2]-bg[2])*v*opacity+(c2[2]-bg[2])*(1-v)*opacity*0.3;
    const idx=(y*W+x)*4;
    img.data[idx]=Math.max(0,Math.min(255,r));
    img.data[idx+1]=Math.max(0,Math.min(255,g));
    img.data[idx+2]=Math.max(0,Math.min(255,b2));
    img.data[idx+3]=255;
  }}
  ctx.putImageData(img,0,0);
  window._lastTexDataURL=cvs.toDataURL('image/jpeg',0.85);
  document.getElementById('tex-out').textContent=window._lastTexDataURL.slice(0,120)+'...';
}
function randomizeTexture(){
  for(let i=0;i<512;i++)_texSeed[i]=Math.random();
  // Randomize colors too
  document.getElementById('tex-c1').value=randHex();
  document.getElementById('tex-c2').value=randHex();
  document.getElementById('tex-bg').value=randHex();
  genTexture();
}
function applyTexture(){
  if(!window._lastTexDataURL)genTexture();
  const url=window._lastTexDataURL;
  if(selectedEl){
    const fill=selectedEl.querySelector('.dk-shape-fill');
    const t=fill||selectedEl;
    t.style.backgroundImage=`url(${url})`;t.style.backgroundSize='cover';
    saveState();
  }else{
    const page=document.querySelector('.dk-page');
    if(page){page.style.backgroundImage=`url(${url})`;page.style.backgroundSize='cover';saveState()}
  }
}
function insertTexture(){
  if(!window._lastTexDataURL)genTexture();
  const url=window._lastTexDataURL;
  insertShapeBlock(400,260,el=>{
    el.style.backgroundImage=`url(${url})`;el.style.backgroundSize='cover';
  });
}

// ═══ NOISE & TEXTURE ═══
function updateNoise(){
  const type=getChip('noise-type'),int=gv('noise-int')/100,sc=gv('noise-sc'),bg=gv('noise-bg');
  document.getElementById('noise-int-val').textContent=int.toFixed(2);document.getElementById('noise-sc-val').textContent=sc+'%';
  let freq=type==='grain'?0.7:type==='noise'?0.9:type==='paper'?0.4:0.6;
  freq*=(100/sc);
  const svgId='noiseFilter';
  const svg=`<svg width="0" height="0"><filter id="${svgId}"><feTurbulence type="${type==='fabric'?'turbulence':'fractalNoise'}" baseFrequency="${freq.toFixed(3)}" numOctaves="${type==='paper'?4:2}" stitchTiles="stitch"/></filter></svg>`;
  const preview=document.getElementById('noise-preview');
  preview.innerHTML=svg;
  preview.style.cssText=`background:${bg};min-height:200px;border-radius:12px;border:1px solid var(--bdr);position:relative`;
  const overlay=document.createElement('div');
  overlay.style.cssText=`position:absolute;inset:0;border-radius:12px;filter:url(#${svgId});opacity:${int};pointer-events:none`;
  preview.appendChild(overlay);
  document.getElementById('noise-out').textContent=`/* Add this SVG to your HTML */\n${svg}\n\n/* Apply to element */\n.noise-overlay {\n  position: absolute;\n  inset: 0;\n  filter: url(#${svgId});\n  opacity: ${int};\n  pointer-events: none;\n}`;
}

// ═══ MESH GRADIENT ═══
function updateMesh(){
  const c1=gv('mesh-c1'),c2=gv('mesh-c2'),c3=gv('mesh-c3'),c4=gv('mesh-c4');
  const css=`background-color:${c1};background-image:
  radial-gradient(at 0% 0%, ${c1} 0px, transparent 50%),
  radial-gradient(at 100% 0%, ${c2} 0px, transparent 50%),
  radial-gradient(at 100% 100%, ${c3} 0px, transparent 50%),
  radial-gradient(at 0% 100%, ${c4} 0px, transparent 50%)`;
  document.getElementById('mesh-preview').style.cssText=css+';min-height:260px;border-radius:16px;border:1px solid var(--bdr)';
  document.getElementById('mesh-out').textContent=css.replace(/;/g,';\n');
  window._lastMeshCSS=css;
}
function applyMesh(){
  const css=window._lastMeshCSS;if(!css)return;
  if(selectedEl){selectedEl.style.cssText+=';'+css;saveState()}
  else{const page=document.querySelector('.dk-page');if(page){page.style.cssText+=';'+css;saveState()}}
}
function randomMesh(){document.getElementById('mesh-c1').value=randHex();document.getElementById('mesh-c2').value=randHex();document.getElementById('mesh-c3').value=randHex();document.getElementById('mesh-c4').value=randHex();updateMesh()}

// ═══ CANVAS SIZES ═══
const SIZES=[
{cat:'social',name:'Instagram Post',w:1080,h:1080},{cat:'social',name:'Instagram Story',w:1080,h:1920},{cat:'social',name:'Instagram Reel',w:1080,h:1920},
{cat:'social',name:'Facebook Post',w:1200,h:630},{cat:'social',name:'Facebook Cover',w:820,h:312},{cat:'social',name:'Facebook Story',w:1080,h:1920},
{cat:'social',name:'X / Twitter Post',w:1600,h:900},{cat:'social',name:'X Header',w:1500,h:500},
{cat:'social',name:'LinkedIn Post',w:1200,h:627},{cat:'social',name:'LinkedIn Banner',w:1584,h:396},
{cat:'social',name:'TikTok Video',w:1080,h:1920},{cat:'social',name:'Pinterest Pin',w:1000,h:1500},
{cat:'social',name:'YouTube Thumbnail',w:1280,h:720},{cat:'social',name:'YouTube Banner',w:2560,h:1440},
{cat:'video',name:'1080p Full HD',w:1920,h:1080},{cat:'video',name:'4K UHD',w:3840,h:2160},{cat:'video',name:'720p HD',w:1280,h:720},{cat:'video',name:'Vertical 9:16',w:1080,h:1920},{cat:'video',name:'Square 1:1',w:1080,h:1080},{cat:'video',name:'Cinematic 21:9',w:2560,h:1080},
{cat:'print',name:'A4',w:2480,h:3508},{cat:'print',name:'A3',w:3508,h:4961},{cat:'print',name:'Letter',w:2550,h:3300},{cat:'print',name:'Business Card',w:1050,h:600},{cat:'print',name:'Poster 18×24',w:5400,h:7200},
{cat:'web',name:'Desktop HD',w:1920,h:1080},{cat:'web',name:'Laptop',w:1366,h:768},{cat:'web',name:'Tablet',w:768,h:1024},{cat:'web',name:'Mobile',w:375,h:812},{cat:'web',name:'Favicon',w:512,h:512},{cat:'web',name:'OG Image',w:1200,h:630},{cat:'web',name:'App Icon',w:1024,h:1024},
];
function renderSizes(){
  const f=getChip('size-filter');
  const items=f==='all'?SIZES:SIZES.filter(s=>s.cat===f);
  document.getElementById('sizes-grid').innerHTML=items.map(s=>{
    const ratio=s.w/s.h;const pw=ratio>=1?100:ratio*100;const ph=ratio<=1?100:(1/ratio)*100;
    const catColor=s.cat==='social'?'var(--pink)':s.cat==='video'?'var(--cyan)':s.cat==='print'?'var(--orange)':'var(--green)';
    return`<div style="background:var(--bg2);border:1px solid var(--bdr);border-radius:10px;padding:16px;cursor:pointer;transition:all .12s" onclick="navigator.clipboard.writeText('${s.w} × ${s.h}');toast('Copied ${s.w}×${s.h}')" onmouseover="this.style.borderColor='var(--acc)'" onmouseout="this.style.borderColor='var(--bdr)'">
      <div style="display:flex;align-items:center;justify-content:center;height:60px;margin-bottom:12px">
        <div style="width:${pw*.5}px;height:${ph*.5}px;max-width:80px;max-height:55px;border:2px solid ${catColor};border-radius:3px;opacity:.6"></div>
      </div>
      <div style="font-weight:600;font-size:13px;margin-bottom:2px">${s.name}</div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--t3)">${s.w} × ${s.h}</div>
      <div style="font-size:9px;color:${catColor};font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-top:4px;font-family:var(--mono)">${s.cat}</div>
    </div>`;
  }).join('');
}
document.querySelectorAll('#size-filter .chip').forEach(c=>{c.addEventListener('click',()=>setTimeout(renderSizes,50))});


// ═══ CONTRAST CHECKER ═══
function hexToRgb(h){h=h.replace('#','');return{r:parseInt(h.substring(0,2),16),g:parseInt(h.substring(2,4),16),b:parseInt(h.substring(4,6),16)}}
function luminance(r,g,b){const a=[r,g,b].map(v=>{v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4)});return a[0]*0.2126+a[1]*0.7152+a[2]*0.0722}
function contrastRatio(c1,c2){const l1=luminance(c1.r,c1.g,c1.b),l2=luminance(c2.r,c2.g,c2.b);const lighter=Math.max(l1,l2),darker=Math.min(l1,l2);return(lighter+0.05)/(darker+0.05)}
function updateContrast(){
  const fg=gv('con-fg'),bg=gv('con-bg');document.getElementById('con-fg-t').value=fg;document.getElementById('con-bg-t').value=bg;
  const p=document.getElementById('con-preview');p.style.background=bg;p.style.color=fg;
  document.getElementById('con-large').style.color=fg;document.getElementById('con-normal').style.color=fg;document.getElementById('con-small').style.color=fg;
  const ratio=contrastRatio(hexToRgb(fg),hexToRgb(bg));
  const r=ratio.toFixed(2);
  const aaLg=ratio>=3?'✓ Pass':'✗ Fail',aaNorm=ratio>=4.5?'✓ Pass':'✗ Fail',aaaLg=ratio>=4.5?'✓ Pass':'✗ Fail',aaaNorm=ratio>=7?'✓ Pass':'✗ Fail';
  document.getElementById('con-results').innerHTML=`
    <div class="score-card"><h4>Contrast Ratio</h4><div class="val" style="color:${ratio>=4.5?'var(--green)':ratio>=3?'var(--orange)':'var(--red)'}">${r}:1</div></div>
    <div class="score-card"><h4>AA Normal (4.5:1)</h4><div class="val" style="font-size:16px">${aaNorm}</div></div>
    <div class="score-card"><h4>AA Large (3:1)</h4><div class="val" style="font-size:16px">${aaLg}</div></div>
    <div class="score-card"><h4>AAA Normal (7:1)</h4><div class="val" style="font-size:16px">${aaaNorm}</div></div>`;
}

// ═══ COLOR CONVERTER ═══
function convertColor(hex){
  hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');if(hex.length!==6)return;
  hex='#'+hex;document.getElementById('cc-picker').value=hex;document.getElementById('cc-hex').value=hex;
  document.getElementById('cc-preview').style.background=hex;
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  const max=Math.max(r,g,b)/255,min=Math.min(r,g,b)/255,d=max-min;
  let h=0;if(d){if(max===r/255)h=((g/255-b/255)/d)%6;else if(max===g/255)h=(b/255-r/255)/d+2;else h=(r/255-g/255)/d+4;h=Math.round(h*60);if(h<0)h+=360}
  const l=Math.round((max+min)/2*100);const s=d===0?0:Math.round(d/(1-Math.abs(2*(max+min)/2-1))*100);
  const mk=(lbl,val)=>`<div class="score-card" onclick="navigator.clipboard.writeText('${val}');toast('Copied')" style="cursor:pointer"><h4>${lbl}</h4><div class="val" style="font-size:14px;color:var(--t2)">${val}</div></div>`;
  document.getElementById('cc-results').innerHTML=mk('HEX',hex.toUpperCase())+mk('RGB',`rgb(${r}, ${g}, ${b})`)+mk('HSL',`hsl(${h}, ${s}%, ${l}%)`)+mk('RGBA',`rgba(${r}, ${g}, ${b}, 1)`);
}

// ═══ BORDER RADIUS ═══
function updateRadius(){
  const tl=gv('rad-tl'),tr=gv('rad-tr'),br=gv('rad-br'),bl=gv('rad-bl');
  ['tl','tr','br','bl'].forEach(k=>document.getElementById(`rad-${k}-val`).textContent=document.getElementById(`rad-${k}`).value+'px');
  const val=`${tl}px ${tr}px ${br}px ${bl}px`;
  const css=`border-radius: ${val};`;
  const tgt=document.getElementById('rad-target');
  if(tgt)tgt.style.borderRadius=val;
  const out=document.getElementById('rad-out');
  if(out)out.textContent=css;
  if(selectedEl&&!_initingTab){selectedEl.style.borderRadius=val;saveState()}
}
function setRadius(tl,tr,br,bl){document.getElementById('rad-tl').value=tl;document.getElementById('rad-tr').value=tr;document.getElementById('rad-br').value=br;document.getElementById('rad-bl').value=bl;updateRadius()}

// ═══ CSS FILTERS ═══
function updateFilters(){
  const b=gv('f-blur'),br=gv('f-bright'),c=gv('f-contrast'),s=gv('f-sat'),h=gv('f-hue'),g=gv('f-gray'),se=gv('f-sepia'),inv=gv('f-inv');
  document.getElementById('f-blur-v').textContent=b+'px';document.getElementById('f-bright-v').textContent=br+'%';
  document.getElementById('f-contrast-v').textContent=c+'%';document.getElementById('f-sat-v').textContent=s+'%';
  document.getElementById('f-hue-v').textContent=h+'°';document.getElementById('f-gray-v').textContent=g+'%';
  document.getElementById('f-sepia-v').textContent=se+'%';document.getElementById('f-inv-v').textContent=inv+'%';
  let parts=[];
  if(b!=='0')parts.push(`blur(${b}px)`);if(br!=='100')parts.push(`brightness(${br}%)`);
  if(c!=='100')parts.push(`contrast(${c}%)`);if(s!=='100')parts.push(`saturate(${s}%)`);
  if(h!=='0')parts.push(`hue-rotate(${h}deg)`);if(g!=='0')parts.push(`grayscale(${g}%)`);
  if(se!=='0')parts.push(`sepia(${se}%)`);if(inv!=='0')parts.push(`invert(${inv}%)`);
  const css=parts.length?parts.join(' '):'none';
  const tgt=document.getElementById('filter-target');
  if(tgt)tgt.style.filter=css;
  const out=document.getElementById('filter-out');
  if(out)out.textContent=`filter: ${css};`;
  if(selectedEl&&!_initingTab){selectedEl.style.filter=css;saveState()}
}

// ═══ TEXT GRADIENT ═══
function updateTextGrad(){
  const text=document.getElementById('tg-text').value||'Gradient Text',c1=gv('tg-c1'),c2=gv('tg-c2'),c3=gv('tg-c3'),useC3=document.getElementById('tg-c3on').checked;
  const angle=gv('tg-angle'),size=gv('tg-size');
  document.getElementById('tg-angle-val').textContent=angle+'°';document.getElementById('tg-size-val').textContent=size+'px';
  const colors=useC3?`${c1}, ${c3}, ${c2}`:`${c1}, ${c2}`;
  const grad=`linear-gradient(${angle}deg, ${colors})`;
  const el=document.getElementById('tg-preview');
  el.textContent=text;el.style.fontSize=size+'px';el.style.background=grad;el.style.webkitBackgroundClip='text';el.style.webkitTextFillColor='transparent';el.style.backgroundClip='text';
  document.getElementById('tg-out').textContent=`background: ${grad};\n-webkit-background-clip: text;\n-webkit-text-fill-color: transparent;\nbackground-clip: text;`;
}

// ═══ ICON GALLERY ═══
const ICONS={home:'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0v-6a1 1 0 011-1h2a1 1 0 011 1v6m-6 0h6',search:'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z',user:'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z',heart:'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z',star:'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z',settings:'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z',mail:'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',check:'M5 13l4 4L19 7',close:'M6 18L18 6M6 6l12 12',plus:'M12 4v16m8-8H4',minus:'M20 12H4',edit:'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z',trash:'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16',download:'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4',upload:'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12',link:'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1',code:'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4',eye:'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z',lock:'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z',bell:'M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9',camera:'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z M15 13a3 3 0 11-6 0 3 3 0 016 0z',cart:'M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z',menu:'M4 6h16M4 12h16M4 18h16',arrowR:'M14 5l7 7m0 0l-7 7m7-7H3',arrowL:'M10 19l-7-7m0 0l7-7m-7 7h18',refresh:'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15',globe:'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9'};
function renderIcons(){
  const q=(document.getElementById('icon-search')?.value||'').toLowerCase(),sz=gv('icon-sz'),sw=gv('icon-sw');
  const szEl=document.getElementById('icon-sz-val'),swEl=document.getElementById('icon-sw-val');
  if(szEl)szEl.textContent=sz+'px';if(swEl)swEl.textContent=sw;
  const grid=document.getElementById('icon-grid');
  if(!grid)return;
  grid.innerHTML='';
  const entries=Object.entries(ICONS).filter(([k])=>!q||k.includes(q));
  entries.forEach(([name,path])=>{
    const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${sz}" height="${sz}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${sw}" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg>`;
    const card=document.createElement('div');
    card.style.cssText='background:var(--s2);border:1px solid var(--border);border-radius:6px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .12s;display:flex;flex-direction:column;align-items:center;gap:4px';
    card.innerHTML=svg+`<span style="font-size:8px;color:var(--dim);font-family:var(--mono)">${name}</span>`;
    card.addEventListener('click',()=>{navigator.clipboard.writeText(svg);toast('Copied '+name)});
    card.addEventListener('mouseover',()=>card.style.borderColor='var(--acc)');
    card.addEventListener('mouseout',()=>card.style.borderColor='var(--border)');
    grid.appendChild(card);
  });
}

// ═══ BLOB MAKER ═══
function genBlob(){
  const comp=parseInt(gv('blob-comp')),rand=gv('blob-rand')/100,fill=gv('blob-fill');
  document.getElementById('blob-comp-val').textContent=comp;document.getElementById('blob-rand-val').textContent=Math.round(rand*100)+'%';
  const cx=100,cy=100,R=70;let pts=[];
  for(let i=0;i<comp;i++){const a=(Math.PI*2/comp)*i;const r=R*(1-rand+Math.random()*rand*2);pts.push([cx+Math.cos(a)*r,cy+Math.sin(a)*r])}
  let d=`M ${pts[0][0]} ${pts[0][1]}`;
  // Build SVG path and sample smooth points for clip-path
  let smoothPts=[];
  const stepsPerSeg=8;
  for(let i=0;i<pts.length;i++){
    const p0=i===0?[(pts[pts.length-1][0]+pts[0][0])/2,(pts[pts.length-1][1]+pts[0][1])/2]:[(pts[i-1][0]+pts[i][0])/2,(pts[i-1][1]+pts[i][1])/2];
    const cp=pts[i];
    const n=pts[(i+1)%pts.length];
    const p1=[(cp[0]+n[0])/2,(cp[1]+n[1])/2];
    d+=` Q ${cp[0]} ${cp[1]}, ${p1[0]} ${p1[1]}`;
    // Sample quadratic bezier: B(t) = (1-t)²·p0 + 2(1-t)t·cp + t²·p1
    for(let s=0;s<stepsPerSeg;s++){
      const t=s/stepsPerSeg;
      const x=(1-t)*(1-t)*p0[0]+2*(1-t)*t*cp[0]+t*t*p1[0];
      const y=(1-t)*(1-t)*p0[1]+2*(1-t)*t*cp[1]+t*t*p1[1];
      smoothPts.push([x,y]);
    }
  }
  d+=' Z';
  window._lastBlobPoly=smoothPts.map(p=>`${(p[0]/200*100).toFixed(2)}% ${(p[1]/200*100).toFixed(2)}%`).join(', ');
  window._lastBlobFill=fill;
  document.getElementById('blob-svg').innerHTML=`<path d="${d}" fill="${fill}"/>`;
  document.getElementById('blob-out').textContent=`clip-path: polygon(${window._lastBlobPoly});\nbackground: ${fill};`;
}

// ═══ WAVE DIVIDER ═══
function waveFunc(t,type){
  const p=t*Math.PI*2;
  if(type==='sine')return Math.sin(p);
  if(type==='triangle')return 2*Math.abs(2*(t%1)-1)-1;
  if(type==='square')return Math.sin(p)>=0?1:-1;
  if(type==='sawtooth')return 2*(t%1)-1;
  return Math.sin(p);
}
function genWave(){
  const freq=gv('wave-freq')/10;
  const amp=parseInt(gv('wave-amp'));
  const phase=parseInt(gv('wave-phase'))/360;
  const yPct=parseInt(gv('wave-yoff'))/100;
  const h=parseInt(gv('wave-h'));
  const n=parseInt(gv('wave-n'));
  const color=gv('wave-color');
  const type=gv('wave-style');
  const flipMode=gv('wave-flip');
  st('wave-freq-val',freq.toFixed(1));st('wave-amp-val',amp+'px');
  st('wave-phase-val',Math.round(phase*360)+'\u00B0');st('wave-yoff-val',Math.round(yPct*100)+'%');
  st('wave-h-val',h+'px');st('wave-n-val',n);
  const w=100;
  const vH=100;
  const samples=200;
  let allPaths='';
  for(let layer=0;layer<n;layer++){
    const opacity=Math.max(0.15,1-layer*0.25).toFixed(2);
    const layerPhase=phase+layer*0.4;
    const layerAmpN=(amp/h)*(1-layer*0.15)*100;
    const layerYN=yPct*100+layer*(800/h);
    let pathD='M0 '+vH;
    for(let i=0;i<=samples;i++){
      const t=i/samples;
      const x=(w/samples)*i;
      const val=waveFunc(t*freq+layerPhase,type);
      const y=layerYN+val*layerAmpN;
      pathD+=' L'+x.toFixed(2)+' '+y.toFixed(2);
    }
    pathD+=' L'+w+' '+vH+' Z';
    allPaths+='<path d="'+pathD+'" fill="'+color+'" opacity="'+opacity+'"/>';
  }
  let gOpen='',gClose='';
  if(flipMode==='flipY')gOpen='<g transform="translate(0,100) scale(1,-1)">';
  else if(flipMode==='flipX')gOpen='<g transform="translate(100,0) scale(-1,1)">';
  else if(flipMode==='flipXY')gOpen='<g transform="translate(100,100) scale(-1,-1)">';
  else if(flipMode==='rot90')gOpen='<g transform="translate(100,0) rotate(90)">';
  else if(flipMode==='rot270')gOpen='<g transform="translate(0,100) rotate(270)">';
  if(gOpen)gClose='</g>';
  const svg='<svg viewBox="0 0 100 100" width="100%" height="'+h+'" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" style="display:block">'+gOpen+allPaths+gClose+'</svg>';
  window._lastWaveSvg=svg;
  window._lastWaveH=h;
  document.getElementById('wave-preview').innerHTML=svg;
  document.getElementById('wave-out').textContent=svg;
}
function randomizeWave(){
  document.getElementById('wave-freq').value=10+Math.floor(Math.random()*60);
  document.getElementById('wave-amp').value=15+Math.floor(Math.random()*60);
  document.getElementById('wave-phase').value=Math.floor(Math.random()*360);
  document.getElementById('wave-yoff').value=30+Math.floor(Math.random()*40);
  document.getElementById('wave-h').value=80+Math.floor(Math.random()*180);
  document.getElementById('wave-n').value=1+Math.floor(Math.random()*3);
  document.getElementById('wave-color').value=randHex();
  document.getElementById('wave-style').value=['sine','triangle','square','sawtooth'][Math.floor(Math.random()*4)];
  document.getElementById('wave-flip').value=['no','flipY','flipX','flipXY'][Math.floor(Math.random()*4)];
  genWave();
}
// ═══ GRID BUILDER ═══
function updateGrid(){
  const cols=gv('grid-cols'),rows=gv('grid-rows'),gap=gv('grid-gap'),colSize=gv('grid-col-size'),rowSize=gv('grid-row-size');
  document.getElementById('grid-cols-val').textContent=cols;document.getElementById('grid-rows-val').textContent=rows;document.getElementById('grid-gap-val').textContent=gap+'px';
  const total=cols*rows;const p=document.getElementById('grid-preview');
  const gtc=`repeat(${cols}, ${colSize})`,gtr=`repeat(${rows}, ${rowSize})`;
  p.style.display='grid';p.style.gridTemplateColumns=gtc;p.style.gridTemplateRows=gtr;p.style.gap=gap+'px';
  const colors=['var(--acc)','var(--pink)','var(--cyan)','var(--green)','var(--orange)','#8b5cf6','#f43f5e','#14b8a6'];
  p.innerHTML=Array.from({length:total},(_, i)=>`<div style="background:${colors[i%colors.length]}22;border:1px solid ${colors[i%colors.length]}44;border-radius:8px;padding:16px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:11px;color:var(--t3);min-height:60px">${i+1}</div>`).join('');
  document.getElementById('grid-out').textContent=`display: grid;\ngrid-template-columns: ${gtc};\ngrid-template-rows: ${gtr};\ngap: ${gap}px;`;
}

// ═══ ASPECT RATIO ═══
function gcd(a,b){return b?gcd(b,a%b):a}
function calcRatio(){const w=parseInt(gv('ar-w'))||1,h=parseInt(gv('ar-h'))||1;const d=gcd(w,h);document.getElementById('ar-ratio').value=`${w/d}:${h/d}`}
function resizeRatio(dir){const w=parseInt(gv('ar-w'))||1,h=parseInt(gv('ar-h'))||1;
  if(dir==='w'){const nw=parseInt(gv('ar-nw'));if(nw)document.getElementById('ar-nh').value=Math.round(nw*h/w)}
  else{const nh=parseInt(gv('ar-nh'));if(nh)document.getElementById('ar-nw').value=Math.round(nh*w/h)}}
function setRatio(rw,rh){document.getElementById('ar-w').value=rw*100;document.getElementById('ar-h').value=rh*100;calcRatio()}

// ═══ UNIT CONVERTER ═══
function convertUnits(){
  const base=parseInt(gv('unit-base')),vw=parseInt(gv('unit-vw'))||1920,val=parseFloat(gv('unit-val'))||0,from=gv('unit-from');
  document.getElementById('unit-base-val').textContent=base+'px';
  let px=val;
  if(from==='rem'||from==='em')px=val*base;else if(from==='pt')px=val*1.333;else if(from==='vw')px=val*vw/100;
  const mk=(l,v)=>`<div class="score-card" onclick="navigator.clipboard.writeText('${v}');toast('Copied')" style="cursor:pointer"><h4>${l}</h4><div class="val" style="font-size:16px;color:var(--t2)">${v}</div></div>`;
  document.getElementById('unit-results').innerHTML=mk('PX',px.toFixed(2)+'px')+mk('REM',(px/base).toFixed(4)+'rem')+mk('EM',(px/base).toFixed(4)+'em')+mk('PT',(px/1.333).toFixed(2)+'pt')+mk('VW',(px/vw*100).toFixed(4)+'vw')+mk('%',(px/base*100).toFixed(2)+'%');
}

// ═══ PLACEHOLDER ═══
function updatePlaceholder(){
  const w=parseInt(gv('ph-w'))||600,h=parseInt(gv('ph-h'))||400,text=gv('ph-text')||`${w}×${h}`,bg=gv('ph-bg'),fg=gv('ph-fg'),fs=parseInt(gv('ph-fs'));
  document.getElementById('ph-fs-val').textContent=fs+'px';
  const canvas=document.getElementById('ph-canvas');canvas.width=w;canvas.height=h;const ctx=canvas.getContext('2d');
  ctx.fillStyle=bg;ctx.fillRect(0,0,w,h);ctx.fillStyle=fg;ctx.font=`${fs}px 'DM Sans',sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,w/2,h/2);
}
function downloadPlaceholder(){const a=document.createElement('a');a.download=`placeholder-${gv('ph-w')}x${gv('ph-h')}.png`;a.href=document.getElementById('ph-canvas').toDataURL();a.click()}


// ═══ NEUMORPHISM ═══
function updateNeu(){
  const bg=gv('neu-bg'),intensity=gv('neu-int'),blur=gv('neu-blur'),dist=gv('neu-dist'),shape=getChip('neu-shape'),rad=gv('neu-rad');
  document.getElementById('neu-int-val').textContent=intensity;document.getElementById('neu-blur-val').textContent=blur+'px';
  document.getElementById('neu-dist-val').textContent=dist+'px';document.getElementById('neu-rad-val').textContent=rad+'px';
  const r=parseInt(bg.slice(1,3),16),g=parseInt(bg.slice(3,5),16),b=parseInt(bg.slice(5,7),16);
  const f=intensity/100;
  const light=`rgba(${Math.min(255,r+Math.round(f*255))},${Math.min(255,g+Math.round(f*255))},${Math.min(255,b+Math.round(f*255))},0.5)`;
  const dark=`rgba(${Math.max(0,r-Math.round(f*200))},${Math.max(0,g-Math.round(f*200))},${Math.max(0,b-Math.round(f*200))},0.7)`;
  const d=parseInt(dist);const bl=parseInt(blur);
  let shadow,gradient='none';
  if(shape==='inset'){shadow=`inset ${d}px ${d}px ${bl}px ${dark}, inset -${d}px -${d}px ${bl}px ${light}`}
  else{shadow=`${d}px ${d}px ${bl}px ${dark}, -${d}px -${d}px ${bl}px ${light}`}
  if(shape==='concave')gradient=`linear-gradient(145deg, rgba(0,0,0,0.1), rgba(255,255,255,0.05))`;
  if(shape==='convex')gradient=`linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.1))`;
  const el=document.getElementById('neu-target');
  if(el){el.style.background=gradient!=='none'?gradient:bg;el.style.backgroundColor=bg;el.style.boxShadow=shadow;el.style.borderRadius=rad+'px';}
  const wrap=document.getElementById('neu-wrap');
  if(wrap)wrap.style.background=bg;
  const out=document.getElementById('neu-out');
  if(out)out.textContent=`background: ${bg};\nborder-radius: ${rad}px;\nbox-shadow: ${shadow};${gradient!=='none'?'\nbackground-image: '+gradient+';':''}`;
  if(selectedEl&&!_initingTab){
    selectedEl.style.background=gradient!=='none'?gradient:bg;
    selectedEl.style.backgroundColor=bg;
    selectedEl.style.boxShadow=shadow;
    selectedEl.style.borderRadius=rad+'px';
    saveState();
  }
}

// ═══ ANIMATION BUILDER ═══
const ANIMS={
fadeIn:{from:'opacity:0',to:'opacity:1'},fadeOut:{from:'opacity:1',to:'opacity:0'},
slideUp:{from:'opacity:0;transform:translateY(30px)',to:'opacity:1;transform:translateY(0)'},slideDown:{from:'opacity:0;transform:translateY(-30px)',to:'opacity:1;transform:translateY(0)'},
slideLeft:{from:'opacity:0;transform:translateX(30px)',to:'opacity:1;transform:translateX(0)'},slideRight:{from:'opacity:0;transform:translateX(-30px)',to:'opacity:1;transform:translateX(0)'},
scaleIn:{from:'opacity:0;transform:scale(0.5)',to:'opacity:1;transform:scale(1)'},scaleOut:{from:'transform:scale(1)',to:'opacity:0;transform:scale(0.5)'},
rotate:{from:'transform:rotate(0deg)',to:'transform:rotate(360deg)'},
bounce:{frames:{'0%,20%,50%,80%,100%':'transform:translateY(0)','40%':'transform:translateY(-20px)','60%':'transform:translateY(-10px)'}},
pulse:{frames:{'0%':'transform:scale(1)','50%':'transform:scale(1.08)','100%':'transform:scale(1)'}},
shake:{frames:{'0%,100%':'transform:translateX(0)','10%,30%,50%,70%,90%':'transform:translateX(-5px)','20%,40%,60%,80%':'transform:translateX(5px)'}},
flip:{frames:{'0%':'transform:perspective(400px) rotateY(0)','100%':'transform:perspective(400px) rotateY(360deg)'}},
swing:{frames:{'20%':'transform:rotate(10deg)','40%':'transform:rotate(-8deg)','60%':'transform:rotate(4deg)','80%':'transform:rotate(-4deg)','100%':'transform:rotate(0)'}},
rubberBand:{frames:{'0%':'transform:scale(1)','30%':'transform:scaleX(1.25) scaleY(0.75)','40%':'transform:scaleX(0.75) scaleY(1.25)','50%':'transform:scaleX(1.15) scaleY(0.85)','65%':'transform:scaleX(0.95) scaleY(1.05)','75%':'transform:scaleX(1.05) scaleY(0.95)','100%':'transform:scale(1)'}},
jello:{frames:{'0%,100%':'transform:none','11.1%':'transform:skewX(-3deg) skewY(-3deg)','22.2%':'transform:skewX(2deg) skewY(2deg)','33.3%':'transform:skewX(-1deg) skewY(-1deg)','44.4%':'transform:skewX(0.5deg) skewY(0.5deg)','55.5%':'transform:none'}},
heartbeat:{frames:{'0%':'transform:scale(1)','14%':'transform:scale(1.2)','28%':'transform:scale(1)','42%':'transform:scale(1.2)','70%':'transform:scale(1)'}},
flash:{frames:{'0%,50%,100%':'opacity:1','25%,75%':'opacity:0'}},
float:{frames:{'0%,100%':'transform:translateY(0)','50%':'transform:translateY(-10px)'}},
};
// ═══ ANIMATE: BLOCK ANIMATION ═══
let _abPreset='fadeIn',_abDur=0.6,_abDelay=0,_abIter='1',_abEase='ease',_abTrigger='load';

function abApply(preset){
  if(!selectedEl)return toast('Select a block first');
  _abPreset=preset;
  abUpdate();
}
function abUpdate(){
  _abDur=(gv('ab-dur')/10)||0.6;
  _abDelay=(gv('ab-delay')/10)||0;
  st('ab-dur-v',_abDur.toFixed(1)+'s');
  st('ab-delay-v',_abDelay.toFixed(1)+'s');
  if(!selectedEl)return;
  const a=ANIMS[_abPreset];if(!a)return;
  // Inject keyframes
  let ss=document.getElementById('dk-anim-style');
  if(!ss){ss=document.createElement('style');ss.id='dk-anim-style';document.head.appendChild(ss)}
  let kf='';
  if(a.frames){const entries=Object.entries(a.frames);kf=`@keyframes dk_${_abPreset}{${entries.map(([k,v])=>`${k}{${v}}`).join('')}}`}
  else{kf=`@keyframes dk_${_abPreset}{from{${a.from}}to{${a.to}}}`}
  if(!ss.textContent.includes(`dk_${_abPreset}`))ss.textContent+=kf;
  const animVal=`dk_${_abPreset} ${_abDur}s ${_abEase} ${_abDelay}s ${_abIter} both`;
  // Store config
  selectedEl.dataset.anim=_abPreset;
  selectedEl.dataset.animVal=animVal;
  selectedEl.dataset.animTrigger=_abTrigger;
  // Apply based on trigger
  _abClearListeners(selectedEl);
  if(_abTrigger==='load'){
    selectedEl.style.animation=animVal;
  }else if(_abTrigger==='hover'){
    selectedEl.style.animation='none';
    _abBindHover(selectedEl);
  }else if(_abTrigger==='click'){
    selectedEl.style.animation='none';
    _abBindClick(selectedEl);
  }else if(_abTrigger==='view'){
    selectedEl.style.animation='none';
    selectedEl.style.opacity='0';
    _abBindView(selectedEl);
  }else if(_abTrigger==='hover-loop'){
    selectedEl.style.animation='none';
    _abBindHoverLoop(selectedEl);
  }else if(_abTrigger==='scroll'){
    selectedEl.style.animation='none';
    _abBindScroll(selectedEl);
  }else if(_abTrigger==='dblclick'){
    selectedEl.style.animation='none';
    _abBindDblClick(selectedEl);
  }else if(_abTrigger==='view-loop'){
    selectedEl.style.animation='none';
    selectedEl.style.opacity='0';
    _abBindViewLoop(selectedEl);
  }
  saveState();
}
function abTrigger(v){
  _abTrigger=v;
  document.querySelectorAll('.ab-trig').forEach(b=>b.classList.remove('active'));
  const btn=document.querySelector(`.ab-trig[data-v="${v}"]`);
  if(btn)btn.classList.add('active');
  if(selectedEl&&selectedEl.dataset.anim)abUpdate();
}
function _abClearListeners(el){
  if(el._abHover){el.removeEventListener('mouseenter',el._abHover);delete el._abHover}
  if(el._abHoverOut){el.removeEventListener('mouseleave',el._abHoverOut);delete el._abHoverOut}
  if(el._abClick){
    el.removeEventListener('click',el._abClick);
    el.removeEventListener('dblclick',el._abClick);
    delete el._abClick;
  }
  if(el._abObs){el._abObs.disconnect();delete el._abObs}
  if(el._abScroll){const bd=el.closest('.wbody');if(bd)bd.removeEventListener('scroll',el._abScroll);delete el._abScroll}
  el.style.opacity='';
  el.style.animationPlayState='';
  el.style.animationDelay='';
}
function _abBindHover(el){
  el._abHover=()=>{el.style.animation='none';el.offsetHeight;el.style.animation=el.dataset.animVal};
  el._abHoverOut=()=>{el.style.animation='none'};
  el.addEventListener('mouseenter',el._abHover);
  el.addEventListener('mouseleave',el._abHoverOut);
}
function _abBindHoverLoop(el){
  // Animation plays on hover and loops while hovering, stops on leave
  el._abHover=()=>{
    const origIter=_abIter;
    const val=el.dataset.animVal.replace(/\d+\s+both/,'infinite both');
    el.style.animation='none';el.offsetHeight;el.style.animation=val;
  };
  el._abHoverOut=()=>{el.style.animation='none'};
  el.addEventListener('mouseenter',el._abHover);
  el.addEventListener('mouseleave',el._abHoverOut);
}
function _abBindClick(el){
  el._abClick=(e)=>{
    if(el.classList.contains('selected'))return; // Don't trigger in edit mode
    el.style.animation='none';el.offsetHeight;el.style.animation=el.dataset.animVal;
  };
  el.addEventListener('click',el._abClick);
}
function _abBindView(el){
  // Use offset math to avoid transform:scale() coordinate issues
  const sizer=document.getElementById('lp-sizer');
  const bd=el.closest('.wbody');
  if(!bd||!sizer)return;
  let fired=false;
  const check=()=>{
    if(fired)return;
    const vp=document.getElementById('lp-viewport');
    const pageW=parseInt(vp?.style.width)||1280;
    const scale=Math.min(1,bd.clientWidth/pageW);
    // Block position in scaled space
    const blockTop=el.offsetTop*scale;
    const blockBot=(el.offsetTop+el.offsetHeight)*scale;
    const scrollTop=bd.scrollTop;
    const viewBot=scrollTop+bd.clientHeight;
    // Trigger when block enters visible scroll area
    if(blockBot>scrollTop+40&&blockTop<viewBot-40){
      fired=true;
      el.style.opacity='';
      el.style.animation=el.dataset.animVal;
      bd.removeEventListener('scroll',check);
    }
  };
  bd.addEventListener('scroll',check);
  el._abScroll=check;
  setTimeout(check,300);
}
function _abBindScroll(el){
  const bd=el.closest('.wbody');
  if(!bd)return;
  const handler=()=>{
    const vp=document.getElementById('lp-viewport');
    const pageW=parseInt(vp?.style.width)||1280;
    const scale=Math.min(1,bd.clientWidth/pageW);
    const blockTop=el.offsetTop*scale;
    const scrollTop=bd.scrollTop;
    const viewH=bd.clientHeight;
    // Progress: 0 when block enters bottom, 1 when it passes top
    const progress=(scrollTop+viewH-blockTop)/viewH;
    const clamped=Math.max(0,Math.min(1,progress));
    el.style.animation=el.dataset.animVal;
    el.style.animationPlayState='paused';
    el.style.animationDelay=`-${clamped*_abDur}s`;
  };
  bd.addEventListener('scroll',handler);
  el._abScroll=handler;
  handler();
}
function _abBindDblClick(el){
  el._abClick=(e)=>{
    el.style.animation='none';el.offsetHeight;el.style.animation=el.dataset.animVal;
  };
  el.addEventListener('dblclick',el._abClick);
}
function _abBindViewLoop(el){
  // Animate every time it scrolls into view, reset when out
  const bd=el.closest('.wbody');
  if(!bd)return;
  let inView=false;
  const check=()=>{
    const vp=document.getElementById('lp-viewport');
    const pageW=parseInt(vp?.style.width)||1280;
    const scale=Math.min(1,bd.clientWidth/pageW);
    const blockTop=el.offsetTop*scale;
    const blockBot=(el.offsetTop+el.offsetHeight)*scale;
    const scrollTop=bd.scrollTop;
    const viewBot=scrollTop+bd.clientHeight;
    const visible=blockBot>scrollTop+40&&blockTop<viewBot-40;
    if(visible&&!inView){
      inView=true;
      el.style.opacity='';
      el.style.animation='none';el.offsetHeight;
      el.style.animation=el.dataset.animVal;
    }else if(!visible&&inView){
      inView=false;
      el.style.animation='none';
      el.style.opacity='0';
    }
  };
  bd.addEventListener('scroll',check);
  el._abScroll=check;
  setTimeout(check,300);
}
function abIter(v){_abIter=v;abUpdate()}
function abEase(v){_abEase=v;abUpdate()}
function abReplay(){
  if(!selectedEl)return;
  selectedEl.style.opacity='';
  selectedEl.style.animation='none';
  selectedEl.offsetHeight;
  if(selectedEl.dataset.animVal)selectedEl.style.animation=selectedEl.dataset.animVal;
}
function abRemove(){
  if(!selectedEl)return;
  _abClearListeners(selectedEl);
  selectedEl.style.animation='';
  selectedEl.style.animationPlayState='';
  selectedEl.style.animationDelay='';
  selectedEl.style.opacity='';
  delete selectedEl.dataset.anim;
  delete selectedEl.dataset.animVal;
  delete selectedEl.dataset.animTrigger;
  saveState();
}
function abReadSelection(){
  if(!selectedEl)return;
  const preset=selectedEl.dataset.anim||'';
  const trigger=selectedEl.dataset.animTrigger||'load';
  if(preset)_abPreset=preset;
  _abTrigger=trigger;
  document.querySelectorAll('.ab-trig').forEach(b=>b.classList.remove('active'));
  const btn=document.querySelector(`.ab-trig[data-v="${trigger}"]`);
  if(btn)btn.classList.add('active');
  const anim=selectedEl.style.animation||'';
  if(anim&&anim!=='none'){
    const dm=anim.match(/([\d.]+)s/);
    if(dm){sv('ab-dur',Math.round(parseFloat(dm[1])*10));st('ab-dur-v',dm[1]+'s')}
  }
}

// ═══ ANIMATE: TRANSITIONS (HOVER) ═══
function trApply(name,css){
  if(!selectedEl)return toast('Select a block first');
  // Store hover CSS as data attribute
  selectedEl.dataset.hover=css;
  selectedEl.dataset.hoverName=name;
  const speed=(gv('tr-speed')/10)||0.3;
  selectedEl.style.transition=`all ${speed}s ease`;
  // Add hover listeners
  _trBind(selectedEl);
  saveState();
}
function _trBind(el){
  if(el._trBound)return;
  el._trBound=true;
  const origStyles={};
  el.addEventListener('mouseenter',()=>{
    if(el.closest('.dk-page')?.classList.contains('mode-select')&&el===selectedEl)return;
    const css=el.dataset.hover;if(!css)return;
    css.split(';').forEach(s=>{
      const[p,v]=s.split(':');
      if(p&&v){
        const prop=p.trim();
        origStyles[prop]=el.style.getPropertyValue(prop);
        el.style.setProperty(prop,v.trim());
      }
    });
  });
  el.addEventListener('mouseleave',()=>{
    Object.entries(origStyles).forEach(([p,v])=>{
      if(v)el.style.setProperty(p,v);else el.style.removeProperty(p);
    });
  });
}
function trUpdate(){
  if(!selectedEl||!selectedEl.dataset.hover)return;
  const speed=(gv('tr-speed')/10)||0.3;
  selectedEl.style.transition=`all ${speed}s ease`;
  saveState();
}
function trCursor(v){
  if(!selectedEl)return toast('Select a block first');
  selectedEl.style.cursor=v;
  saveState();
}
function trRemove(){
  if(!selectedEl)return;
  selectedEl.style.transition='';
  selectedEl.style.cursor='';
  delete selectedEl.dataset.hover;
  delete selectedEl.dataset.hoverName;
  saveState();
}

function updateAnim(){
  const preset=gv('anim-preset'),dur=(gv('anim-dur')/10).toFixed(1),delay=(gv('anim-delay')/10).toFixed(1),iter=gv('anim-iter'),ease=gv('anim-ease'),fill=gv('anim-fill');
  document.getElementById('anim-dur-val').textContent=dur+'s';document.getElementById('anim-delay-val').textContent=delay+'s';
  const a=ANIMS[preset];let kf='';
  if(a.frames){const entries=Object.entries(a.frames);kf=`@keyframes ${preset} {\n${entries.map(([k,v])=>`  ${k} { ${v}; }`).join('\n')}\n}`}
  else{kf=`@keyframes ${preset} {\n  from { ${a.from}; }\n  to { ${a.to}; }\n}`}
  const prop=`animation: ${preset} ${dur}s ${ease} ${delay}s ${iter} ${fill};`;
  document.getElementById('anim-out').textContent=kf+'\n\n.element {\n  '+prop+'\n}';
  replayAnim();
}
function replayAnim(){
  const preset=gv('anim-preset'),dur=(gv('anim-dur')/10).toFixed(1),delay=(gv('anim-delay')/10).toFixed(1),iter=gv('anim-iter'),ease=gv('anim-ease'),fill=gv('anim-fill');
  const a=ANIMS[preset];const el=document.getElementById('anim-target');
  let ss=document.getElementById('dk-anim-style');if(!ss){ss=document.createElement('style');ss.id='dk-anim-style';document.head.appendChild(ss)}
  let kf='';
  if(a.frames){const entries=Object.entries(a.frames);kf=`@keyframes _preview{${entries.map(([k,v])=>`${k}{${v}}`).join('')}}`}
  else{kf=`@keyframes _preview{from{${a.from}}to{${a.to}}}`}
  ss.textContent=kf;
  el.style.animation='none';el.offsetHeight;
  el.style.animation=`_preview ${dur}s ${ease} ${delay}s ${iter} ${fill}`;
}

// ═══ CURSOR ═══
function updateCursor(){
  const type=gv('cur-type');
  document.getElementById('cur-emoji-field').style.display=type==='emoji'?'block':'none';
  document.getElementById('cur-size-field').style.display=type==='emoji'?'block':'none';
  const preview=document.getElementById('cur-preview');
  let css='';
  if(type==='emoji'){
    const emoji=document.getElementById('cur-emoji').value||'→';const size=gv('cur-size');
    document.getElementById('cur-size-val').textContent=size;
    const c=document.createElement('canvas');c.width=parseInt(size);c.height=parseInt(size);const ctx=c.getContext('2d');
    ctx.font=`${Math.round(size*0.8)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(emoji,size/2,size/2);
    const url=c.toDataURL();
    preview.style.cursor=`url(${url}) ${Math.round(size/2)} ${Math.round(size/2)}, auto`;
    css=`cursor: url('data:image/svg+xml,...') ${Math.round(size/2)} ${Math.round(size/2)}, auto;\n/* Or use a .cur/.png file */`;
  }else{
    preview.style.cursor=type;
    css=`cursor: ${type};`;
  }
  document.getElementById('cur-out').textContent=css;
}

// ═══ CLIP PATH ═══
const CLIPS={
  triangle:'polygon(50% 0%, 0% 100%, 100% 100%)',trapezoid:'polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)',parallelogram:'polygon(25% 0%, 100% 0%, 75% 100%, 0% 100%)',
  rhombus:'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)',pentagon:'polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%)',
  hexagon:'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)',octagon:'polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%)',
  star:'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)',
  'arrow-right':'polygon(0% 20%, 60% 20%, 60% 0%, 100% 50%, 60% 100%, 60% 80%, 0% 80%)',
  'arrow-left':'polygon(40% 0%, 40% 20%, 100% 20%, 100% 80%, 40% 80%, 40% 100%, 0% 50%)',
  chevron:'polygon(0% 0%, 75% 0%, 100% 50%, 75% 100%, 0% 100%, 25% 50%)',
  cross:'polygon(10% 25%, 35% 25%, 35% 10%, 65% 10%, 65% 25%, 90% 25%, 90% 50%, 65% 50%, 65% 75%, 90% 75%, 90% 90%, 65% 90%, 65% 75%, 35% 75%, 35% 90%, 10% 90%, 10% 75%, 35% 75%, 35% 50%, 10% 50%)',
  frame:'polygon(0% 0%, 0% 100%, 10% 100%, 10% 10%, 90% 10%, 90% 90%, 10% 90%, 10% 100%, 100% 100%, 100% 0%)',
  circle:'circle(50% at 50% 50%)',ellipse:'ellipse(50% 40% at 50% 50%)',inset:'inset(10% round 10px)'
};
function updateClip(){
  const preset=gv('clip-preset');
  document.getElementById('clip-inset-ctrls').style.display=preset==='inset'?'':'none';
  let val;
  if(preset==='inset'){const ins=gv('clip-inset'),rnd=gv('clip-round');document.getElementById('clip-inset-val').textContent=ins+'%';document.getElementById('clip-round-val').textContent=rnd+'px';val=`inset(${ins}% round ${rnd}px)`}
  else{val=CLIPS[preset]}
  document.getElementById('clip-target').style.clipPath=val;
  document.getElementById('clip-out').textContent=`clip-path: ${val};`;
  window._lastClipVal=val;
}
function applyClip(){
  const val=window._lastClipVal;if(!val)return;
  if(selectedEl){
    let fill=selectedEl.querySelector('.dk-shape-fill');
    if(fill){
      fill.style.clipPath=val;
    }else{
      // Turn block into a shape
      const currentBg=selectedEl.style.background||'var(--p,#a855f7)';
      selectedEl.style.background='transparent';
      selectedEl.style.overflow='visible';
      selectedEl.dataset.shape='clip';
      fill=document.createElement('div');
      fill.className='dk-shape-fill';
      fill.style.cssText=`position:absolute;inset:0;clip-path:${val};background:${currentBg};pointer-events:none;z-index:0`;
      selectedEl.insertBefore(fill,selectedEl.firstChild);
    }
    saveState();
  }
}

// ═══ LAYOUT: ALIGN ═══
function alignBlock(mode){
  if(!selectedEl)return toast('Select a block first');
  const pw=getPageW();
  const page=document.querySelector('.dk-page');
  const ph=page?parseInt(page.style.height||page.style.minHeight)||900:900;
  const w=selectedEl.offsetWidth,h=selectedEl.offsetHeight;
  if(mode==='left')selectedEl.style.left='0px';
  else if(mode==='right')selectedEl.style.left=(pw-w)+'px';
  else if(mode==='centerH')selectedEl.style.left=Math.round((pw-w)/2)+'px';
  else if(mode==='top')selectedEl.style.top='0px';
  else if(mode==='bottom')selectedEl.style.top=(ph-h)+'px';
  else if(mode==='centerV')selectedEl.style.top=Math.round((ph-h)/2)+'px';
  alReadSelection();saveState();
}
function sizeBlock(mode){
  if(!selectedEl)return toast('Select a block first');
  const pw=getPageW();
  const page=document.querySelector('.dk-page');
  const ph=page?parseInt(page.style.height||page.style.minHeight)||900:900;
  if(mode==='fullW'){selectedEl.style.width=pw+'px';selectedEl.style.left='0px'}
  else if(mode==='fullH'){selectedEl.style.height=ph+'px';selectedEl.style.top='0px'}
  else if(mode==='full'){selectedEl.style.width=pw+'px';selectedEl.style.height=ph+'px';selectedEl.style.left='0px';selectedEl.style.top='0px'}
  else if(mode==='square'){const s=Math.min(selectedEl.offsetWidth,selectedEl.offsetHeight);selectedEl.style.width=s+'px';selectedEl.style.height=s+'px'}
  else if(mode==='half'){selectedEl.style.width=Math.round(pw/2)+'px'}
  else if(mode==='third'){selectedEl.style.width=Math.round(pw/3)+'px'}
  document.getElementById('sel-dims').textContent=Math.round(selectedEl.offsetWidth)+'×'+Math.round(selectedEl.offsetHeight);
  alReadSelection();saveState();
}
function distributeBlocks(dir){
  const page=document.querySelector('.dk-page');
  if(!page)return;
  const blocks=[...page.querySelectorAll('.dk-block')];
  if(blocks.length<2)return toast('Need 2+ blocks');
  if(dir==='h'){
    blocks.sort((a,b)=>a.offsetLeft-b.offsetLeft);
    const minL=blocks[0].offsetLeft;
    const maxR=blocks[blocks.length-1].offsetLeft+blocks[blocks.length-1].offsetWidth;
    const totalW=blocks.reduce((s,b)=>s+b.offsetWidth,0);
    const gap=(maxR-minL-totalW)/(blocks.length-1);
    let x=minL;
    blocks.forEach(b=>{b.style.left=Math.round(x)+'px';x+=b.offsetWidth+gap});
  }else{
    blocks.sort((a,b)=>a.offsetTop-b.offsetTop);
    const minT=blocks[0].offsetTop;
    const maxB=blocks[blocks.length-1].offsetTop+blocks[blocks.length-1].offsetHeight;
    const totalH=blocks.reduce((s,b)=>s+b.offsetHeight,0);
    const gap=(maxB-minT-totalH)/(blocks.length-1);
    let y=minT;
    blocks.forEach(b=>{b.style.top=Math.round(y)+'px';y+=b.offsetHeight+gap});
  }
  saveState();
}
function setBlockPos(){
  if(!selectedEl)return;
  const x=+gv('al-x'),y=+gv('al-y');
  selectedEl.style.left=x+'px';selectedEl.style.top=y+'px';
  saveState();
}
function setBlockSize(){
  if(!selectedEl)return;
  const w=Math.max(20,+gv('al-w')),h=Math.max(20,+gv('al-h'));
  selectedEl.style.width=w+'px';selectedEl.style.height=h+'px';
  document.getElementById('sel-dims').textContent=w+'×'+h;
  saveState();
}
function alReadSelection(){
  if(!selectedEl)return;
  sv('al-x',Math.round(selectedEl.offsetLeft));
  sv('al-y',Math.round(selectedEl.offsetTop));
  sv('al-w',Math.round(selectedEl.offsetWidth));
  sv('al-h',Math.round(selectedEl.offsetHeight));
}

// ═══ LAYOUT: PADDING/MARGIN/DISPLAY ═══
function pmApply(){
  if(!selectedEl)return;
  const pt=gv('pm-pt'),pr=gv('pm-pr'),pb=gv('pm-pb'),pl=gv('pm-pl');
  selectedEl.style.padding=`${pt}px ${pr}px ${pb}px ${pl}px`;
  const gap=gv('pm-gap');
  st('pm-gap-v',gap+'px');
  selectedEl.style.gap=gap+'px';
  saveState();
}
function pmPadAll(v){
  sv('pm-pt',v);sv('pm-pr',v);sv('pm-pb',v);sv('pm-pl',v);
  pmApply();
}
function pmDisplay(d){
  if(!selectedEl)return;
  selectedEl.style.display=d;
  const showFlex=d==='flex'||d==='inline-flex'||d==='grid';
  document.getElementById('pm-flex-ctrls').style.display=showFlex?'':'none';
  document.getElementById('pm-justify-ctrls').style.display=showFlex?'':'none';
  document.getElementById('pm-items-ctrls').style.display=showFlex?'':'none';
  saveState();
}
function pmFlex(dir){if(selectedEl){selectedEl.style.flexDirection=dir;saveState()}}
function pmJustify(v){if(selectedEl){selectedEl.style.justifyContent=v;saveState()}}
function pmAlignItems(v){if(selectedEl){selectedEl.style.alignItems=v;saveState()}}
function pmOverflow(v){if(selectedEl){selectedEl.style.overflow=v;saveState()}}
function pmReadSelection(){
  if(!selectedEl)return;
  const cs=getComputedStyle(selectedEl);
  const pad=cs.padding.split(' ').map(v=>parseInt(v)||0);
  sv('pm-pt',pad[0]||0);sv('pm-pr',pad[1]||pad[0]||0);
  sv('pm-pb',pad[2]||pad[0]||0);sv('pm-pl',pad[3]||pad[1]||pad[0]||0);
  const gap=parseInt(cs.gap)||0;
  sv('pm-gap',gap);st('pm-gap-v',gap+'px');
  const d=cs.display;
  const showFlex=d==='flex'||d==='inline-flex'||d==='grid';
  const fc=document.getElementById('pm-flex-ctrls');if(fc)fc.style.display=showFlex?'':'none';
  const jc=document.getElementById('pm-justify-ctrls');if(jc)jc.style.display=showFlex?'':'none';
  const ic=document.getElementById('pm-items-ctrls');if(ic)ic.style.display=showFlex?'':'none';
}

// ═══ LAYOUT: PAGE SIZE ═══
function setPageSize(w,h){
  sv('pg-w',w);sv('pg-h',h);
  resizePage();
}
function scaffoldPage(tmpl){
  const page=document.querySelector('.dk-page');
  if(page)page.querySelectorAll('.dk-block').forEach(b=>b.remove());
  clearSelection();
  const L={
    landing:{w:1280,h:2400,b:[
      {r:'frame',x:0,y:0,w:1280,h:700,s:'background:linear-gradient(135deg,var(--bg),var(--sf))'},
      {r:'heading',x:140,y:160,w:1000,h:60,t:'Your Product Name',s:'font-size:56px;text-align:center'},
      {r:'text',x:240,y:240,w:800,h:50,t:'A short tagline that explains what you do and why it matters',s:'font-size:20px;text-align:center;opacity:.7'},
      {r:'button',x:490,y:330,w:300,h:56,t:'Get Started →',s:'font-size:18px'},
      {r:'image',x:190,y:440,w:900,h:500,t:'Hero Image'},
      {r:'heading',x:140,y:1020,w:1000,h:50,t:'Features',s:'font-size:36px;text-align:center'},
      {r:'frame',x:60,y:1120,w:360,h:280,s:'background:var(--sf);border-radius:16px'},
      {r:'heading',x:92,y:1152,w:296,h:36,t:'Feature One',s:'font-size:22px'},
      {r:'text',x:92,y:1196,w:296,h:60,t:'Brief description of this feature and its benefits',s:'font-size:14px;opacity:.6'},
      {r:'frame',x:460,y:1120,w:360,h:280,s:'background:var(--sf);border-radius:16px'},
      {r:'heading',x:492,y:1152,w:296,h:36,t:'Feature Two',s:'font-size:22px'},
      {r:'text',x:492,y:1196,w:296,h:60,t:'Brief description of this feature and its benefits',s:'font-size:14px;opacity:.6'},
      {r:'frame',x:860,y:1120,w:360,h:280,s:'background:var(--sf);border-radius:16px'},
      {r:'heading',x:892,y:1152,w:296,h:36,t:'Feature Three',s:'font-size:22px'},
      {r:'text',x:892,y:1196,w:296,h:60,t:'Brief description of this feature and its benefits',s:'font-size:14px;opacity:.6'},
      {r:'heading',x:140,y:1500,w:1000,h:50,t:'Ready to get started?',s:'font-size:36px;text-align:center'},
      {r:'text',x:290,y:1570,w:700,h:40,t:'Join thousands of happy users today',s:'font-size:18px;text-align:center;opacity:.6'},
      {r:'button',x:490,y:1640,w:300,h:56,t:'Sign Up Free',s:'font-size:18px'},
      {r:'frame',x:0,y:2200,w:1280,h:200,s:'background:var(--sf)'},
      {r:'text',x:60,y:2260,w:400,h:30,t:'© 2025 Your Company. All rights reserved.',s:'font-size:13px;opacity:.4'}
    ]},
    hero:{w:1280,h:900,b:[
      {r:'frame',x:0,y:0,w:1280,h:80,s:'background:rgba(255,255,255,.03);backdrop-filter:blur(12px)'},
      {r:'heading',x:60,y:22,w:200,h:36,t:'LOGO',s:'font-size:20px;font-weight:800;color:var(--p)'},
      {r:'text',x:600,y:28,w:400,h:24,t:'Home   About   Features   Pricing   Contact',s:'font-size:14px;text-align:center;opacity:.6'},
      {r:'button',x:1080,y:20,w:140,h:40,t:'Sign Up',s:'font-size:13px'},
      {r:'heading',x:60,y:260,w:600,h:120,t:'Build something amazing today',s:'font-size:52px;line-height:1.1'},
      {r:'text',x:60,y:400,w:500,h:60,t:'The all-in-one platform for creators who want to ship fast without compromising on quality.',s:'font-size:18px;opacity:.6;line-height:1.6'},
      {r:'button',x:60,y:500,w:200,h:52,t:'Get Started',s:'font-size:16px'},
      {r:'button',x:280,y:500,w:200,h:52,t:'Learn More',s:'font-size:16px;background:transparent;border:2px solid var(--p);color:var(--p)'},
      {r:'image',x:700,y:140,w:520,h:600,t:'Hero Visual'}
    ]},
    blog:{w:960,h:1800,b:[
      {r:'frame',x:0,y:0,w:960,h:60,s:'background:var(--sf)'},
      {r:'heading',x:40,y:14,w:150,h:32,t:'Blog',s:'font-size:18px;font-weight:800'},
      {r:'image',x:80,y:100,w:800,h:400,t:'Cover Image'},
      {r:'heading',x:80,y:540,w:800,h:60,t:'Your Blog Post Title Goes Here',s:'font-size:40px;line-height:1.2'},
      {r:'text',x:80,y:620,w:500,h:24,t:'January 15, 2025  ·  5 min read',s:'font-size:13px;opacity:.4'},
      {r:'text',x:80,y:680,w:800,h:200,t:'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.',s:'font-size:17px;line-height:1.8;opacity:.8'},
      {r:'heading',x:80,y:920,w:800,h:40,t:'Section Heading',s:'font-size:28px'},
      {r:'text',x:80,y:980,w:800,h:200,t:'Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.',s:'font-size:17px;line-height:1.8;opacity:.8'}
    ]},
    portfolio:{w:1200,h:2000,b:[
      {r:'heading',x:60,y:60,w:400,h:50,t:'Jane Designer',s:'font-size:36px;font-weight:800'},
      {r:'text',x:60,y:120,w:500,h:30,t:'Product Designer & Creative Director',s:'font-size:16px;opacity:.5'},
      {r:'image',x:60,y:200,w:570,h:380,t:'Project 1'},
      {r:'image',x:650,y:200,w:490,h:380,t:'Project 2'},
      {r:'image',x:60,y:600,w:490,h:380,t:'Project 3'},
      {r:'image',x:570,y:600,w:570,h:380,t:'Project 4'},
      {r:'heading',x:60,y:1060,w:400,h:40,t:'About',s:'font-size:28px'},
      {r:'text',x:60,y:1110,w:700,h:80,t:'Brief bio about your experience and what makes your work unique.',s:'font-size:16px;line-height:1.7;opacity:.7'},
      {r:'text',x:60,y:1260,w:400,h:30,t:'hello@janedesigner.com',s:'font-size:16px;color:var(--p)'}
    ]},
    email:{w:600,h:1200,b:[
      {r:'frame',x:0,y:0,w:600,h:80,s:'background:var(--p)'},
      {r:'heading',x:30,y:24,w:200,h:32,t:'BRAND',s:'font-size:18px;color:#fff'},
      {r:'image',x:0,y:80,w:600,h:300,t:'Header Image'},
      {r:'heading',x:40,y:420,w:520,h:40,t:'Check out what is new',s:'font-size:28px'},
      {r:'text',x:40,y:480,w:520,h:80,t:'We have some exciting updates to share with you.',s:'font-size:15px;line-height:1.7;opacity:.7'},
      {r:'button',x:40,y:590,w:200,h:48,t:'Read More',s:'font-size:14px'},
      {r:'text',x:40,y:740,w:520,h:60,t:'Thanks for being a subscriber.',s:'font-size:13px;opacity:.4'}
    ]},
    pricing:{w:1280,h:1000,b:[
      {r:'heading',x:240,y:60,w:800,h:50,t:'Simple, transparent pricing',s:'font-size:42px;text-align:center'},
      {r:'text',x:340,y:130,w:600,h:30,t:'No hidden fees. Cancel anytime.',s:'font-size:18px;text-align:center;opacity:.5'},
      {r:'frame',x:60,y:220,w:370,h:440,s:'background:var(--sf);border-radius:20px'},
      {r:'heading',x:100,y:260,w:290,h:30,t:'Starter',s:'font-size:20px;opacity:.6'},
      {r:'heading',x:100,y:300,w:290,h:50,t:'$9/mo',s:'font-size:42px;font-weight:800'},
      {r:'text',x:100,y:370,w:290,h:100,t:'✓ 5 projects\n✓ Basic support\n✓ 1GB storage',s:'font-size:14px;line-height:2;opacity:.6'},
      {r:'button',x:100,y:520,w:290,h:48,t:'Get Started',s:'font-size:14px;background:transparent;border:2px solid var(--p);color:var(--p)'},
      {r:'frame',x:455,y:200,w:370,h:480,s:'background:var(--p);border-radius:20px'},
      {r:'heading',x:495,y:240,w:290,h:30,t:'Pro',s:'font-size:20px;color:#fff;opacity:.8'},
      {r:'heading',x:495,y:280,w:290,h:50,t:'$29/mo',s:'font-size:42px;font-weight:800;color:#fff'},
      {r:'text',x:495,y:350,w:290,h:120,t:'✓ Unlimited projects\n✓ Priority support\n✓ 50GB storage\n✓ API access',s:'font-size:14px;line-height:2;color:#fff;opacity:.8'},
      {r:'button',x:495,y:520,w:290,h:48,t:'Get Started',s:'font-size:14px;background:#fff;color:var(--p)'},
      {r:'frame',x:850,y:220,w:370,h:440,s:'background:var(--sf);border-radius:20px'},
      {r:'heading',x:890,y:260,w:290,h:30,t:'Enterprise',s:'font-size:20px;opacity:.6'},
      {r:'heading',x:890,y:300,w:290,h:50,t:'Custom',s:'font-size:42px;font-weight:800'},
      {r:'text',x:890,y:370,w:290,h:100,t:'✓ Everything in Pro\n✓ Dedicated support\n✓ Unlimited storage',s:'font-size:14px;line-height:2;opacity:.6'},
      {r:'button',x:890,y:520,w:290,h:48,t:'Contact Sales',s:'font-size:14px;background:transparent;border:2px solid var(--p);color:var(--p)'}
    ]},
    mobile:{w:390,h:844,b:[
      {r:'frame',x:0,y:0,w:390,h:50,s:'background:var(--sf)'},
      {r:'heading',x:20,y:12,w:150,h:26,t:'App Name',s:'font-size:16px;font-weight:700'},
      {r:'heading',x:20,y:80,w:350,h:36,t:'Welcome back',s:'font-size:28px;font-weight:800'},
      {r:'text',x:20,y:124,w:350,h:24,t:'Here is your daily overview',s:'font-size:14px;opacity:.5'},
      {r:'frame',x:20,y:170,w:350,h:160,s:'background:linear-gradient(135deg,var(--p),var(--s));border-radius:16px'},
      {r:'heading',x:44,y:194,w:200,h:24,t:'Balance',s:'font-size:13px;color:rgba(255,255,255,.7)'},
      {r:'heading',x:44,y:224,w:200,h:36,t:'$2,450.00',s:'font-size:32px;color:#fff;font-weight:800'},
      {r:'frame',x:20,y:360,w:170,h:120,s:'background:var(--sf);border-radius:12px'},
      {r:'frame',x:200,y:360,w:170,h:120,s:'background:var(--sf);border-radius:12px'},
      {r:'heading',x:20,y:510,w:200,h:28,t:'Recent',s:'font-size:18px;font-weight:700'},
      {r:'frame',x:20,y:550,w:350,h:60,s:'background:var(--sf);border-radius:10px'},
      {r:'frame',x:20,y:620,w:350,h:60,s:'background:var(--sf);border-radius:10px'},
      {r:'frame',x:20,y:690,w:350,h:60,s:'background:var(--sf);border-radius:10px'},
      {r:'frame',x:0,y:784,w:390,h:60,s:'background:var(--sf)'}
    ]},
    tablet:{w:768,h:1024,b:[
      {r:'frame',x:0,y:0,w:768,h:64,s:'background:var(--sf)'},
      {r:'heading',x:30,y:16,w:200,h:32,t:'Dashboard',s:'font-size:20px;font-weight:700'},
      {r:'frame',x:30,y:94,w:350,h:200,s:'background:var(--sf);border-radius:16px'},
      {r:'frame',x:400,y:94,w:338,h:200,s:'background:var(--sf);border-radius:16px'},
      {r:'frame',x:30,y:314,w:708,h:300,s:'background:var(--sf);border-radius:16px'},
      {r:'heading',x:60,y:340,w:300,h:30,t:'Analytics Overview',s:'font-size:18px'},
      {r:'frame',x:30,y:640,w:230,h:180,s:'background:var(--sf);border-radius:16px'},
      {r:'frame',x:270,y:640,w:230,h:180,s:'background:var(--sf);border-radius:16px'},
      {r:'frame',x:510,y:640,w:228,h:180,s:'background:var(--sf);border-radius:16px'}
    ]},
    desktop:{w:1920,h:1080,b:[
      {r:'frame',x:0,y:0,w:1920,h:64,s:'background:var(--sf)'},
      {r:'heading',x:40,y:16,w:200,h:32,t:'Dashboard',s:'font-size:20px;font-weight:700'},
      {r:'frame',x:0,y:64,w:240,h:1016,s:'background:var(--sf);border-right:1px solid rgba(255,255,255,.06)'},
      {r:'frame',x:280,y:100,w:520,h:300,s:'background:rgba(255,255,255,.03);border-radius:16px'},
      {r:'frame',x:820,y:100,w:520,h:300,s:'background:rgba(255,255,255,.03);border-radius:16px'},
      {r:'frame',x:1360,y:100,w:520,h:300,s:'background:rgba(255,255,255,.03);border-radius:16px'},
      {r:'frame',x:280,y:440,w:1600,h:500,s:'background:rgba(255,255,255,.03);border-radius:16px'},
      {r:'heading',x:320,y:470,w:400,h:32,t:'Data Table',s:'font-size:20px'}
    ]},
    igpost:{w:1080,h:1080,b:[
      {r:'frame',x:0,y:0,w:1080,h:1080,s:'background:linear-gradient(135deg,var(--p),var(--s))'},
      {r:'heading',x:100,y:200,w:880,h:80,t:'Your Bold Statement Here',s:'font-size:54px;text-align:center;color:#fff;font-weight:800;line-height:1.2'},
      {r:'text',x:160,y:340,w:760,h:50,t:'Supporting text that adds context',s:'font-size:24px;text-align:center;color:rgba(255,255,255,.8)'},
      {r:'text',x:200,y:540,w:680,h:40,t:'@yourbrand',s:'font-size:20px;text-align:center;color:rgba(255,255,255,.6)'}
    ]},
    igstory:{w:1080,h:1920,b:[
      {r:'frame',x:0,y:0,w:1080,h:1920,s:'background:linear-gradient(180deg,var(--bg),var(--sf))'},
      {r:'image',x:90,y:200,w:900,h:900,t:'Main Visual'},
      {r:'heading',x:90,y:1160,w:900,h:60,t:'Swipe Up',s:'font-size:44px;text-align:center;font-weight:800'},
      {r:'text',x:140,y:1240,w:800,h:40,t:'Tap to learn more',s:'font-size:22px;text-align:center;opacity:.6'}
    ]},
    ogimage:{w:1200,h:630,b:[
      {r:'frame',x:0,y:0,w:1200,h:630,s:'background:linear-gradient(135deg,var(--bg),var(--sf))'},
      {r:'heading',x:80,y:120,w:700,h:100,t:'Article Title Goes Here',s:'font-size:48px;font-weight:800;line-height:1.2'},
      {r:'text',x:80,y:260,w:600,h:40,t:'A brief description of what this page is about',s:'font-size:20px;opacity:.6'},
      {r:'text',x:80,y:500,w:300,h:30,t:'yoursite.com',s:'font-size:16px;opacity:.5'},
      {r:'image',x:860,y:100,w:260,h:260,t:'Logo'}
    ]},
    ytthumb:{w:1280,h:720,b:[
      {r:'frame',x:0,y:0,w:1280,h:720,s:'background:linear-gradient(135deg,#1a1a2e,#16213e)'},
      {r:'image',x:0,y:0,w:640,h:720,t:'Face / Visual'},
      {r:'heading',x:680,y:180,w:540,h:140,t:'CLICK BAIT TITLE',s:'font-size:64px;font-weight:900;color:#fff;line-height:1.1'},
      {r:'text',x:680,y:380,w:400,h:40,t:'something interesting',s:'font-size:24px;color:var(--p);font-weight:700'}
    ]}
  }[tmpl];
  if(!L)return;
  setPageSize(L.w,L.h);
  setTimeout(()=>{
    L.b.forEach(b=>{
      const el=createBlock(b.x,b.y,b.w,b.h,b.r);
      if(!el)return;
      if(b.s)el.style.cssText+=';'+b.s;
      if(b.t){
        const txt=el.querySelector('.dk-text');
        if(txt)txt.textContent=b.t;
        else if(b.r==='image')el.textContent=b.t;
      }
    });
    clearSelection();
    saveState();
  },100);
}
function resizePage(){
  const w=Math.max(100,+gv('pg-w')||1280);
  const h=Math.max(100,+gv('pg-h')||900);
  const page=document.querySelector('.dk-page');
  const vp=document.getElementById('lp-viewport');
  if(!page||!vp)return;
  page.style.width=w+'px';
  page.dataset.pageH=h;
  vp.style.width=w+'px';
  if(window._updatePreviewSize)window._updatePreviewSize();
  saveState();
}
function pgReadSelection(){
  const page=document.querySelector('.dk-page');
  if(!page)return;
  sv('pg-w',parseInt(page.style.width)||1280);
  sv('pg-h',parseInt(page.style.height||page.style.minHeight)||900);
}

// ═══ EASING CURVES ═══
function setEase(x1,y1,x2,y2){document.getElementById('ez-x1').value=x1;document.getElementById('ez-y1').value=y1;document.getElementById('ez-x2').value=x2;document.getElementById('ez-y2').value=y2;drawEase()}
function drawEase(){
  const x1=parseFloat(gv('ez-x1')),y1=parseFloat(gv('ez-y1')),x2=parseFloat(gv('ez-x2')),y2=parseFloat(gv('ez-y2'));
  const c=document.getElementById('ease-canvas'),ctx=c.getContext('2d');const W=280,H=280,P=30;
  ctx.clearRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='#2a2a3a';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const x=P+(W-P*2)/4*i;ctx.beginPath();ctx.moveTo(x,P);ctx.lineTo(x,H-P);ctx.stroke();const y=P+(H-P*2)/4*i;ctx.beginPath();ctx.moveTo(P,y);ctx.lineTo(W-P,y);ctx.stroke()}
  // Curve
  const sx=P,sy=H-P,ex=W-P,ey=P;
  const cp1x=sx+(ex-sx)*x1,cp1y=sy+(ey-sy)*y1,cp2x=sx+(ex-sx)*x2,cp2y=sy+(ey-sy)*y2;
  ctx.beginPath();ctx.moveTo(sx,sy);ctx.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,ex,ey);ctx.strokeStyle='#a855f7';ctx.lineWidth=3;ctx.stroke();
  // Control points
  ctx.setLineDash([4,4]);ctx.strokeStyle='#55556a';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(cp1x,cp1y);ctx.stroke();
  ctx.beginPath();ctx.moveTo(ex,ey);ctx.lineTo(cp2x,cp2y);ctx.stroke();
  ctx.setLineDash([]);
  [cp1x,cp1y,cp2x,cp2y].forEach((v,i)=>{if(i%2===0){ctx.beginPath();ctx.arc(v,[cp1y,0,cp2y,0][i],6,0,Math.PI*2);ctx.fillStyle=i===0?'#ec4899':'#06b6d4';ctx.fill()}});
  // Labels
  ctx.fillStyle='#55556a';ctx.font='10px "JetBrains Mono"';ctx.fillText('0',P-8,H-P+14);ctx.fillText('1',W-P-4,P-8);
  const bezStr=`cubic-bezier(${x1}, ${y1}, ${x2}, ${y2})`;
  document.getElementById('ease-out').textContent=`transition-timing-function: ${bezStr};\n\n/* Or in animation */\nanimation-timing-function: ${bezStr};`;
  document.getElementById('ease-ball').style.transitionTimingFunction=bezStr;
}
function playEase(){const b=document.getElementById('ease-ball');b.style.left='2px';b.offsetHeight;b.style.left='252px';setTimeout(()=>{b.style.left='2px'},1200)}

// ═══ SPACING SCALE ═══
function genSpacing(){
  const base=parseInt(gv('sp-base'))||8,type=gv('sp-type'),steps=parseInt(gv('sp-steps'))||10;
  let values=[];const fib=[1,1,2,3,5,8,13,21,34,55,89];
  for(let i=0;i<steps;i++){
    if(type==='linear')values.push(base*(i+1));
    else if(type==='fibonacci')values.push(base*(fib[i]||fib[fib.length-1]));
    else if(type==='golden')values.push(Math.round(base*Math.pow(1.618,i)));
    else values.push(base*Math.pow(2,i));
  }
  const preview=document.getElementById('sp-preview');
  preview.innerHTML=values.map((v,i)=>`<div style="display:flex;align-items:center;gap:12px;margin-bottom:4px"><span style="width:50px;font-family:var(--mono);font-size:11px;color:var(--t3);text-align:right">${v}px</span><div style="width:${Math.min(v,500)}px;height:12px;background:linear-gradient(90deg,var(--acc),var(--pink));border-radius:3px;opacity:${0.4+i*0.06}"></div><span style="font-family:var(--mono);font-size:10px;color:var(--t4)">--space-${i+1}</span></div>`).join('');
  document.getElementById('sp-out').textContent=`:root {\n${values.map((v,i)=>`  --space-${i+1}: ${v}px;`).join('\n')}\n}`;
}

// ═══ COLOR BLIND SIM ═══
function cbTransform(r,g,b,type){
  if(type==='normal')return[r,g,b];
  const matrices={protanopia:[0.567,0.433,0,0.558,0.442,0,0,0.242,0.758],deuteranopia:[0.625,0.375,0,0.7,0.3,0,0,0.3,0.7],tritanopia:[0.95,0.05,0,0,0.433,0.567,0,0.475,0.525],achromatopsia:[0.299,0.587,0.114,0.299,0.587,0.114,0.299,0.587,0.114]};
  const m=matrices[type];if(!m)return[r,g,b];
  return[Math.round(r*m[0]+g*m[1]+b*m[2]),Math.round(r*m[3]+g*m[4]+b*m[5]),Math.round(r*m[6]+g*m[7]+b*m[8])];
}
function updateCBSim(){
  const colors=[gv('cb-c1'),gv('cb-c2'),gv('cb-c3'),gv('cb-c4')];
  const types=[{id:'normal',name:'Normal Vision'},{id:'protanopia',name:'Protanopia (No Red)'},{id:'deuteranopia',name:'Deuteranopia (No Green)'},{id:'tritanopia',name:'Tritanopia (No Blue)'},{id:'achromatopsia',name:'Achromatopsia (No Color)'}];
  document.getElementById('cb-grid').innerHTML=types.map(t=>{
    const swatches=colors.map(c=>{const r=parseInt(c.slice(1,3),16),g=parseInt(c.slice(3,5),16),b=parseInt(c.slice(5,7),16);
      const[nr,ng,nb]=cbTransform(r,g,b,t.id);const hex=`#${nr.toString(16).padStart(2,'0')}${ng.toString(16).padStart(2,'0')}${nb.toString(16).padStart(2,'0')}`;
      return`<div style="flex:1;height:50px;background:${hex}" title="${hex}"></div>`}).join('');
    return`<div style="background:var(--bg2);border:1px solid var(--bdr);border-radius:10px;overflow:hidden"><div style="padding:8px 12px;font-size:11px;font-weight:600;color:${t.id==='normal'?'var(--green)':'var(--t3)'}"><span style="font-family:var(--mono)">${t.name}</span></div><div style="display:flex">${swatches}</div></div>`}).join('');
}

// ═══ BREAKPOINTS ═══
function renderBreakpoints(){
  const fw=gv('bp-fw');
  const bps={tailwind:[{n:'sm',w:640},{n:'md',w:768},{n:'lg',w:1024},{n:'xl',w:1280},{n:'2xl',w:1536}],
    bootstrap:[{n:'sm',w:576},{n:'md',w:768},{n:'lg',w:992},{n:'xl',w:1200},{n:'xxl',w:1400}],
    custom:[{n:'mobile',w:480},{n:'tablet',w:768},{n:'laptop',w:1024},{n:'desktop',w:1280},{n:'wide',w:1536},{n:'ultra',w:1920}]};
  const items=bps[fw]||bps.custom;
  document.getElementById('bp-grid').innerHTML=items.map((bp,i)=>{
    const pct=Math.min(100,bp.w/20);
    return`<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;padding:12px;background:var(--bg2);border:1px solid var(--bdr);border-radius:8px"><div style="width:60px;font-family:var(--mono);font-size:13px;font-weight:700;color:var(--acc)">${bp.n}</div><div style="flex:1"><div style="height:8px;background:var(--bg4);border-radius:4px;overflow:hidden"><div style="width:${pct}%;height:100%;background:linear-gradient(90deg,var(--acc),var(--pink));border-radius:4px"></div></div></div><div style="width:60px;font-family:var(--mono);font-size:12px;color:var(--t3);text-align:right">${bp.w}px</div></div>`}).join('');
  document.getElementById('bp-out').textContent=items.map(bp=>`@media (min-width: ${bp.w}px) { /* ${bp.n} */ }`).join('\n');
}

// ═══ FAVICON ═══
function genFavicon(){
  const text=document.getElementById('fav-text').value||'A',bg=gv('fav-bg'),shape=gv('fav-shape'),fs=parseInt(gv('fav-fs'));
  document.getElementById('fav-fs-val').textContent=fs+'px';
  [128,64,32,16].forEach(size=>{
    const c=document.getElementById('fav-'+size);const ctx=c.getContext('2d');
    ctx.clearRect(0,0,size,size);
    if(shape==='circle'){ctx.beginPath();ctx.arc(size/2,size/2,size/2,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill()}
    else if(shape==='rounded'){const r=size*0.15;ctx.beginPath();ctx.moveTo(r,0);ctx.lineTo(size-r,0);ctx.quadraticCurveTo(size,0,size,r);ctx.lineTo(size,size-r);ctx.quadraticCurveTo(size,size,size-r,size);ctx.lineTo(r,size);ctx.quadraticCurveTo(0,size,0,size-r);ctx.lineTo(0,r);ctx.quadraticCurveTo(0,0,r,0);ctx.fillStyle=bg;ctx.fill()}
    else{ctx.fillStyle=bg;ctx.fillRect(0,0,size,size)}
    const scaledFs=Math.round(fs*(size/128));
    ctx.font=`${scaledFs}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,size/2,size/2+size*0.04);
  });
}
function downloadFav(){const a=document.createElement('a');a.download='favicon-128.png';a.href=document.getElementById('fav-128').toDataURL();a.click()}

// ═══ QR CODE ═══
function genQR(){
  const text=document.getElementById('qr-text').value;
  const size=parseInt(gv('qr-size'));
  const fg=gv('qr-fg'),bg=gv('qr-bg');
  document.getElementById('qr-size-val').textContent=size+'px';
  const c=document.getElementById('qr-canvas');c.width=size;c.height=size;
  const ctx=c.getContext('2d');
  ctx.fillStyle=bg;ctx.fillRect(0,0,size,size);
  if(!text){ctx.fillStyle='#55556a';ctx.font='14px "DM Sans"';ctx.textAlign='center';ctx.fillText('Enter text above',size/2,size/2);return}
  try{
    const matrix=generateQRMatrix(text);
    const modules=matrix.length;
    const cellSize=size/modules;
    ctx.fillStyle=fg;
    for(let y=0;y<modules;y++)for(let x=0;x<modules;x++){
      if(matrix[y][x])ctx.fillRect(x*cellSize,y*cellSize,cellSize+0.5,cellSize+0.5);
    }
  }catch(e){
    ctx.fillStyle='#ef4444';ctx.font='12px "DM Sans"';ctx.textAlign='center';
    ctx.fillText('Text too long for QR',size/2,size/2);
  }
}

function generateQRMatrix(text){
  // Encode as byte mode QR, EC level L
  const data=[];
  for(let i=0;i<text.length;i++){
    const code=text.charCodeAt(i);
    if(code>255)data.push(0x3F);else data.push(code);
  }
  // Pick smallest version that fits
  const capacityL=[17,32,53,78,106,134,154,192,230,271,321,367,425,458,520,586,644,718,792,858];
  let version=1;
  for(let v=0;v<capacityL.length;v++){if(data.length<=capacityL[v]){version=v+1;break}}
  if(data.length>capacityL[capacityL.length-1])throw new Error('Too long');
  const mSize=17+version*4;
  // Data codewords capacity per version (EC level L)
  const dcWords=[19,34,55,80,108,136,156,194,232,274,324,370,428,461,523,589,647,721,795,861];
  const ecWordsPerBlock=[7,10,15,20,18,18,20,24,30,18,20,24,26,30,22,24,28,30,26,28];
  const numBlocks=[1,1,1,1,1,2,2,2,2,4,4,4,4,4,4,4,4,4,4,4];
  const totalDC=dcWords[version-1];
  const ecPB=ecWordsPerBlock[version-1];
  const nBlocks=numBlocks[version-1];
  // Build data bitstream: mode(4)+count(8or16)+data+terminator+padding
  let bits='';
  bits+='0100'; // byte mode
  bits+=(data.length).toString(2).padStart(version<=9?8:16,'0');
  for(const b of data)bits+=b.toString(2).padStart(8,'0');
  // Terminator
  const totalBits=totalDC*8;
  bits+='0000'.slice(0,Math.min(4,totalBits-bits.length));
  while(bits.length%8!==0)bits+='0';
  // Pad codewords
  const pads=['11101100','00010001'];let pi=0;
  while(bits.length<totalBits){bits+=pads[pi%2];pi++}
  // Convert to bytes
  const codewords=[];
  for(let i=0;i<bits.length;i+=8)codewords.push(parseInt(bits.slice(i,i+8),2));
  // RS error correction
  const dcPerBlock=Math.floor(totalDC/nBlocks);
  const extraDC=totalDC%nBlocks;
  const blocks=[];const ecBlocks=[];
  let offset=0;
  for(let b=0;b<nBlocks;b++){
    const count=dcPerBlock+(b>=nBlocks-extraDC?1:0);
    const block=codewords.slice(offset,offset+count);
    blocks.push(block);
    ecBlocks.push(rsEncode(block,ecPB));
    offset+=count;
  }
  // Interleave
  const result=[];
  const maxDC=Math.max(...blocks.map(b=>b.length));
  for(let i=0;i<maxDC;i++)for(const b of blocks)if(i<b.length)result.push(b[i]);
  for(let i=0;i<ecPB;i++)for(const b of ecBlocks)if(i<b.length)result.push(b[i]);
  // Build matrix
  const matrix=Array.from({length:mSize},()=>Array(mSize).fill(null));
  const reserved=Array.from({length:mSize},()=>Array(mSize).fill(false));
  // Finder patterns
  const setFinder=(r,c)=>{
    for(let dy=-1;dy<=7;dy++)for(let dx=-1;dx<=7;dx++){
      const y=r+dy,x=c+dx;
      if(y<0||y>=mSize||x<0||x>=mSize)continue;
      const isBorder=dy===-1||dy===7||dx===-1||dx===7;
      const isOuter=dy===0||dy===6||dx===0||dx===6;
      const isInner=dy>=2&&dy<=4&&dx>=2&&dx<=4;
      matrix[y][x]=(!isBorder&&(isOuter||isInner))?1:0;
      reserved[y][x]=true;
    }
  };
  setFinder(0,0);setFinder(0,mSize-7);setFinder(mSize-7,0);
  // Timing patterns
  for(let i=8;i<mSize-8;i++){
    matrix[6][i]=i%2===0?1:0;reserved[6][i]=true;
    matrix[i][6]=i%2===0?1:0;reserved[i][6]=true;
  }
  // Alignment patterns (simplified for small versions)
  if(version>=2){
    const alignPos=getAlignmentPositions(version);
    for(const ay of alignPos)for(const ax of alignPos){
      if(reserved[ay]&&reserved[ay][ax])continue;
      for(let dy=-2;dy<=2;dy++)for(let dx=-2;dx<=2;dx++){
        const y=ay+dy,x=ax+dx;
        if(y<0||y>=mSize||x<0||x>=mSize||reserved[y][x])continue;
        matrix[y][x]=(Math.abs(dy)===2||Math.abs(dx)===2||(!dy&&!dx))?1:0;
        reserved[y][x]=true;
      }
    }
  }
  // Dark module
  matrix[4*version+9][8]=1;reserved[4*version+9][8]=true;
  // Reserve format info areas
  for(let i=0;i<8;i++){
    if(!reserved[8][i]){reserved[8][i]=true}
    if(!reserved[8][mSize-1-i]){reserved[8][mSize-1-i]=true}
    if(!reserved[i][8]){reserved[i][8]=true}
    if(!reserved[mSize-1-i][8]){reserved[mSize-1-i][8]=true}
  }
  if(!reserved[8][8])reserved[8][8]=true;
  // Reserve version info for v>=7
  if(version>=7){
    for(let i=0;i<6;i++)for(let j=0;j<3;j++){
      reserved[i][mSize-11+j]=true;
      reserved[mSize-11+j][i]=true;
    }
  }
  // Place data bits
  let bitIdx=0;
  const dataBits=result.map(b=>b.toString(2).padStart(8,'0')).join('');
  let x=mSize-1,upward=true;
  while(x>=0){
    if(x===6)x--;
    for(let i=0;i<mSize;i++){
      const y=upward?mSize-1-i:i;
      for(let dx=0;dx<=1;dx++){
        const cx=x-dx;
        if(cx<0||reserved[y][cx])continue;
        matrix[y][cx]=bitIdx<dataBits.length?parseInt(dataBits[bitIdx]):0;
        bitIdx++;
      }
    }
    x-=2;upward=!upward;
  }
  // Apply mask (pattern 0: (y+x)%2===0)
  for(let y=0;y<mSize;y++)for(let x=0;x<mSize;x++){
    if(!reserved[y][x])matrix[y][x]^=((y+x)%2===0)?1:0;
  }
  // Write format info (L + mask 0)
  const formatBits='111011111000100';
  const fmtPositions=[[8,0],[8,1],[8,2],[8,3],[8,4],[8,5],[8,7],[8,8],[7,8],[5,8],[4,8],[3,8],[2,8],[1,8],[0,8]];
  fmtPositions.forEach((p,i)=>{matrix[p[0]][p[1]]=parseInt(formatBits[i])});
  const fmtPositions2=[[mSize-1,8],[mSize-2,8],[mSize-3,8],[mSize-4,8],[mSize-5,8],[mSize-6,8],[mSize-7,8],[8,mSize-8],[8,mSize-7],[8,mSize-6],[8,mSize-5],[8,mSize-4],[8,mSize-3],[8,mSize-2],[8,mSize-1]];
  fmtPositions2.forEach((p,i)=>{matrix[p[0]][p[1]]=parseInt(formatBits[i])});
  // Null to 0
  for(let y=0;y<mSize;y++)for(let x=0;x<mSize;x++)if(matrix[y][x]===null)matrix[y][x]=0;
  // Add quiet zone
  const qz=4;const final=Array.from({length:mSize+qz*2},()=>Array(mSize+qz*2).fill(0));
  for(let y=0;y<mSize;y++)for(let x=0;x<mSize;x++)final[y+qz][x+qz]=matrix[y][x];
  return final;
}

// GF(256) Reed-Solomon
const GF_EXP=new Array(512);const GF_LOG=new Array(256);
(function initGF(){let v=1;for(let i=0;i<255;i++){GF_EXP[i]=v;GF_LOG[v]=i;v<<=1;if(v>=256)v^=0x11d}for(let i=255;i<512;i++)GF_EXP[i]=GF_EXP[i-255]})();
function gfMul(a,b){if(a===0||b===0)return 0;return GF_EXP[GF_LOG[a]+GF_LOG[b]]}
function rsEncode(data,nsym){
  const gen=rsGenPoly(nsym);
  const res=new Array(data.length+nsym).fill(0);
  for(let i=0;i<data.length;i++)res[i]=data[i];
  for(let i=0;i<data.length;i++){
    const coef=res[i];
    if(coef!==0)for(let j=0;j<gen.length;j++)res[i+j]^=gfMul(gen[j],coef);
  }
  return res.slice(data.length);
}
function rsGenPoly(nsym){
  let g=[1];
  for(let i=0;i<nsym;i++){
    const p=[1,GF_EXP[i]];
    const ng=new Array(g.length+1).fill(0);
    for(let j=0;j<g.length;j++)for(let k=0;k<p.length;k++)ng[j+k]^=gfMul(g[j],p[k]);
    g=ng;
  }
  return g;
}
function getAlignmentPositions(version){
  if(version===1)return[];
  const intervals=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90]];
  return intervals[version-1]||[];
}
function downloadQR(){const a=document.createElement("a");a.download="qrcode.png";a.href=document.getElementById("qr-canvas").toDataURL();a.click()}

// ═══ DEVICE MOCKUP ═══
function updateMockup(){
  const device=gv('mock-device'),content=gv('mock-content'),color=gv('mock-color');
  const dims={phone:{w:180,h:360,r:24,bezel:8},laptop:{w:400,h:260,r:12,bezel:10},tablet:{w:280,h:380,r:16,bezel:12},watch:{w:120,h:150,r:30,bezel:8},monitor:{w:420,h:280,r:8,bezel:6}};
  const d=dims[device];
  let screenBg=color;
  if(content==='gradient')screenBg=`linear-gradient(135deg,${color},#ec4899)`;
  else if(content==='mesh')screenBg=`${color}`;
  const meshStyle=content==='mesh'?`;background-image:radial-gradient(at 20% 20%,${color} 0%,transparent 50%),radial-gradient(at 80% 80%,#ec4899 0%,transparent 50%),radial-gradient(at 80% 20%,#06b6d4 0%,transparent 50%)`:'';
  let html=`<div style="background:#111;border-radius:${d.r}px;padding:${d.bezel}px;box-shadow:0 8px 40px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.1)">`;
  if(device==='phone')html+=`<div style="background:#222;border-radius:${d.r-4}px;width:${d.w}px;height:${d.h}px;overflow:hidden;position:relative"><div style="position:absolute;top:0;left:50%;transform:translateX(-50%);width:80px;height:20px;background:#111;border-radius:0 0 10px 10px;z-index:2"></div><div style="width:100%;height:100%;background:${screenBg}${meshStyle};border-radius:${d.r-4}px"></div></div>`;
  else if(device==='laptop')html+=`<div style="background:#222;border-radius:${d.r-4}px ${d.r-4}px 0 0;width:${d.w}px;height:${d.h-30}px;overflow:hidden"><div style="width:100%;height:100%;background:${screenBg}${meshStyle}"></div></div><div style="width:${d.w+40}px;height:14px;background:linear-gradient(180deg,#333,#222);border-radius:0 0 6px 6px;margin:0 -20px"></div>`;
  else if(device==='watch')html+=`<div style="background:#222;border-radius:${d.r}px;width:${d.w}px;height:${d.h}px;overflow:hidden"><div style="width:100%;height:100%;background:${screenBg}${meshStyle};border-radius:${d.r}px"></div></div>`;
  else html+=`<div style="background:#222;border-radius:${d.r-2}px;width:${d.w}px;height:${d.h}px;overflow:hidden"><div style="width:100%;height:100%;background:${screenBg}${meshStyle}"></div></div>`;
  html+=`</div>`;
  document.getElementById('mock-preview').innerHTML=html;
}

// ═══ CSS CHEAT SHEET ═══
function renderCheat(){
  const topic=gv('cheat-topic');
  const mk=(label,css,visual)=>`<div style="background:var(--bg2);border:1px solid var(--bdr);border-radius:10px;padding:14px;cursor:pointer" onclick="navigator.clipboard.writeText('${css.replace(/'/g,"\\'")}');toast('Copied')"><div style="margin-bottom:8px">${visual}</div><div style="font-family:var(--mono);font-size:11px;color:var(--acc);font-weight:600">${label}</div><div style="font-family:var(--mono);font-size:10px;color:var(--t4);margin-top:2px">${css}</div></div>`;
  const box=(jc,ai,extra)=>{const items=Array(3).fill(0).map((_,i)=>`<div style="width:20px;height:20px;background:var(--acc);border-radius:3px;opacity:${0.5+i*0.2}"></div>`).join('');return`<div style="display:flex;justify-content:${jc};align-items:${ai};gap:4px;height:50px;background:var(--bg3);border-radius:6px;padding:6px;${extra||''}">${items}</div>`};
  let html='';
  if(topic==='flex'){
    html=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
      ${mk('flex-start','justify-content: flex-start',box('flex-start','center'))}
      ${mk('center','justify-content: center',box('center','center'))}
      ${mk('flex-end','justify-content: flex-end',box('flex-end','center'))}
      ${mk('space-between','justify-content: space-between',box('space-between','center'))}
      ${mk('space-around','justify-content: space-around',box('space-around','center'))}
      ${mk('space-evenly','justify-content: space-evenly',box('space-evenly','center'))}
      ${mk('align start','align-items: flex-start',box('center','flex-start'))}
      ${mk('align center','align-items: center',box('center','center'))}
      ${mk('align end','align-items: flex-end',box('center','flex-end'))}
      ${mk('column','flex-direction: column',box('flex-start','flex-start','flex-direction:column;height:70px'))}
      ${mk('wrap','flex-wrap: wrap',`<div style="display:flex;flex-wrap:wrap;gap:3px;height:50px;background:var(--bg3);border-radius:6px;padding:6px">${Array(6).fill(0).map(()=>`<div style="width:18px;height:18px;background:var(--acc);border-radius:3px;opacity:.6"></div>`).join('')}</div>`)}
      ${mk('gap','gap: 12px',box('flex-start','center','gap:12px'))}
    </div>`;
  }else if(topic==='grid'){
    html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      ${mk('2 columns','grid-template-columns: 1fr 1fr',`<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;height:40px">${Array(4).fill(0).map(()=>`<div style="background:var(--acc);border-radius:3px;opacity:.5"></div>`).join('')}</div>`)}
      ${mk('3 columns','grid-template-columns: repeat(3, 1fr)',`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:3px;height:40px">${Array(6).fill(0).map(()=>`<div style="background:var(--acc);border-radius:3px;opacity:.5"></div>`).join('')}</div>`)}
      ${mk('auto-fill','grid-template-columns: repeat(auto-fill, minmax(80px, 1fr))',`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(30px,1fr));gap:3px;height:40px">${Array(5).fill(0).map(()=>`<div style="background:var(--cyan);border-radius:3px;opacity:.5"></div>`).join('')}</div>`)}
      ${mk('span 2','grid-column: span 2',`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:3px;height:50px"><div style="grid-column:span 2;background:var(--pink);border-radius:3px;opacity:.6"></div><div style="background:var(--acc);border-radius:3px;opacity:.4"></div><div style="background:var(--acc);border-radius:3px;opacity:.4"></div><div style="background:var(--acc);border-radius:3px;opacity:.4"></div></div>`)}
      ${mk('place center','place-items: center',`<div style="display:grid;place-items:center;height:50px;background:var(--bg3);border-radius:6px"><div style="width:24px;height:24px;background:var(--acc);border-radius:4px"></div></div>`)}
      ${mk('gap','gap: 16px',`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;height:40px">${Array(4).fill(0).map(()=>`<div style="background:var(--green);border-radius:3px;opacity:.4"></div>`).join('')}</div>`)}
    </div>`;
  }else if(topic==='position'){
    const posBox=(pos,extra)=>`<div style="position:relative;height:60px;background:var(--bg3);border-radius:6px;overflow:hidden"><div style="position:${pos};${extra}width:20px;height:20px;background:var(--acc);border-radius:3px"></div></div>`;
    html=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
      ${mk('static','position: static',posBox('static',''))}
      ${mk('relative','position: relative; top: 10px',posBox('relative','top:10px;left:10px;'))}
      ${mk('absolute','position: absolute; top: 0; right: 0',posBox('absolute','top:6px;right:6px;'))}
      ${mk('fixed','position: fixed',posBox('static','background:var(--pink);'))}
      ${mk('sticky','position: sticky; top: 0',posBox('static','background:var(--cyan);'))}
      ${mk('z-index','z-index: 10',`<div style="position:relative;height:60px;background:var(--bg3);border-radius:6px"><div style="position:absolute;top:8px;left:8px;width:24px;height:24px;background:var(--pink);border-radius:3px"></div><div style="position:absolute;top:16px;left:16px;width:24px;height:24px;background:var(--acc);border-radius:3px"></div></div>`)}
    </div>`;
  }else{
    html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      ${mk('block','display: block',`<div style="height:40px"><div style="background:var(--acc);height:16px;border-radius:3px;margin-bottom:3px;opacity:.5"></div><div style="background:var(--acc);height:16px;border-radius:3px;opacity:.5"></div></div>`)}
      ${mk('inline-block','display: inline-block',`<div style="height:40px"><span style="display:inline-block;width:40px;height:30px;background:var(--acc);border-radius:3px;opacity:.5;margin-right:4px"></span><span style="display:inline-block;width:40px;height:30px;background:var(--pink);border-radius:3px;opacity:.5"></span></div>`)}
      ${mk('flex','display: flex',box('flex-start','center'))}
      ${mk('grid','display: grid',`<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;height:40px">${Array(4).fill(0).map(()=>`<div style="background:var(--cyan);border-radius:3px;opacity:.4"></div>`).join('')}</div>`)}
      ${mk('none','display: none',`<div style="height:40px;display:flex;align-items:center;justify-content:center;color:var(--t4);font-size:11px">Element hidden</div>`)}
      ${mk('contents','display: contents',`<div style="height:40px;display:flex;align-items:center;gap:3px"><div style="width:16px;height:16px;background:var(--orange);border-radius:3px;opacity:.5"></div><div style="font-size:10px;color:var(--t4)">unwrapped</div></div>`)}
    </div>`;
  }
  document.getElementById('cheat-content').innerHTML=html;
}

// ═══ UNDO / REDO ═══
const _undoStack=[];
let _redoStack=[];
let _undoTimer=null;
function saveState(){
  clearTimeout(_undoTimer);
  _undoTimer=setTimeout(()=>{_saveStateNow();codeSyncToEditor()},300);
}
function _saveStateNow(){
  const page=document.querySelector('.dk-page');
  if(!page)return;
  const html=page.innerHTML;
  // Don't save if same as last state
  if(_undoStack.length&&_undoStack[_undoStack.length-1]===html)return;
  _undoStack.push(html);
  // Cap at 50 states
  if(_undoStack.length>50)_undoStack.shift();
  _redoStack=[];
  _updateUndoBtns();
}
function undo(){
  const page=document.querySelector('.dk-page');
  if(!page||_undoStack.length<2)return;
  _redoStack.push(_undoStack.pop());
  const prev=_undoStack[_undoStack.length-1];
  page.innerHTML=prev;
  // Reattach event listeners to all blocks
  page.querySelectorAll('.dk-block').forEach(b=>reattachBlock(b));
  clearSelection();
  _updateUndoBtns();
  if(window._updatePreviewSize)window._updatePreviewSize();
}
function redo(){
  const page=document.querySelector('.dk-page');
  if(!page||!_redoStack.length)return;
  const next=_redoStack.pop();
  _undoStack.push(next);
  page.innerHTML=next;
  page.querySelectorAll('.dk-block').forEach(b=>reattachBlock(b));
  clearSelection();
  _updateUndoBtns();
  if(window._updatePreviewSize)window._updatePreviewSize();
}
function _updateUndoBtns(){
  const u=document.getElementById('btn-undo');
  const r=document.getElementById('btn-redo');
  if(u)u.style.opacity=_undoStack.length>1?'1':'.3';
  if(r)r.style.opacity=_redoStack.length?'1':'.3';
}
// Keyboard shortcuts
document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();undo()}
  if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();redo()}
  if(e.key==='Delete'||e.key==='Backspace'){
    if(selectedEl&&!selectedEl.contains(document.activeElement)&&!document.querySelector('[data-editing="true"]')){e.preventDefault();delBlock()}
  }
});

// ═══ EFFECTS MODULE (direct-edit) ═══
function fxApply(){
  const blur=gv('fx-blur'),bright=gv('fx-bright'),contrast=gv('fx-contrast');
  const sat=gv('fx-sat'),hue=gv('fx-hue'),gray=gv('fx-gray');
  const sepia=gv('fx-sepia'),invert=gv('fx-invert');
  const rot=gv('fx-rot'),scl=gv('fx-scale'),skx=gv('fx-skewx'),sky=gv('fx-skewy');
  const blend=gv('fx-blend');
  // Update labels
  st('fx-blur-v',blur+'px');st('fx-bright-v',bright+'%');st('fx-contrast-v',contrast+'%');
  st('fx-sat-v',sat+'%');st('fx-hue-v',hue+'°');st('fx-gray-v',gray+'%');
  st('fx-sepia-v',sepia+'%');st('fx-invert-v',invert+'%');
  st('fx-rot-v',rot+'°');st('fx-scale-v',(scl/100).toFixed(1));
  st('fx-skewx-v',skx+'°');st('fx-skewy-v',sky+'°');
  if(!selectedEl)return;
  // Build filter string
  let f=[];
  if(blur!='0')f.push(`blur(${blur}px)`);
  if(bright!='100')f.push(`brightness(${bright}%)`);
  if(contrast!='100')f.push(`contrast(${contrast}%)`);
  if(sat!='100')f.push(`saturate(${sat}%)`);
  if(hue!='0')f.push(`hue-rotate(${hue}deg)`);
  if(gray!='0')f.push(`grayscale(${gray}%)`);
  if(sepia!='0')f.push(`sepia(${sepia}%)`);
  if(invert!='0')f.push(`invert(${invert}%)`);
  selectedEl.style.filter=f.length?f.join(' '):'none';
  // Transform - compose with rotation handle value
  let t=[];
  const handleRot=parseFloat(selectedEl.dataset.rot)||0;
  const totalRot=handleRot+(+rot);
  if(totalRot!==0)t.push(`rotate(${totalRot}deg)`);
  if(scl!='100')t.push(`scale(${scl/100})`);
  if(skx!='0')t.push(`skewX(${skx}deg)`);
  if(sky!='0')t.push(`skewY(${sky}deg)`);
  selectedEl.style.transform=t.length?t.join(' '):'';
  // Sync rotation input in toolbar
  const rotInput=document.getElementById('rot-input');
  if(rotInput)rotInput.value=Math.round(totalRot);
  // Blend
  selectedEl.style.mixBlendMode=blend;
  saveState();
}
function fxOverflow(btn){
  btn.parentNode.querySelectorAll('.tm-align').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(selectedEl)selectedEl.style.overflow=btn.dataset.v;
}
function fxPreset(p){
  if(!selectedEl)return;
  if(p==='glass'){
    selectedEl.style.background='rgba(255,255,255,0.08)';
    selectedEl.style.backdropFilter='blur(16px)';
    selectedEl.style.webkitBackdropFilter='blur(16px)';
    selectedEl.style.border='1px solid rgba(255,255,255,0.12)';
    selectedEl.style.boxShadow='0 8px 32px rgba(0,0,0,0.2)';
  }else if(p==='neumorph'){
    selectedEl.style.background='#1a1a2e';
    selectedEl.style.boxShadow='6px 6px 12px rgba(0,0,0,0.5), -6px -6px 12px rgba(60,60,100,0.15)';
    selectedEl.style.border='none';
  }else if(p==='inset'){
    selectedEl.style.boxShadow='inset 4px 4px 10px rgba(0,0,0,0.5), inset -4px -4px 10px rgba(60,60,100,0.1)';
  }else if(p==='glow'){
    selectedEl.style.boxShadow='0 0 20px rgba(168,85,247,0.5), 0 0 60px rgba(168,85,247,0.2)';
  }else if(p==='frost'){
    selectedEl.style.background='rgba(255,255,255,0.05)';
    selectedEl.style.backdropFilter='blur(24px) saturate(180%)';
    selectedEl.style.webkitBackdropFilter='blur(24px) saturate(180%)';
    selectedEl.style.border='1px solid rgba(255,255,255,0.08)';
  }else if(p==='reset'){
    selectedEl.style.filter='none';
    selectedEl.style.transform='none';
    selectedEl.style.mixBlendMode='normal';
    selectedEl.style.backdropFilter='none';
    selectedEl.style.webkitBackdropFilter='none';
    // Reset all sliders
    ['fx-blur','fx-gray','fx-sepia','fx-invert','fx-rot','fx-skewx','fx-skewy','fx-hue'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=0});
    ['fx-bright','fx-contrast','fx-sat','fx-scale'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=100});
    document.getElementById('fx-blend').value='normal';
    fxApply();
  }
}
function fxReadSelection(){
  if(!selectedEl)return;
  const cs=getComputedStyle(selectedEl);
  
  // Parse filter string
  const filter=cs.filter||'none';
  const pf=(name,def)=>{const m=filter.match(new RegExp(name+'\\(([\\d.]+)'));return m?parseFloat(m[1]):def};
  sv('fx-blur',pf('blur',0));
  sv('fx-bright',filter.includes('brightness')?pf('brightness',1)*100:100);
  sv('fx-contrast',filter.includes('contrast')?pf('contrast',1)*100:100);
  sv('fx-sat',filter.includes('saturate')?pf('saturate',1)*100:100);
  sv('fx-hue',pf('hue-rotate',0));
  sv('fx-gray',filter.includes('grayscale')?pf('grayscale',0)*100:0);
  sv('fx-sepia',filter.includes('sepia')?pf('sepia',0)*100:0);
  sv('fx-invert',filter.includes('invert')?pf('invert',0)*100:0);
  
  // Parse transform
  const tr=cs.transform||'none';
  let rot=0,scl=100,skx=0,sky=0;
  if(tr!=='none'){
    const m=tr.match(/matrix\(([^)]+)\)/);
    if(m){
      const v=m[1].split(',').map(Number);
      rot=Math.round(Math.atan2(v[1],v[0])*180/Math.PI);
      scl=Math.round(Math.sqrt(v[0]*v[0]+v[1]*v[1])*100);
    }
  }
  sv('fx-rot',rot);sv('fx-scale',scl);sv('fx-skewx',skx);sv('fx-skewy',sky);
  
  // Blend mode
  const blend=cs.mixBlendMode||'normal';
  sv('fx-blend',blend);
  
  // Update labels only (don't apply)
  st('fx-blur-v',gv('fx-blur')+'px');st('fx-bright-v',gv('fx-bright')+'%');
  st('fx-contrast-v',gv('fx-contrast')+'%');st('fx-sat-v',gv('fx-sat')+'%');
  st('fx-hue-v',gv('fx-hue')+'°');st('fx-gray-v',gv('fx-gray')+'%');
  st('fx-sepia-v',gv('fx-sepia')+'%');st('fx-invert-v',gv('fx-invert')+'%');
  st('fx-rot-v',gv('fx-rot')+'°');st('fx-scale-v',(gv('fx-scale')/100).toFixed(1));
  st('fx-skewx-v',gv('fx-skewx')+'°');st('fx-skewy-v',gv('fx-skewy')+'°');
}

// ═══ COLOR MODULE (direct-edit) ═══
let _cmGradType='linear',_cmBorderStyle='solid';
function cmApply(){
  const t=selectedEl;
  const bgEl=document.getElementById('cm-bg');
  const opEl=document.getElementById('cm-op');
  const radEl=document.getElementById('cm-rad');
  const blurEl=document.getElementById('cm-blur');
  const bg=bgEl?bgEl.value:'#1a1a2e';
  const op=opEl?+opEl.value:100;
  const rad=radEl?+radEl.value:8;
  const blur=blurEl?+blurEl.value:0;
  // Update labels (only if elements exist)
  const hexEl=document.getElementById('cm-bg-hex');if(hexEl)hexEl.value=bg;
  const radV=document.getElementById('cm-rad-v');if(radV)radV.textContent=rad+'px';
  const opV=document.getElementById('cm-op-v');if(opV)opV.textContent=(op/100).toFixed(2);
  const blurV=document.getElementById('cm-blur-v');if(blurV)blurV.textContent=blur+'px';
  const bwV=document.getElementById('cm-border-w-v');const bwEl=document.getElementById('cm-border-w');
  if(bwV&&bwEl)bwV.textContent=bwEl.value+'px';
  if(!t){
    const page=document.querySelector('.dk-page');
    if(page){
      if(document.getElementById('cm-grad-on')?.checked){
        const c1=gv('cm-grad-c1'),c2=gv('cm-grad-c2'),angle=gv('cm-grad-angle');
        if(_cmGradType==='linear')page.style.background=`linear-gradient(${angle}deg,${c1},${c2})`;
        else if(_cmGradType==='radial')page.style.background=`radial-gradient(circle,${c1},${c2})`;
        else page.style.background=`conic-gradient(from ${angle}deg,${c1},${c2})`;
      }else{
        page.style.background=bg;
      }
      // Propagate to parent containers so no dark gaps
      const vp=page.closest('.lp-viewport')||document.getElementById('lp-viewport');
      if(vp)vp.style.background=page.style.background;
      const sizer=document.getElementById('lp-sizer');
      if(sizer)sizer.style.background=page.style.background;
      const pbd=page.closest('.wbody');
      if(pbd)pbd.style.background=page.style.background;
      document.getElementById('lp-bgc').value=bg;
      saveState();
    }
    return;
  }
  // Background - target shape fill if present
  const shapeFill=t.querySelector('.dk-shape-fill');
  const bgTarget=shapeFill||t;
  if(document.getElementById('cm-grad-on')?.checked){
    const c1=gv('cm-grad-c1'),c2=gv('cm-grad-c2'),angle=gv('cm-grad-angle');
    if(_cmGradType==='linear')bgTarget.style.background=`linear-gradient(${angle}deg,${c1},${c2})`;
    else if(_cmGradType==='radial')bgTarget.style.background=`radial-gradient(circle,${c1},${c2})`;
    else bgTarget.style.background=`conic-gradient(from ${angle}deg,${c1},${c2})`;
  }else{
    bgTarget.style.background=bg;
  }
  // Border (from Style tab)
  const borderOn=document.getElementById('cm-border-on');
  if(borderOn){
    if(borderOn.checked){
      t.style.border=`${gv('cm-border-w')}px ${_cmBorderStyle} ${gv('cm-border-c')}`;
    }else{
      t.style.border='none';
    }
  }
  if(radEl)t.style.borderRadius=rad+'px';
  if(opEl)t.style.opacity=op/100;
  // Shadow (from Style tab)
  const shadOn=document.getElementById('cm-shad-on');
  if(shadOn){
    if(shadOn.checked){
      const sx=gv('cm-shad-x'),sy=gv('cm-shad-y'),sb=gv('cm-shad-blur'),ss=gv('cm-shad-spread'),sc=gv('cm-shad-c');
      t.style.boxShadow=`${sx}px ${sy}px ${sb}px ${ss}px ${sc}`;
    }else{
      t.style.boxShadow='none';
    }
  }
  // Backdrop blur (from Style tab)
  if(blurEl){
    t.style.backdropFilter=blur>0?`blur(${blur}px)`:'none';
    t.style.webkitBackdropFilter=blur>0?`blur(${blur}px)`:'none';
  }
  saveState();
}
function cmSetBg(c){document.getElementById('cm-bg').value=c;document.getElementById('cm-bg-hex').value=c;cmApply()}
function cmClearBg(){if(selectedEl)selectedEl.style.background='transparent';document.getElementById('cm-bg').value='#000000';document.getElementById('cm-bg-hex').value='transparent'}
function cmGradType(btn){btn.parentNode.querySelectorAll('.tm-align').forEach(b=>b.classList.remove('active'));btn.classList.add('active');_cmGradType=btn.dataset.v;cmApply()}
function cmBorderStyle(btn){btn.parentNode.querySelectorAll('.tm-align').forEach(b=>b.classList.remove('active'));btn.classList.add('active');_cmBorderStyle=btn.dataset.v;cmApply()}
function cmReadSelection(){
  const t=selectedEl;
  if(!t)return;
  const shapeFill=t.querySelector('.dk-shape-fill');
  const bgSrc=shapeFill||t;
  const cs=getComputedStyle(bgSrc);
  // Read bg color
  const bgc=bgSrc.style.backgroundColor||cs.backgroundColor;
  if(bgc&&bgc!=='transparent'){
    const d=document.createElement('div');d.style.color=bgc;document.body.appendChild(d);
    const computed=getComputedStyle(d).color;document.body.removeChild(d);
    const m=computed.match(/(\d+)/g);
    if(m&&m.length>=3){
      const hex='#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join('');
      document.getElementById('cm-bg').value=hex;document.getElementById('cm-bg-hex').value=hex;
    }
  }
  const rad=parseInt(cs.borderRadius)||0;
  document.getElementById('cm-rad').value=Math.min(rad,100);document.getElementById('cm-rad-v').textContent=rad+'px';
  const op=parseFloat(cs.opacity);
  if(!isNaN(op)){document.getElementById('cm-op').value=Math.round(op*100);document.getElementById('cm-op-v').textContent=op.toFixed(2)}
}

// ═══ TEXT MODULE (direct-edit) ═══
function tmGetTarget(){
  if(!selectedEl)return null;
  // Target the .dk-text span if present, otherwise the block itself
  return selectedEl.querySelector('.dk-text')||selectedEl;
}
function tmApply(){
  const t=tmGetTarget();
  const fontRaw=gv('tm-font');
  const isSerif=['Playfair Display','Libre Baskerville','Lora','Crimson Pro'].includes(fontRaw);
  const isMono=['Source Code Pro','JetBrains Mono'].includes(fontRaw);
  const fallback=isMono?'monospace':isSerif?'serif':'sans-serif';
  const font=`'${fontRaw}',${fallback}`;
  const size=gv('tm-size');
  const weight=gv('tm-weight');
  const lh=(gv('tm-lh')/10).toFixed(1);
  const ls=gv('tm-ls');
  const color=gv('tm-color');
  const op=gv('tm-op');
  // Update labels
  document.getElementById('tm-size-v').textContent=size+'px';
  document.getElementById('tm-lh-v').textContent=lh;
  document.getElementById('tm-ls-v').textContent=ls+'px';
  document.getElementById('tm-op-v').textContent=(op/100).toFixed(2);
  document.getElementById('tm-color-hex').value=color;
  // Load font
  const link=document.getElementById('tm-gfont')||document.createElement('link');
  link.id='tm-gfont';link.rel='stylesheet';
  link.href=`https://fonts.googleapis.com/css2?family=${fontRaw.replace(/ /g,'+')}:wght@300;400;500;600;700;800;900&display=swap`;
  if(!document.getElementById('tm-gfont'))document.head.appendChild(link);
  if(!t)return;
  t.style.fontFamily=font;
  t.style.fontSize=size+'px';
  t.style.fontWeight=weight;
  t.style.lineHeight=lh;
  t.style.letterSpacing=ls+'px';
  t.style.opacity=op/100;
  // Gradient - apply to the text span directly
  const gradOn=document.getElementById('tm-grad-on');
  if(gradOn&&gradOn.checked){
    const c1=gv('tm-grad-c1'),c2=gv('tm-grad-c2'),angle=gv('tm-grad-angle');
    t.style.color='transparent';
    t.style.background=`linear-gradient(${angle}deg,${c1},${c2})`;
    t.style.webkitBackgroundClip='text';
    t.style.webkitTextFillColor='transparent';
    t.style.backgroundClip='text';
    t.dataset.textgrad='1';
  }else{
    t.style.color=color;
    if(t.dataset.textgrad==='1'){
      t.style.background='';
      t.style.webkitBackgroundClip='';
      t.style.webkitTextFillColor='';
      t.style.backgroundClip='';
      delete t.dataset.textgrad;
    }
  }
  // Shadow
  if(document.getElementById('tm-shad-on').checked){
    const blur=gv('tm-shad-blur'),sc=gv('tm-shad-color');
    t.style.textShadow=`0 0 ${blur}px ${sc}`;
  }else{
    t.style.textShadow='';
  }
}
function tmAlign(btn){
  btn.parentNode.querySelectorAll('.tm-align').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const t=tmGetTarget();
  if(t)t.style.textAlign=btn.dataset.v;
}
function tmTransform(btn){
  btn.parentNode.querySelectorAll('.tm-align').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const t=tmGetTarget();
  if(t)t.style.textTransform=btn.dataset.v;
}
function tmSetColor(c){
  document.getElementById('tm-color').value=c.startsWith('#')?c:'#f0f0f5';
  document.getElementById('tm-color-hex').value=c;
  tmApply();
}
function tmReadSelection(){
  // Read current styles from selected element into the controls
  const t=tmGetTarget();
  if(!t)return;
  const cs=window.getComputedStyle?getComputedStyle(t):t.style;
  const sz=parseInt(cs.fontSize)||16;
  document.getElementById('tm-size').value=sz;
  document.getElementById('tm-size-v').textContent=sz+'px';
  const w=cs.fontWeight||'400';
  document.getElementById('tm-weight').value=w;
  const lh=parseFloat(cs.lineHeight)/parseFloat(cs.fontSize);
  if(!isNaN(lh)){document.getElementById('tm-lh').value=Math.round(lh*10);document.getElementById('tm-lh-v').textContent=lh.toFixed(1)}
  const ls=parseInt(cs.letterSpacing)||0;
  document.getElementById('tm-ls').value=ls;document.getElementById('tm-ls-v').textContent=ls+'px';
  // Color - try to read as hex
  const rawColor=t.style.color||cs.color;
  if(rawColor){
    const d=document.createElement('div');d.style.color=rawColor;document.body.appendChild(d);
    const computed=getComputedStyle(d).color;document.body.removeChild(d);
    const m=computed.match(/(\d+)/g);
    if(m&&m.length>=3){
      const hex='#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join('');
      document.getElementById('tm-color').value=hex;
      document.getElementById('tm-color-hex').value=hex;
    }
  }
  // Detect text gradient
  const gradCb=document.getElementById('tm-grad-on');
  if(gradCb)gradCb.checked=t.dataset.textgrad==='1';
}

// ═══ PAGE BUILDER ═══
let selectedEl=null;
let blockId=0;
let drawMode='select'; // select | draw | text
let snapGrid=true;
let _blockDrag=null;
let _blockResize=null;
let _blockRotate=null;
let _drawing=null;
const SNAP=10;

function snap(v){return snapGrid?Math.round(v/SNAP)*SNAP:v}

function getLPVars(){
  return{
    primary:gv('lp-primary'),secondary:gv('lp-secondary'),accent:gv('lp-accent'),
    bg:gv('lp-bgc'),surface:gv('lp-surface'),text:gv('lp-text'),
    headfont:gv('lp-headfont'),bodyfont:gv('lp-bodyfont'),
    radius:gv('lp-radius')+'px'
  };
}

function updateLP(){
  const vp=document.getElementById('lp-viewport');
  if(!vp)return;
  const page=vp.querySelector('.dk-page');
  if(!page)return;
  const v=getLPVars();
  page.style.fontFamily=v.bodyfont;
  page.style.backgroundColor=v.bg;
  page.style.color=v.text;
  // Also propagate bg to viewport and sizer so no dark gaps show
  vp.style.backgroundColor=v.bg;
  const sizer=vp.closest('#lp-sizer')||document.getElementById('lp-sizer');
  if(sizer)sizer.style.backgroundColor=v.bg;
  const bd=vp.closest('.wbody');
  if(bd)bd.style.backgroundColor=v.bg;
  Object.entries({'--p':v.primary,'--s':v.secondary,'--a':v.accent,'--bg':v.bg,'--sf':v.surface,'--t':v.text,'--hf':v.headfont,'--bf':v.bodyfont,'--r':v.radius}).forEach(([k,val])=>page.style.setProperty(k,val));
}

// ═══ MODE SWITCHING ═══
function setMode(mode){
  drawMode=mode;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.toggle('active',b.dataset.mode===mode));
  const page=document.querySelector('.dk-page');
  if(page){page.classList.remove('mode-select','mode-draw','mode-text');page.classList.add('mode-'+mode)}
}
function toggleSnap(){
  snapGrid=!snapGrid;
  document.getElementById('snap-btn').textContent='Grid: '+(snapGrid?'ON':'OFF');
}

// ═══ SELECTION ═══
function selectBlock(el,e){
  if(e)e.stopPropagation();
  // Exit edit mode on previously selected
  if(selectedEl&&selectedEl!==el){
    selectedEl.classList.remove('selected');
    selectedEl.dataset.editing='false';
    const oldTxt=selectedEl.querySelector('.dk-text');
    if(oldTxt)oldTxt.blur();
  }
  selectedEl=el;
  const typeSelect=document.getElementById('sel-type');
  if(el){
    el.classList.add('selected');
    const label=el.dataset.label||'element';
    const w=Math.round(el.offsetWidth),h=Math.round(el.offsetHeight);
    document.getElementById('sel-info').textContent='';
    document.getElementById('sel-dims').textContent=w+'×'+h;
    const db=document.getElementById('desel-btn');if(db)db.style.display='';
    // Show type selector
    if(typeSelect){typeSelect.style.display='inline-block';typeSelect.value=label}
    // Update rotation input
    const rotInput=document.getElementById('rot-input');
    if(rotInput)rotInput.value=Math.round(parseFloat(el.dataset.rot)||0);
    // Update text module if open
    if(typeof tmReadSelection==='function')try{tmReadSelection()}catch(e){}
    if(typeof cmReadSelection==='function')try{cmReadSelection()}catch(e){}
    if(typeof fxReadSelection==='function')try{fxReadSelection()}catch(e){}
    if(typeof alReadSelection==='function')try{alReadSelection()}catch(e){}
    if(typeof pmReadSelection==='function')try{pmReadSelection()}catch(e){}
  }else{
    document.getElementById('sel-info').textContent='No selection';
    document.getElementById('sel-dims').textContent='';
    const db=document.getElementById('desel-btn');if(db)db.style.display='none';
    if(typeSelect)typeSelect.style.display='none';
  }
}
function clearSelection(){
  if(selectedEl){
    selectedEl.classList.remove('selected');
    selectedEl.dataset.editing='false';
    const txt=selectedEl.querySelector('.dk-text');
    if(txt)txt.blur();
  }
  selectedEl=null;
  window.getSelection().removeAllRanges();
  document.getElementById('sel-info').textContent='No selection';
  document.getElementById('sel-dims').textContent='';
  const typeSelect=document.getElementById('sel-type');
  if(typeSelect)typeSelect.style.display='none';
  const db=document.getElementById('desel-btn');if(db)db.style.display='none';
}

// ═══ RETYPE BLOCK ═══
function reTypeBlock(newType){
  if(!selectedEl)return;
  const old=selectedEl.dataset.type;
  selectedEl.dataset.type=newType;
  selectedEl.dataset.label=newType;
  const v=getLPVars();
  // Apply role-specific visual defaults (preserves position/size)
  const keep=['position','left','top','width','height','z-index','transform','animation','animation-play-state','animation-delay'];
  const preserved={};
  keep.forEach(p=>{const val=selectedEl.style.getPropertyValue(p);if(val)preserved[p]=val});
  // Type-specific styling
  const styles={
    frame:{background:v.surface,border:'1px solid rgba(255,255,255,.06)','border-radius':v.radius},
    heading:{'font-family':'var(--hf)','font-size':'32px','font-weight':'800','letter-spacing':'-.5px',color:v.text,overflow:'hidden',padding:'4px'},
    text:{'font-size':'16px','line-height':'1.6',color:v.text,overflow:'hidden',padding:'4px'},
    button:{background:'linear-gradient(135deg,var(--p),var(--s))',color:'#fff',border:'none','border-radius':v.radius,'font-size':'15px','font-weight':'600',display:'flex','align-items':'center','justify-content':'center',cursor:'pointer'},
    link:{'font-size':'14px',color:'var(--p)','text-decoration':'underline',overflow:'hidden',padding:'4px',cursor:'pointer'},
    image:{background:'linear-gradient(135deg,rgba(168,85,247,.15),rgba(236,72,153,.1))',border:'1px dashed rgba(255,255,255,.1)','border-radius':v.radius,display:'flex','align-items':'center','justify-content':'center','font-size':'11px',color:'rgba(255,255,255,.25)'},
    input:{background:'rgba(255,255,255,.04)',border:'1px solid rgba(255,255,255,.1)','border-radius':v.radius,padding:'8px 12px','font-size':'14px',color:'rgba(255,255,255,.4)',display:'flex','align-items':'center'},
    icon:{display:'flex','align-items':'center','justify-content':'center'},
    nav:{background:'rgba(255,255,255,.03)','backdrop-filter':'blur(12px)',display:'flex','align-items':'center',padding:'0 24px'},
    section:{background:'transparent',padding:'40px'},
    card:{background:v.surface,'border-radius':'16px',border:'1px solid rgba(255,255,255,.06)',overflow:'hidden'},
    badge:{background:'var(--p)',color:'#fff','border-radius':'20px',padding:'4px 12px','font-size':'11px','font-weight':'700',display:'inline-flex','align-items':'center','justify-content':'center'},
    divider:{background:'rgba(255,255,255,.08)','border-radius':'1px'},
    video:{background:'linear-gradient(135deg,rgba(59,130,246,.15),rgba(168,85,247,.1))',border:'1px dashed rgba(255,255,255,.1)','border-radius':v.radius,display:'flex','align-items':'center','justify-content':'center','font-size':'24px',color:'rgba(255,255,255,.2)'}
  };
  const s=styles[newType];
  if(s){
    // Clear existing visual styles but keep position/animation
    const cssText=keep.map(p=>preserved[p]?`${p}:${preserved[p]}`:'').filter(Boolean).join(';');
    selectedEl.style.cssText=cssText+';';
    Object.entries(s).forEach(([p,val])=>selectedEl.style.setProperty(p,val));
  }
  // Handle content changes
  const txt=selectedEl.querySelector('.dk-text');
  const needsText=['heading','text','button','link','icon','badge'].includes(newType);
  const hadText=!!txt;
  if(needsText&&!hadText){
    const defaults={heading:'Heading',text:'Type here...',button:'Button',link:'Link text',icon:'★',badge:'Badge'};
    const span=document.createElement('span');
    span.className='dk-text';
    span.textContent=defaults[newType]||newType;
    span.setAttribute('contenteditable','true');
    span.style.cssText='display:block;width:100%;height:100%;outline:none;cursor:inherit;-webkit-user-select:text;user-select:text;overflow:hidden;';
    span.addEventListener('keydown',e=>{if(e.key==='Enter')e.preventDefault()});
    // Clear non-handle children
    [...selectedEl.childNodes].forEach(n=>{if(!n.classList||!n.classList.contains('dk-handle'))n.remove()});
    selectedEl.insertBefore(span,selectedEl.firstChild);
  }else if(!needsText&&hadText){
    txt.remove();
  }
  // Special content for non-text types
  if(newType==='image'){
    if(!txt)[...selectedEl.childNodes].forEach(n=>{if(!n.classList||!n.classList.contains('dk-handle'))n.remove()});
    if(!selectedEl.querySelector('.dk-handle~*'))selectedEl.insertBefore(document.createTextNode('Image'),selectedEl.querySelector('.dk-handle'));
  }else if(newType==='video'){
    if(!txt)[...selectedEl.childNodes].forEach(n=>{if(!n.classList||!n.classList.contains('dk-handle'))n.remove()});
    selectedEl.insertBefore(document.createTextNode('▶'),selectedEl.querySelector('.dk-handle'));
  }else if(newType==='divider'){
    if(txt)txt.remove();
    if(selectedEl.offsetHeight>8)selectedEl.style.height='2px';
  }
  saveState();
}

// ═══ CREATE BLOCK ═══
function createBlock(x,y,w,h,role){
  const page=document.querySelector('.dk-page');
  if(!page)return null;
  // Calculate next z-index (higher than all existing blocks)
  let maxZ=0;
  page.querySelectorAll('.dk-block').forEach(b=>{
    const z=parseInt(b.style.zIndex)||0;
    if(z>maxZ)maxZ=z;
  });
  const el=document.createElement('div');
  el.classList.add('dk-block');
  el.dataset.bid=++blockId;
  el.dataset.label=role;
  el.dataset.type=role;
  
  // Base positioning - include z-index
  const baseStyle=`position:absolute;left:${snap(x)}px;top:${snap(y)}px;width:${Math.max(20,snap(w))}px;height:${Math.max(20,snap(h))}px;z-index:${maxZ+1};`;
  
  // Role-specific defaults
  const v=getLPVars();
  const roles={
    frame:`${baseStyle}background:${v.surface};border:1px solid rgba(255,255,255,.06);border-radius:${v.radius};`,
    text:`${baseStyle}font-size:16px;line-height:1.6;color:${v.text};overflow:hidden;padding:4px;`,
    heading:`${baseStyle}font-family:var(--hf);font-size:32px;font-weight:800;letter-spacing:-.5px;color:${v.text};overflow:hidden;padding:4px;`,
    button:`${baseStyle}background:linear-gradient(135deg,var(--p),var(--s));color:#fff;border:none;border-radius:${v.radius};font-size:15px;font-weight:600;display:flex;align-items:center;justify-content:center;cursor:pointer;`,
    image:`${baseStyle}background:linear-gradient(135deg,rgba(168,85,247,.15),rgba(236,72,153,.1));border:1px dashed rgba(255,255,255,.1);border-radius:${v.radius};display:flex;align-items:center;justify-content:center;font-size:11px;color:rgba(255,255,255,.25);`,
    link:`${baseStyle}font-size:14px;color:var(--p);text-decoration:underline;overflow:hidden;padding:4px;cursor:pointer;`,
    input:`${baseStyle}background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:${v.radius};padding:8px 12px;font-size:14px;color:rgba(255,255,255,.4);display:flex;align-items:center;`,
    icon:`${baseStyle}display:flex;align-items:center;justify-content:center;font-size:${Math.min(w,h)*0.6}px;`
  };
  
  el.setAttribute('style',roles[role]||roles.frame);
  
  // Default content
  const textRoles={text:'Type here...',heading:'Heading',button:'Button',link:'Link text',input:'Placeholder...',icon:'★'};
  const isEditable=textRoles[role]&&role!=='input';
  if(textRoles[role]){
    if(isEditable){
      // Create inner text span so contenteditable doesn't conflict with resize handles
      const txt=document.createElement('span');
      txt.className='dk-text';
      txt.textContent=textRoles[role];
      txt.setAttribute('contenteditable','true');
      txt.style.cssText='display:block;width:100%;height:100%;outline:none;cursor:inherit;-webkit-user-select:text;user-select:text;overflow:hidden;';
      txt.addEventListener('keydown',e=>{if(e.key==='Enter')e.preventDefault()});
      el.appendChild(txt);
    }else{
      el.textContent=textRoles[role];
    }
  }
  if(role==='image')el.textContent='Image';
  
  // Add resize handles
  ['nw','ne','sw','se'].forEach(pos=>{
    const handle=document.createElement('div');
    handle.className='dk-handle '+pos;
    handle.addEventListener('pointerdown',e=>{startResize(e,el,pos)});
    el.appendChild(handle);
  });
  // Add rotation handle
  const rotHandle=document.createElement('div');
  rotHandle.className='dk-handle rot';
  rotHandle.addEventListener('pointerdown',e=>{startRotate(e,el)});
  el.appendChild(rotHandle);
  
  // Pointerdown for select + drag
  el.addEventListener('pointerdown',e=>{
    if(e.target.classList.contains('dk-handle'))return;
    if(drawMode!=='select'&&drawMode!=='text')return;
    e.stopPropagation();
    // If already editing this element, let browser handle text cursor
    if(el.dataset.editing==='true')return;
    selectBlock(el,e);
    // Start drag
    const page=el.closest('.dk-page');
    const scale=parseFloat(page?.parentElement?.style.transform?.match(/scale\(([^)]+)\)/)?.[1])||1;
    _blockDrag={el,startX:e.clientX,startY:e.clientY,origLeft:el.offsetLeft,origTop:el.offsetTop,scale};
    // Only prevent default and capture if not a text block (so dblclick can fire for editing)
    const hasText=el.querySelector('.dk-text');
    if(!hasText)e.preventDefault();
    const bd=page.closest('.wbody');
    if(bd)bd.setPointerCapture(e.pointerId);
  });
  // Double click to enter text edit mode
  const txtSpan=el.querySelector('.dk-text');
  if(txtSpan){
    el.addEventListener('dblclick',e=>{
      e.stopPropagation();
      _blockDrag=null;
      el.dataset.editing='true';
      txtSpan.focus();
      // Select all text
      const range=document.createRange();
      range.selectNodeContents(txtSpan);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
    });
    txtSpan.addEventListener('blur',()=>{el.dataset.editing='false'});
    txtSpan.addEventListener('mousedown',e=>{
      // If already in edit mode, let the cursor position normally
      if(el.dataset.editing==='true')e.stopPropagation();
    });
  }
  
  page.appendChild(el);
  if(window._updatePreviewSize)setTimeout(window._updatePreviewSize,50);
  saveState();
  return el;
}

// ═══ BLOCK DRAGGING ═══
function onBlockDragMove(e){
  if(!_blockDrag)return;
  const d=_blockDrag;
  const dx=(e.clientX-d.startX)/d.scale;
  const dy=(e.clientY-d.startY)/d.scale;
  let newLeft=snap(d.origLeft+dx);
  let newTop=snap(d.origTop+dy);
  // Clamp block to page bounds (cursor can be anywhere)
  const clampedLeft=Math.max(0,Math.min(newLeft,getPageW()-d.el.offsetWidth));
  const clampedTop=Math.max(0,newTop);
  d.el.style.left=clampedLeft+'px';
  d.el.style.top=clampedTop+'px';
  document.getElementById('sel-dims').textContent=Math.round(d.el.offsetWidth)+'×'+Math.round(d.el.offsetHeight)+' @ '+clampedLeft+','+clampedTop;
  // Expand page if block goes past bottom
  const bot=clampedTop+d.el.offsetHeight+40;
  const page=d.el.closest('.dk-page');
  if(page&&bot>parseInt(page.style.minHeight||900)){
    page.style.setProperty('min-height',bot+'px','important');page.style.setProperty('height',bot+'px','important');
    if(window._updatePreviewSize)window._updatePreviewSize();
  }
}
function onBlockDragEnd(e){
  if(_blockDrag){
    const bd=_blockDrag.el.closest('.wbody');
    if(bd&&e?.pointerId)try{bd.releasePointerCapture(e.pointerId)}catch(x){}
  }
  _blockDrag=null;if(window._updatePreviewSize)window._updatePreviewSize();
  saveState();
}

// ═══ BLOCK RESIZING ═══
function startResize(e,el,corner){
  e.preventDefault();e.stopPropagation();
  const page=document.querySelector('.dk-page');
  const scale=parseFloat(page?.parentElement?.style.transform?.match(/scale\(([^)]+)\)/)?.[1])||1;
  _blockResize={el,corner,startX:e.clientX,startY:e.clientY,origLeft:el.offsetLeft,origTop:el.offsetTop,origW:el.offsetWidth,origH:el.offsetHeight,scale};
  const bd=page.closest('.wbody');
  if(bd&&e.pointerId)bd.setPointerCapture(e.pointerId);
}
function onResizeMove(e){
  if(!_blockResize)return;
  const r=_blockResize;
  const dx=(e.clientX-r.startX)/r.scale;
  const dy=(e.clientY-r.startY)/r.scale;
  let l=r.origLeft,t=r.origTop,w=r.origW,h=r.origH;
  if(r.corner.includes('e'))w=Math.max(20,r.origW+dx);
  if(r.corner.includes('w')){w=Math.max(20,r.origW-dx);l=r.origLeft+dx}
  if(r.corner.includes('s'))h=Math.max(20,r.origH+dy);
  if(r.corner.includes('n')){h=Math.max(20,r.origH-dy);t=r.origTop+dy}
  // Clamp to page bounds (cursor can be anywhere)
  if(l<0){w+=l;l=0}
  if(t<0){h+=t;t=0}
  const _pw=getPageW();if(l+w>_pw)w=_pw-l;
  w=Math.max(20,w);h=Math.max(20,h);
  r.el.style.left=snap(l)+'px';r.el.style.top=snap(t)+'px';
  r.el.style.width=snap(w)+'px';r.el.style.height=snap(h)+'px';
  document.getElementById('sel-dims').textContent=Math.round(w)+'×'+Math.round(h);
  const bot=snap(t)+snap(h)+40;
  const page=r.el.closest('.dk-page');
  if(page&&bot>parseInt(page.style.minHeight||900)){
    page.style.setProperty('min-height',bot+'px','important');page.style.setProperty('height',bot+'px','important');
    if(window._updatePreviewSize)window._updatePreviewSize();
  }
}
function onResizeEnd(e){
  if(_blockResize){
    const bd=_blockResize.el.closest('.wbody');
    if(bd&&e?.pointerId)try{bd.releasePointerCapture(e.pointerId)}catch(x){}
  }
  _blockResize=null;if(window._updatePreviewSize)window._updatePreviewSize();
  saveState();
}

// ═══ ROTATION ═══
function startRotate(e,el){
  e.preventDefault();e.stopPropagation();
  const rect=el.getBoundingClientRect();
  const cx=rect.left+rect.width/2;
  const cy=rect.top+rect.height/2;
  const currentRot=parseFloat(el.dataset.rot)||0;
  const startAngle=Math.atan2(e.clientY-cy,e.clientX-cx)*180/Math.PI;
  _blockRotate={el,cx,cy,startAngle,origRot:currentRot};
  const page=document.querySelector('.dk-page');
  const bd=page?.closest('.wbody');
  if(bd&&e.pointerId)bd.setPointerCapture(e.pointerId);
}
function onRotateMove(e){
  if(!_blockRotate)return;
  const r=_blockRotate;
  const angle=Math.atan2(e.clientY-r.cy,e.clientX-r.cx)*180/Math.PI;
  let deg=r.origRot+(angle-r.startAngle);
  // Snap to 15° increments when holding shift
  if(e.shiftKey)deg=Math.round(deg/15)*15;
  r.el.dataset.rot=deg;
  r.el.style.transform=`rotate(${deg}deg)`;
  const rotInput=document.getElementById('rot-input');
  if(rotInput)rotInput.value=Math.round(deg);
}
function onRotateEnd(e){
  if(_blockRotate){
    const bd=_blockRotate.el.closest('.wbody');
    if(bd&&e?.pointerId)try{bd.releasePointerCapture(e.pointerId)}catch(x){}
  }
  _blockRotate=null;
  saveState();
}
function setBlockRotation(deg){
  if(!selectedEl)return;
  selectedEl.dataset.rot=deg;
  selectedEl.style.transform=`rotate(${deg}deg)`;
  saveState();
}

// ═══ DRAWING ON CANVAS ═══
function initDrawing(page,bd){
  
  // Apple Pencil: treat pen input as select unless explicitly in draw mode
  page.addEventListener('pointerdown',e=>{
    // In select mode, pencil should act as a finger — select/drag blocks
    if(drawMode==='select'){
      // Prevent iPadOS from hijacking pencil for drawing/scribble
      if(e.pointerType==='pen')e.preventDefault();
      return;
    }
    // In draw mode, allow starting on blocks too (to draw on top)
    if(drawMode==='draw'){
      // Only block if clicking a resize handle
      if(e.target.classList.contains('dk-handle'))return;
    }else{
      if(e.target!==page&&!e.target.classList.contains('dk-page'))return;
    }
    e.preventDefault();
    
    const rect=page.getBoundingClientRect();
    const scale=parseFloat(page.parentElement.style.transform?.match(/scale\(([^)]+)\)/)?.[1])||1;
    const x=(e.clientX-rect.left)/scale;
    const y=(e.clientY-rect.top)/scale;
    
    if(drawMode==='text'){
      const el=createBlock(x-50,y-12,200,30,'text');
      if(el){
        selectBlock(el);
        setMode('select');
        el.dataset.editing='true';
        const txt=el.querySelector('.dk-text');
        if(txt)setTimeout(()=>{txt.focus();const range=document.createRange();range.selectNodeContents(txt);window.getSelection().removeAllRanges();window.getSelection().addRange(range)},80);
      }
      return;
    }
    
    // Draw mode — start rect
    const drawRect=document.createElement('div');
    drawRect.className='dk-drawrect';
    drawRect.style.left=x+'px';drawRect.style.top=y+'px';
    drawRect.style.width='0px';drawRect.style.height='0px';
    page.appendChild(drawRect);
    _drawing={startX:x,startY:y,rect:drawRect,scale,page};
    // Capture pointer on wbody so draw continues outside
    if(bd)bd.setPointerCapture(e.pointerId);
    _drawing.pointerId=e.pointerId;
    _drawing.bd=bd;
  });
  
  // Click on empty page = deselect
  page.addEventListener('click',e=>{
    if(drawMode==='select'&&!e.target.closest('.dk-block'))clearSelection();
  });
  // Touch: tap on page = deselect (any tap not on a block)
  page.addEventListener('touchend',e=>{
    if(drawMode!=='select')return;
    if(e.changedTouches.length!==1)return;
    const t=e.changedTouches[0];
    const el=document.elementFromPoint(t.clientX,t.clientY);
    if(el&&!el.closest('.dk-block'))clearSelection();
  },{passive:true});
}

// ═══ Z-ORDER ═══
function moveZ(dir){
  if(!selectedEl)return;
  const page=selectedEl.closest('.dk-page');
  if(!page)return;
  const blocks=page.querySelectorAll('.dk-block');
  if(dir>0){
    // Bring to front - higher than all others
    let maxZ=0;
    blocks.forEach(b=>{const z=parseInt(b.style.zIndex)||0;if(z>maxZ)maxZ=z});
    selectedEl.style.zIndex=maxZ+1;
  }else{
    // Send to back - lower than all others
    let minZ=Infinity;
    blocks.forEach(b=>{const z=parseInt(b.style.zIndex)||0;if(z<minZ)minZ=z});
    selectedEl.style.zIndex=Math.max(0,minZ-1);
  }
  saveState();
}

// ═══ DUPLICATION & DELETION ═══
function dupBlock(){
  if(!selectedEl)return;
  const clone=selectedEl.cloneNode(true);
  clone.dataset.bid=++blockId;
  clone.classList.remove('selected');
  // Offset position
  clone.style.left=(parseInt(clone.style.left)||0)+20+'px';
  clone.style.top=(parseInt(clone.style.top)||0)+20+'px';
  // Put on top
  const page=selectedEl.closest('.dk-page');
  let maxZ=0;
  if(page)page.querySelectorAll('.dk-block').forEach(b=>{const z=parseInt(b.style.zIndex)||0;if(z>maxZ)maxZ=z});
  clone.style.zIndex=maxZ+1;
  clone.style.top=(parseInt(clone.style.top)||0)+20+'px';
  // Reattach events
  reattachBlock(clone);
  selectedEl.parentNode.appendChild(clone);
  selectBlock(clone);
}
function reattachBlock(el){
  // Resize handles
  el.querySelectorAll('.dk-handle').forEach(h=>{
    const pos=['nw','ne','sw','se'].find(p=>h.classList.contains(p));
    if(pos)h.addEventListener('pointerdown',e=>startResize(e,el,pos));
    if(h.classList.contains('rot'))h.addEventListener('pointerdown',e=>startRotate(e,el));
  });
  el.addEventListener('pointerdown',e=>{
    if(e.target.classList.contains('dk-handle'))return;
    if(drawMode!=='select')return;
    if(el.dataset.editing==='true')return;
    e.stopPropagation();
    selectBlock(el,e);
    const page=document.querySelector('.dk-page');
    const scale=parseFloat(page?.parentElement?.style.transform?.match(/scale\(([^)]+)\)/)?.[1])||1;
    _blockDrag={el,startX:e.clientX,startY:e.clientY,origLeft:el.offsetLeft,origTop:el.offsetTop,scale};
    const hasText=el.querySelector('.dk-text');
    if(!hasText)e.preventDefault();
    const bd=page.closest('.wbody');
    if(bd)bd.setPointerCapture(e.pointerId);
  });
  const txtSpan=el.querySelector('.dk-text');
  if(txtSpan){
    el.addEventListener('dblclick',e=>{
      e.stopPropagation();_blockDrag=null;el.dataset.editing='true';
      txtSpan.focus();
      const range=document.createRange();range.selectNodeContents(txtSpan);window.getSelection().removeAllRanges();window.getSelection().addRange(range);
    });
    txtSpan.addEventListener('blur',()=>{el.dataset.editing='false'});
    txtSpan.addEventListener('mousedown',e=>{if(el.dataset.editing==='true')e.stopPropagation()});
    txtSpan.addEventListener('keydown',e=>{if(e.key==='Enter')e.preventDefault()});
  }
  // Double-click image/video blocks to upload
  const rtype=el.dataset.type||'frame';
  if(rtype==='image'||rtype==='video'){
    el.addEventListener('dblclick',e=>{
      e.stopPropagation();_blockDrag=null;
      _imgTarget=el;
      document.getElementById('dk-img-upload').click();
    });
    el.style.cursor='pointer';
  }
}
function delBlock(){
  if(!selectedEl)return;
  selectedEl.remove();selectedEl=null;
  clearSelection();
  if(window._updatePreviewSize)window._updatePreviewSize();
  saveState();
}

// ═══ GLOBAL MOUSE HANDLERS ═══
document.addEventListener('pointermove',e=>{
  onBlockDragMove(e);
  onResizeMove(e);
  onRotateMove(e);
  // Drawing
  if(_drawing){
    const d=_drawing;
    const rect=d.page.getBoundingClientRect();
    let x=(e.clientX-rect.left)/d.scale;
    let y=(e.clientY-rect.top)/d.scale;
    // Clamp to page bounds
    x=Math.max(0,Math.min(x,getPageW()));
    y=Math.max(0,y);
    const left=Math.min(d.startX,x),top=Math.min(d.startY,y);
    const w=Math.abs(x-d.startX),h=Math.abs(y-d.startY);
    d.rect.style.left=left+'px';d.rect.style.top=top+'px';
    d.rect.style.width=w+'px';d.rect.style.height=h+'px';
  }
});
document.addEventListener('pointerup',e=>{
  onBlockDragEnd(e);
  onResizeEnd(e);
  onRotateEnd(e);
  // Drawing end
  if(_drawing){
    const d=_drawing;
    d.rect.remove();
    const rect=d.page.getBoundingClientRect();
    let x=(e.clientX-rect.left)/d.scale;
    let y=(e.clientY-rect.top)/d.scale;
    x=Math.max(0,Math.min(x,getPageW()));
    y=Math.max(0,y);
    const left=Math.min(d.startX,x),top=Math.min(d.startY,y);
    const w=Math.abs(x-d.startX),h=Math.abs(y-d.startY);
    // Release capture
    if(d.bd&&e.pointerId)try{d.bd.releasePointerCapture(e.pointerId)}catch(x){}
    _drawing=null;
    if(w<10&&h<10)return;
    const role=gv('draw-role');
    const el=createBlock(left,top,w,h,role);
    if(el){selectBlock(el);setMode('select')}
  }
});

// ═══ APPLY TOOL TO SELECTION ═══

// ═══ PREVIEW WINDOW ═══
function openPreview(){
  if(openWindows['_preview']){
    const w=openWindows['_preview'];
    w.classList.remove('hidden');
    document.querySelectorAll('.win').forEach(x=>x.classList.remove('focused'));
    w.classList.add('focused');w.style.zIndex=++topZ;
    return;
  }
  const pw=700,ph=500;
  const vx=(window._wsScrollX?window._wsScrollX():0)+20,vy=(window._wsScrollY?window._wsScrollY():0)+20;
  const el=document.createElement('div');
  el.className='win focused';
  el.style.cssText=`left:${vx}px;top:${vy}px;width:${pw}px;height:${ph}px;z-index:${++topZ}`;
  el.dataset.tool='_preview';
  const hd=document.createElement('div');hd.className='wh';
  hd.innerHTML=`<div class="wc" style="background:var(--green)"></div><span class="wt">Page Builder</span><span class="wtag" style="color:var(--green)">1280px canvas</span><div class="wctrls"><button class="wb max" title="Maximize">☐</button><button class="wb min" title="Collapse">—</button><button class="wb close" title="Close">✕</button></div>`;
  const bd=document.createElement('div');bd.className='wbody';
  bd.style.cssText='padding:0;overflow:hidden;position:relative;background:#09090f;flex:1';
  const v=getLPVars();
  bd.innerHTML=`<div id="lp-sizer" style="position:relative;width:100%;overflow:hidden"><div id="lp-viewport" class="lp-viewport" style="width:1280px;transform-origin:top left;will-change:transform"><div class="dk-page mode-select" style="all:initial;display:block;position:relative;font-family:${v.bodyfont};background:${v.bg};color:${v.text};font-size:15px;line-height:1.6;min-height:900px;cursor:default;--p:${v.primary};--s:${v.secondary};--a:${v.accent};--bg:${v.bg};--sf:${v.surface};--t:${v.text};--hf:${v.headfont};--bf:${v.bodyfont};--r:${v.radius}"></div></div></div>`;
  // Custom scrollbar for preview body
  const pvScrollV=document.createElement('div');
  const _pvBarW=window.matchMedia('(pointer:coarse)').matches?18:12;
  pvScrollV.style.cssText=`position:absolute;top:0;right:0;bottom:${_pvBarW+4}px;width:${_pvBarW}px;background:rgba(0,0,0,.3);border-left:1px solid var(--border);z-index:5`;
  const pvThumbV=document.createElement('div');
  const _pvThW=window.matchMedia('(pointer:coarse)').matches?12:6;
  pvThumbV.style.cssText=`position:absolute;right:${(_pvBarW-_pvThW)/2}px;width:${_pvThW}px;background:var(--dim);border-radius:${_pvThW/2}px;opacity:.5;cursor:pointer;min-height:24px;transition:opacity .15s`;
  pvScrollV.appendChild(pvThumbV);
  let _pvScrollY=0;
  function pvScrollUpdate(){
    const sizer=document.getElementById('lp-sizer');
    if(!sizer)return;
    const contentH=sizer.scrollHeight;
    const viewH=bd.clientHeight;
    if(contentH<=viewH){pvScrollV.style.display='none';_pvScrollY=0;sizer.style.transform='';return}
    pvScrollV.style.display='';
    const maxScroll=contentH-viewH;
    _pvScrollY=Math.max(0,Math.min(maxScroll,_pvScrollY));
    sizer.style.transform=`translateY(${-_pvScrollY}px)`;
    const trackH=bd.clientHeight;
    const thumbH=Math.max(24,trackH*(viewH/contentH));
    pvThumbV.style.height=thumbH+'px';
    const maxTravel=trackH-thumbH;
    pvThumbV.style.top=Math.round((maxScroll>0?_pvScrollY/maxScroll:0)*maxTravel)+'px';
  }
  // Thumb drag
  pvThumbV.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();
    const sy=e.clientY,ss=_pvScrollY;pvThumbV.style.opacity='.8';
    const onM=ev=>{const contentH=document.getElementById('lp-sizer')?.scrollHeight||1;const viewH=bd.clientHeight;const maxScroll=contentH-viewH;const trackH=bd.clientHeight;const thumbH=pvThumbV.offsetHeight;const maxTravel=trackH-thumbH;if(maxTravel<=0)return;const delta=ev.clientY-sy;_pvScrollY=Math.max(0,Math.min(maxScroll,ss+delta*(maxScroll/maxTravel)));pvScrollUpdate()};
    const onU=()=>{window.removeEventListener('mousemove',onM);window.removeEventListener('mouseup',onU);pvThumbV.style.opacity='.5'};
    window.addEventListener('mousemove',onM);window.addEventListener('mouseup',onU)});
  pvThumbV.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();
    const sy=e.touches[0].clientY,ss=_pvScrollY;pvThumbV.style.opacity='.8';
    const onM=ev=>{ev.preventDefault();const contentH=document.getElementById('lp-sizer')?.scrollHeight||1;const viewH=bd.clientHeight;const maxScroll=contentH-viewH;const trackH=bd.clientHeight;const thumbH=pvThumbV.offsetHeight;const maxTravel=trackH-thumbH;if(maxTravel<=0)return;const delta=ev.touches[0].clientY-sy;_pvScrollY=Math.max(0,Math.min(maxScroll,ss+delta*(maxScroll/maxTravel)));pvScrollUpdate()};
    const onU=()=>{window.removeEventListener('touchmove',onM);window.removeEventListener('touchend',onU);pvThumbV.style.opacity='.5'};
    window.addEventListener('touchmove',onM,{passive:false});window.addEventListener('touchend',onU)},{passive:false});
  // Click track to jump
  pvScrollV.addEventListener('mousedown',e=>{if(e.target===pvThumbV)return;const rect=pvScrollV.getBoundingClientRect();const pos=e.clientY-rect.top;const contentH=document.getElementById('lp-sizer')?.scrollHeight||1;const viewH=bd.clientHeight;const maxScroll=contentH-viewH;const trackH=bd.clientHeight;const thumbH=pvThumbV.offsetHeight;const ratio=(pos-thumbH/2)/(trackH-thumbH);_pvScrollY=Math.max(0,Math.min(maxScroll,ratio*maxScroll));pvScrollUpdate()});
  // Wheel on preview body
  bd.addEventListener('wheel',e=>{e.preventDefault();e.stopPropagation();const contentH=document.getElementById('lp-sizer')?.scrollHeight||1;const viewH=bd.clientHeight;const maxScroll=contentH-viewH;_pvScrollY=Math.max(0,Math.min(maxScroll,_pvScrollY+e.deltaY));pvScrollUpdate()},{passive:false});
  const rsz=document.createElement('div');rsz.className='wresize';
  bd.appendChild(pvScrollV);
  bd.style.touchAction='none'; // prevent touch scroll on preview body
  el.append(hd,bd,rsz);
  
  const doResize=()=>{
    const bw=bd.clientWidth-_pvBarW;
    const bh=bd.clientHeight;
    const vp=document.getElementById('lp-viewport');
    const page=vp?.querySelector('.dk-page');
    if(!vp||!page)return;
    const pageW=parseInt(vp.style.width)||1280;
    // Scale down to fit, but never scale up beyond 1x
    const scale=Math.min(1,bw/pageW);
    vp.style.transform=`scale(${scale})`;
    // Center canvas horizontally if smaller than window
    const scaledW=pageW*scale;
    vp.style.marginLeft=scaledW<bw?Math.round((bw-scaledW)/2)+'px':'0';
    // Content height from blocks
    const setH=parseInt(page.dataset.pageH)||0;
    let maxBottom=setH||900;
    page.querySelectorAll('.dk-block').forEach(b=>{
      const bot=b.offsetTop+b.offsetHeight+40;
      if(bot>maxBottom)maxBottom=bot;
    });
    const visibleH=Math.ceil(bh/scale);
    const pageH=Math.max(maxBottom,visibleH);
    page.style.setProperty('min-height',pageH+'px','important');
    page.style.setProperty('height',pageH+'px','important');
    vp.style.height=pageH+'px';
    const sizer=document.getElementById('lp-sizer');
    if(sizer){
      const contentScaled=Math.ceil(maxBottom*scale);
      sizer.style.height=contentScaled>bh?contentScaled+'px':'100%';
    }
    const tag=el.querySelector('.wtag');
    if(tag)tag.textContent=Math.round(scale*100)+'% · '+pageW+'×'+(setH||Math.round(pageH));
    pvScrollUpdate();
  };
  // Make globally accessible so drag/resize can trigger it
  window._updatePreviewSize=doResize;
  
  el.addEventListener('mousedown',()=>{document.querySelectorAll('.win').forEach(x=>x.classList.remove('focused'));el.classList.add('focused');el.style.zIndex=++topZ});
  hd.addEventListener('mousedown',e=>{if(e.target.closest('.wb'))return;e.preventDefault();el.classList.add('focused');el.style.zIndex=++topZ;const wr=ws.getBoundingClientRect();const mx=e.clientX-wr.left+(window._wsScrollX?window._wsScrollX():0),my=e.clientY-wr.top+(window._wsScrollY?window._wsScrollY():0);_dr={w:el,ox:mx-el.offsetLeft,oy:my-el.offsetTop}});
  hd.addEventListener('touchstart',e=>{if(e.target.closest('.wb'))return;e.preventDefault();el.classList.add('focused');el.style.zIndex=++topZ;const t=e.touches[0];const wr=ws.getBoundingClientRect();const mx=t.clientX-wr.left+(window._wsScrollX?window._wsScrollX():0),my=t.clientY-wr.top+(window._wsScrollY?window._wsScrollY():0);_dr={w:el,ox:mx-el.offsetLeft,oy:my-el.offsetTop}},{passive:false});
  rsz.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();_rs={w:el,sx:e.clientX,sy:e.clientY,sw:el.offsetWidth,sh:el.offsetHeight}});
  rsz.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();const t=e.touches[0];_rs={w:el,sx:t.clientX,sy:t.clientY,sw:el.offsetWidth,sh:el.offsetHeight}},{passive:false});
  const resObs=new ResizeObserver(doResize);
  hd.querySelector('.min').addEventListener('click',()=>el.classList.toggle('collapsed'));
  hd.querySelector('.max').addEventListener('click',()=>toggleMaximize(el));
  hd.querySelector('.close').addEventListener('click',()=>{resObs.disconnect();el.remove();delete openWindows['_preview']});
  let _lastTapPV=0;
  hd.addEventListener('touchend',e=>{
    if(e.target.closest('.wb'))return;
    const now=Date.now();
    if(now-_lastTapPV<300){toggleMaximize(el);e.preventDefault()}
    _lastTapPV=now;
  });
  wsI.appendChild(el);
  openWindows['_preview']=el;
  requestAnimationFrame(()=>{
    doResize();resObs.observe(bd);
    const page=bd.querySelector('.dk-page');
    if(page)initDrawing(page,bd);
  });
}

// ═══ IMAGE UPLOAD ═══
let _imgTarget=null;
function imgUpload(input){
  const file=input.files[0];
  if(!file||!_imgTarget)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const b64=e.target.result;
    _imgTarget.style.backgroundImage=`url(${b64})`;
    _imgTarget.style.backgroundSize='cover';
    _imgTarget.style.backgroundPosition='center';
    _imgTarget.style.border='none';
    _imgTarget.dataset.src=b64;
    [..._imgTarget.childNodes].forEach(n=>{
      if(n.nodeType===3)n.textContent='';
      if(n.classList&&n.classList.contains('dk-text'))n.textContent='';
    });
    _imgTarget=null;
    saveState();
    toast('Image added!');
  };
  reader.readAsDataURL(file);
  input.value='';
}
function imgInsert(){
  // Create image block at center of viewport, then open file picker
  const vp=document.getElementById('lp-viewport');
  const page=vp?.querySelector('.dk-page');
  if(!page)return;
  const pageW=parseInt(vp.style.width)||1280;
  const el=createBlock(Math.round(pageW/2-150),100,300,200,'image');
  if(el){
    selectBlock(el);
    _imgTarget=el;
    document.getElementById('dk-img-upload').click();
  }
}

// ═══ CODE EDITOR ═══
let _codeSyncDir=null,_codeEditTimer=null;

function codeSyncFrom(){
  const page=document.querySelector('.dk-page');
  if(!page)return toast('No canvas');
  const ta=document.getElementById('code-editor');if(!ta)return;
  _codeSyncDir='from-canvas';
  const animStyle=document.getElementById('dk-anim-style');
  const codeStyle=document.getElementById('dk-code-style');
  let src='';let css='';
  if(animStyle?.textContent)css+=animStyle.textContent+'\n';
  if(codeStyle?.textContent)css+=codeStyle.textContent+'\n';
  const blocks=page.querySelectorAll('.dk-block');
  const classes=new Map();
  let blockHTML='';
  blocks.forEach((b,i)=>{
    const type=b.dataset.type||'frame';
    const cls='dk-'+type+'-'+(i+1);
    classes.set(cls,b.style.cssText);
    const txt=b.querySelector('.dk-text');
    let content='';
    if(txt)content=txt.textContent||'';
    else[...b.childNodes].forEach(n=>{
      if(n.classList&&(n.classList.contains('dk-handle')||n.classList.contains('dk-shape-content')))return;
      if(n.nodeType===3)content+=n.textContent;
    });
    const tagMap={heading:'h2',text:'p',button:'button',link:'a',nav:'nav',section:'section',image:'div',icon:'span',badge:'span',divider:'hr',card:'div',frame:'div',input:'input',video:'div'};
    const tag=tagMap[type]||'div';
    const anim=b.dataset.animTrigger&&b.dataset.animVal?` data-anim-trigger="${b.dataset.animTrigger}" data-anim-val="${b.dataset.animVal}"`:'';
    if(tag==='hr')blockHTML+=`  <hr class="${cls}"${anim}>\n`;
    else blockHTML+=`  <${tag} class="${cls}"${anim}>${content}</${tag}>\n`;
  });
  if(css||classes.size){
    src+='<style>\n';
    if(css)src+=css;
    classes.forEach((style,cls)=>{
      const props=style.split(';').map(s=>s.trim()).filter(Boolean);
      src+=`.${cls} {\n${props.map(p=>'  '+p+';').join('\n')}\n}\n`;
    });
    src+='</style>\n\n';
  }
  src+=blockHTML;
  const cc=page.querySelector('.dk-code-container');
  if(cc?.innerHTML.trim())src+='\n'+cc.innerHTML+'\n';
  ta.value=src;
  _codeSyncDir=null;
  toast('Code synced from canvas');
}
function codeRun(){
  const page=document.querySelector('.dk-page');
  if(!page)return toast('Open Preview first');
  const ta=document.getElementById('code-editor');
  const src=ta?.value||'';
  if(!src.trim())return toast('Nothing to run');
  _codeSyncDir='from-code';
  const con=document.getElementById('code-console');
  if(con){con.style.display='block';con.innerHTML=''}
  // Parse CSS/JS/HTML
  let css='';
  const cssClean=src.replace(/<style[^>]*>([\s\S]*?)<\/style>/gi,(_,c)=>{css+=c+'\n';return''});
  let js='';
  const htmlClean=cssClean.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi,(_,c)=>{js+=c+'\n';return''});
  // Inject CSS into editor
  let styleEl=document.getElementById('dk-code-style');
  if(!styleEl){styleEl=document.createElement('style');styleEl.id='dk-code-style';document.head.appendChild(styleEl)}
  styleEl.textContent=css;
  // Render in hidden iframe to get computed layout
  const vp=document.getElementById('lp-viewport');
  const pageW=parseInt(vp?.style.width)||1280;
  const iframe=document.createElement('iframe');
  iframe.style.cssText=`position:fixed;left:-9999px;top:-9999px;width:${pageW}px;height:4000px;border:none;visibility:hidden`;
  document.body.appendChild(iframe);
  const doc=iframe.contentDocument;
  const v=getLPVars();
  doc.open();
  doc.write(`<!DOCTYPE html><html><head><style>
:root{--p:${v.primary};--s:${v.secondary};--a:${v.accent};--bg:${v.bg};--sf:${v.surface};--t:${v.text};--hf:${v.headfont};--bf:${v.bodyfont};--r:${v.radius}}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--bf);background:var(--bg);color:var(--t);font-size:15px;line-height:1.6}
${css}
</style></head><body>${htmlClean}</body></html>`);
  doc.close();
  setTimeout(()=>{
    const body=doc.body;
    const bodyH=Math.max(body.scrollHeight,900);
    // Clear existing blocks
    page.querySelectorAll('.dk-block').forEach(b=>b.remove());
    const cc=page.querySelector('.dk-code-container');if(cc)cc.remove();
    clearSelection();
    // Resize page height to fit content
    page.dataset.pageH=bodyH;
    page.style.minHeight=bodyH+'px';
    // Walk and create blocks
    const blocks=[];
    const processed=new WeakSet();
    function walk(el,depth){
      if(depth>8)return;
      if(processed.has(el))return;
      const tag=el.tagName?.toLowerCase();
      if(!tag||['script','style','link','meta','head','html','br','wbr','noscript','template'].includes(tag))return;
      const comp=iframe.contentWindow.getComputedStyle(el);
      if(comp.display==='none'||comp.visibility==='hidden')return;
      const rect=el.getBoundingClientRect();
      if(rect.width<2||rect.height<2)return;
      const children=[...el.children].filter(c=>{
        const ct=c.tagName?.toLowerCase();
        return ct&&!['script','style','link','meta','br','wbr'].includes(ct);
      });
      const hasDirectText=[...el.childNodes].some(n=>n.nodeType===3&&n.textContent.trim());
      const isLeaf=children.length===0||hasDirectText||
        ['button','a','input','select','textarea','img','video','svg',
         'h1','h2','h3','h4','h5','h6','p','span','li','td','th','label'].includes(tag);
      const hasBg=comp.backgroundColor!=='rgba(0, 0, 0, 0)'||comp.backgroundImage!=='none';
      const hasBorder=comp.borderWidth!=='0px'&&comp.borderStyle!=='none';
      const isVisual=hasBg||hasBorder||comp.boxShadow!=='none'||(comp.borderRadius!=='0px'&&comp.borderRadius!=='');
      if(isVisual&&!isLeaf){
        processed.add(el);
        blocks.push(_htmlBlock(el,rect,comp,tag));
        children.forEach(c=>walk(c,depth+1));
        return;
      }
      if(isLeaf){processed.add(el);blocks.push(_htmlBlock(el,rect,comp,tag));return}
      children.forEach(c=>walk(c,depth+1));
    }
    [...body.children].forEach(c=>walk(c,0));
    // Create real editable blocks
    blocks.forEach(b=>{
      const el=createBlock(b.x,b.y,b.w,b.h,b.type);
      if(!el)return;
      if(b.extra)el.style.cssText+=';'+b.extra;
      if(b.text){
        const txt=el.querySelector('.dk-text');
        if(txt)txt.textContent=b.text;
        else{
          [...el.childNodes].forEach(n=>{if(!n.classList?.contains('dk-handle'))n.remove()});
          el.insertBefore(document.createTextNode(b.text),el.querySelector('.dk-handle'));
        }
      }
    });
    // Run JS in actual page context
    if(js.trim()){
      try{new Function(js)();
        if(con)con.innerHTML+='<div style="color:#10b981">✓ '+blocks.length+' blocks created, JS executed</div>';
      }catch(err){if(con)con.innerHTML+=`<div style="color:#ef4444">✗ ${err.message}</div>`}
    }else{
      if(con)con.innerHTML+='<div style="color:#10b981">✓ '+blocks.length+' blocks created</div>';
    }
    clearSelection();saveState();
    if(window._updatePreviewSize)window._updatePreviewSize();
    document.body.removeChild(iframe);
    _codeSyncDir=null;
  },400);
}
function codeSyncToEditor(){
  if(_codeSyncDir==='from-code')return;
  const ta=document.getElementById('code-editor');
  const autoSync=document.getElementById('code-autosync');
  if(!ta||!autoSync?.checked)return;
  codeSyncFrom();
}
function codeEditorChanged(){
  // Auto-sync from editor is too heavy (iframe render) — require Push button
  // This is intentionally a no-op; auto-sync only works canvas→code direction
}
function codeClear(){
  const ta=document.getElementById('code-editor');if(ta)ta.value='';
  const c=document.querySelector('.dk-page .dk-code-container');if(c)c.remove();
  const s=document.getElementById('dk-code-style');if(s)s.textContent='';
  const con=document.getElementById('code-console');if(con){con.innerHTML='';con.style.display='none'}
}
function codeSnippet(type){
  const ta=document.getElementById('code-editor');if(!ta)return;
  const S={
    nav:'\n<nav style="display:flex;align-items:center;justify-content:space-between;padding:16px 40px;background:rgba(255,255,255,.03);backdrop-filter:blur(12px)">\n  <span style="font-size:18px;font-weight:800;color:var(--p)">LOGO</span>\n  <div style="display:flex;gap:24px;font-size:14px;opacity:.6"><a href="#">Home</a> <a href="#">About</a> <a href="#">Work</a></div>\n  <button style="background:var(--p);color:#fff;border:none;padding:8px 20px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer">Sign Up</button>\n</nav>\n',
    hero:'\n<div style="min-height:80vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px">\n  <h1 style="font-size:64px;font-weight:900;letter-spacing:-2px;margin-bottom:24px">Big Bold Headline</h1>\n  <p style="font-size:20px;opacity:.6;max-width:500px;margin-bottom:32px">A compelling subheadline.</p>\n  <button style="background:var(--p);color:#fff;border:none;padding:14px 32px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer">Get Started</button>\n</div>\n',
    cards:'\n<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;padding:40px">\n  <div style="background:var(--sf);border-radius:16px;padding:32px"><div style="font-size:28px;margin-bottom:12px">\uD83D\uDE80</div><h3 style="font-size:20px;font-weight:700;margin-bottom:8px">Feature One</h3><p style="font-size:14px;opacity:.6">Description.</p></div>\n  <div style="background:var(--sf);border-radius:16px;padding:32px"><div style="font-size:28px;margin-bottom:12px">\u26A1</div><h3 style="font-size:20px;font-weight:700;margin-bottom:8px">Feature Two</h3><p style="font-size:14px;opacity:.6">Description.</p></div>\n  <div style="background:var(--sf);border-radius:16px;padding:32px"><div style="font-size:28px;margin-bottom:12px">\uD83C\uDFAF</div><h3 style="font-size:20px;font-weight:700;margin-bottom:8px">Feature Three</h3><p style="font-size:14px;opacity:.6">Description.</p></div>\n</div>\n',
    cta:'\n<section style="padding:80px 40px;text-align:center;background:linear-gradient(135deg,var(--p),var(--s));border-radius:24px;margin:40px">\n  <h2 style="font-size:40px;font-weight:800;color:#fff;margin-bottom:16px">Ready to get started?</h2>\n  <button style="background:#fff;color:var(--p);border:none;padding:16px 40px;border-radius:10px;font-size:17px;font-weight:700;cursor:pointer">Start Free Trial</button>\n</section>\n',
    footer:'\n<footer style="padding:40px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid rgba(255,255,255,.06)">\n  <span style="font-size:13px;opacity:.4">2025 Company</span>\n  <div style="display:flex;gap:20px;font-size:13px;opacity:.4"><a href="#">Privacy</a> <a href="#">Terms</a></div>\n</footer>\n',
    form:'\n<div style="max-width:400px;padding:40px">\n  <h3 style="font-size:24px;font-weight:700;margin-bottom:24px">Get in touch</h3>\n  <input placeholder="Name" style="width:100%;padding:12px 16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--t);font-size:14px;margin-bottom:12px">\n  <input placeholder="Email" style="width:100%;padding:12px 16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--t);font-size:14px;margin-bottom:12px">\n  <button style="width:100%;background:var(--p);color:#fff;border:none;padding:14px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer">Send</button>\n</div>\n',
    grid:'\n<style>\n  .grid-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;padding:40px}\n  .grid-item{background:var(--sf);border-radius:12px;padding:24px;transition:transform .2s}\n  .grid-item:hover{transform:translateY(-4px)}\n</style>\n<div class="grid-section">\n  <div class="grid-item"><h4 style="font-weight:700;margin-bottom:8px">Item 1</h4><p style="font-size:13px;opacity:.5">Description</p></div>\n  <div class="grid-item"><h4 style="font-weight:700;margin-bottom:8px">Item 2</h4><p style="font-size:13px;opacity:.5">Description</p></div>\n  <div class="grid-item"><h4 style="font-weight:700;margin-bottom:8px">Item 3</h4><p style="font-size:13px;opacity:.5">Description</p></div>\n</div>\n'
  };
  ta.value+=S[type]||'';ta.scrollTop=ta.scrollHeight;
}

// ═══ EXPORT: PROJECT SAVE/LOAD ═══
function projSave(){
  const vp=document.getElementById('lp-viewport');
  const page=vp?.querySelector('.dk-page');
  if(!page)return toast('Nothing to save');
  const v=getLPVars();
  const pageW=parseInt(vp.style.width)||1280;
  const pageH=parseInt(page.dataset.pageH||page.style.minHeight)||900;
  const blocks=[];
  page.querySelectorAll('.dk-block').forEach(b=>{
    const block={
      type:b.dataset.type||'frame',
      style:b.style.cssText,
      x:parseInt(b.style.left)||0,
      y:parseInt(b.style.top)||0,
      w:b.offsetWidth,h:b.offsetHeight,
      z:parseInt(b.style.zIndex)||0,
      rot:parseFloat(b.dataset.rot)||0
    };
    const txt=b.querySelector('.dk-text');
    if(txt){
      block.text=txt.textContent;
      block.textStyle=txt.style.cssText;
      if(txt.dataset.textgrad)block.textGrad=true;
    }else{
      const textNodes=[...b.childNodes].filter(n=>n.nodeType===3||(n.nodeType===1&&!n.classList?.contains('dk-handle')&&!n.classList?.contains('dk-text')&&!n.classList?.contains('dk-shape-content')));
      if(textNodes.length)block.rawText=textNodes.map(n=>n.textContent).join('');
    }
    const shape=b.querySelector('.dk-shape-content');
    if(shape)block.shapeSVG=shape.innerHTML;
    if(b.dataset.anim)block.anim=b.dataset.anim;
    if(b.dataset.animVal)block.animVal=b.dataset.animVal;
    if(b.dataset.animTrigger)block.animTrigger=b.dataset.animTrigger;
    if(b.dataset.hover)block.hover=b.dataset.hover;
    if(b.dataset.hoverName)block.hoverName=b.dataset.hoverName;
    if(b.dataset.src)block.imgSrc=b.dataset.src;
    blocks.push(block);
  });
  const animStyle=document.getElementById('dk-anim-style');
  const project={
    version:1,
    name:gv('proj-name')||'my-project',
    created:new Date().toISOString(),
    canvas:{w:pageW,h:pageH},
    theme:v,
    blocks:blocks,
    animCSS:animStyle?animStyle.textContent:'',
    pageBg:page.style.background||'',
    codeSource:document.getElementById('code-editor')?.value||''
  };
  const blob=new Blob([JSON.stringify(project,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=(project.name||'my-project')+'.wdx';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Project saved!');
}
function projLoad(input){
  const file=input.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const proj=JSON.parse(e.target.result);
      if(!proj.blocks||!proj.canvas)return toast('Invalid project file');
      _projApply(proj);
      toast('Project loaded! '+proj.blocks.length+' blocks');
    }catch(err){toast('Error reading file')}
  };
  reader.readAsText(file);
  input.value='';
}
function _projApply(proj){
  sv('pg-w',proj.canvas.w);sv('pg-h',proj.canvas.h);
  resizePage();
  if(proj.theme){
    const map={primary:'lp-primary',secondary:'lp-secondary',accent:'lp-accent',bg:'lp-bg',surface:'lp-surface',text:'lp-text'};
    Object.entries(map).forEach(([k,id])=>{if(proj.theme[k])sv(id,proj.theme[k])});
    const hf=document.getElementById('lp-headfont');
    if(hf&&proj.theme.headfont)hf.value=proj.theme.headfont;
    const bf=document.getElementById('lp-bodyfont');
    if(bf&&proj.theme.bodyfont)bf.value=proj.theme.bodyfont;
    if(proj.theme.radius)sv('lp-radius',parseInt(proj.theme.radius));
    if(typeof updateLP==='function')updateLP();
  }
  const page=document.querySelector('.dk-page');
  if(page){
    page.querySelectorAll('.dk-block').forEach(b=>b.remove());
    if(proj.pageBg){
      page.style.background=proj.pageBg;
      const vp=page.closest('.lp-viewport')||document.getElementById('lp-viewport');
      if(vp)vp.style.background=proj.pageBg;
      const sizer=document.getElementById('lp-sizer');
      if(sizer)sizer.style.background=proj.pageBg;
      const pbd=page.closest('.wbody');
      if(pbd)pbd.style.background=proj.pageBg;
    }
  }
  clearSelection();
  if(proj.animCSS){
    let ss=document.getElementById('dk-anim-style');
    if(!ss){ss=document.createElement('style');ss.id='dk-anim-style';document.head.appendChild(ss)}
    ss.textContent=proj.animCSS;
  }
  setTimeout(()=>{
    proj.blocks.forEach(b=>{
      const el=createBlock(b.x,b.y,b.w,b.h,b.type);
      if(!el)return;
      el.style.cssText=b.style;
      if(b.rot)el.dataset.rot=b.rot;
      if(b.text!==undefined){
        const txt=el.querySelector('.dk-text');
        if(txt){
          txt.textContent=b.text;
          if(b.textStyle)txt.style.cssText=b.textStyle;
          if(b.textGrad)txt.dataset.textgrad='1';
        }
      }else if(b.rawText){
        [...el.childNodes].forEach(n=>{if(!n.classList?.contains('dk-handle'))n.remove()});
        el.insertBefore(document.createTextNode(b.rawText),el.querySelector('.dk-handle'));
      }
      if(b.shapeSVG){
        let sc=el.querySelector('.dk-shape-content');
        if(!sc){sc=document.createElement('div');sc.className='dk-shape-content';sc.style.cssText='position:absolute;inset:0;pointer-events:none';el.appendChild(sc)}
        sc.innerHTML=b.shapeSVG;
      }
      if(b.anim)el.dataset.anim=b.anim;
      if(b.animVal)el.dataset.animVal=b.animVal;
      if(b.animTrigger){
        el.dataset.animTrigger=b.animTrigger;
        if(b.animTrigger==='load'&&b.animVal)el.style.animation=b.animVal;
        else if(b.animTrigger==='hover')_abBindHover(el);
        else if(b.animTrigger==='hover-loop')_abBindHoverLoop(el);
        else if(b.animTrigger==='click')_abBindClick(el);
        else if(b.animTrigger==='dblclick')_abBindDblClick(el);
        else if(b.animTrigger==='view'){el.style.opacity='0';_abBindView(el)}
        else if(b.animTrigger==='view-loop'){el.style.opacity='0';_abBindViewLoop(el)}
        else if(b.animTrigger==='scroll')_abBindScroll(el);
      }
      if(b.hover){
        el.dataset.hover=b.hover;
        if(b.hoverName)el.dataset.hoverName=b.hoverName;
        _trBind(el);
      }
      if(b.imgSrc){
        el.dataset.src=b.imgSrc;
        el.style.backgroundImage=`url(${b.imgSrc})`;
        el.style.backgroundSize='cover';
        el.style.backgroundPosition='center';
        el.style.border='none';
        [...el.childNodes].forEach(n=>{if(n.nodeType===3)n.textContent=''});
      }
    });
    clearSelection();
    // Restore code editor content
    if(proj.codeSource){const ta=document.getElementById('code-editor');if(ta)ta.value=proj.codeSource;codeRun()}
    saveState();
    if(window._updatePreviewSize)window._updatePreviewSize();
  },150);
}
function htmlImport(input){
  const file=input.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{try{_htmlParse(e.target.result)}catch(err){toast('Error: '+err.message)}};
  reader.readAsText(file);
  input.value='';
}
function _htmlParse(src){
  const iframe=document.createElement('iframe');
  iframe.style.cssText='position:fixed;left:-9999px;top:-9999px;width:1280px;height:4000px;border:none;visibility:hidden';
  document.body.appendChild(iframe);
  const doc=iframe.contentDocument;
  doc.open();doc.write(src);doc.close();
  setTimeout(()=>{
    const body=doc.body;
    if(!body){document.body.removeChild(iframe);return toast('No body found')}
    const bodyW=Math.max(body.scrollWidth,1280);
    const bodyH=Math.max(body.scrollHeight,900);
    const bodyBg=iframe.contentWindow.getComputedStyle(body).backgroundColor;
    sv('pg-w',Math.min(bodyW,1920));sv('pg-h',bodyH);
    resizePage();
    const page=document.querySelector('.dk-page');
    if(page)page.querySelectorAll('.dk-block').forEach(b=>b.remove());
    clearSelection();
    if(bodyBg&&bodyBg!=='rgba(0, 0, 0, 0)'){
      page.style.background=bodyBg;
      const vp=page.closest('.lp-viewport')||document.getElementById('lp-viewport');
      if(vp)vp.style.background=bodyBg;
      const sizer=document.getElementById('lp-sizer');
      if(sizer)sizer.style.background=bodyBg;
      const pbd=page.closest('.wbody');
      if(pbd)pbd.style.background=bodyBg;
    }
    const blocks=[];
    const processed=new WeakSet();
    function walk(el,depth){
      if(depth>8)return;
      if(processed.has(el))return;
      const tag=el.tagName?.toLowerCase();
      if(!tag||['script','style','link','meta','head','html','br','wbr','noscript','template'].includes(tag))return;
      const comp=iframe.contentWindow.getComputedStyle(el);
      if(comp.display==='none'||comp.visibility==='hidden')return;
      const rect=el.getBoundingClientRect();
      if(rect.width<2||rect.height<2)return;
      const children=[...el.children].filter(c=>{
        const ct=c.tagName?.toLowerCase();
        return ct&&!['script','style','link','meta','br','wbr'].includes(ct);
      });
      const hasDirectText=[...el.childNodes].some(n=>n.nodeType===3&&n.textContent.trim());
      const isLeaf=children.length===0||hasDirectText||
        ['button','a','input','select','textarea','img','video','svg',
         'h1','h2','h3','h4','h5','h6','p','span','li','td','th','label'].includes(tag);
      const hasBg=comp.backgroundColor!=='rgba(0, 0, 0, 0)'||comp.backgroundImage!=='none';
      const hasBorder=comp.borderWidth!=='0px'&&comp.borderStyle!=='none';
      const isVisual=hasBg||hasBorder||comp.boxShadow!=='none'||(comp.borderRadius!=='0px'&&comp.borderRadius!=='');
      if(isVisual&&!isLeaf){
        processed.add(el);
        blocks.push(_htmlBlock(el,rect,comp,tag));
        children.forEach(c=>walk(c,depth+1));
        return;
      }
      if(isLeaf){
        processed.add(el);
        blocks.push(_htmlBlock(el,rect,comp,tag));
        return;
      }
      children.forEach(c=>walk(c,depth+1));
    }
    [...body.children].forEach(c=>walk(c,0));
    setTimeout(()=>{
      blocks.forEach(b=>{
        const el=createBlock(b.x,b.y,b.w,b.h,b.type);
        if(!el)return;
        if(b.extra)el.style.cssText+=';'+b.extra;
        if(b.text){
          const txt=el.querySelector('.dk-text');
          if(txt)txt.textContent=b.text;
          else{
            [...el.childNodes].forEach(n=>{if(!n.classList?.contains('dk-handle'))n.remove()});
            el.insertBefore(document.createTextNode(b.text),el.querySelector('.dk-handle'));
          }
        }
      });
      clearSelection();saveState();
      if(window._updatePreviewSize)window._updatePreviewSize();
      document.body.removeChild(iframe);
      toast(blocks.length+' elements imported!');
    },100);
  },500);
}
function _htmlBlock(el,rect,comp,tag){
  let type='frame';
  if(/^h[1-6]$/.test(tag))type='heading';
  else if(['p','span','label','figcaption','li','td','th'].includes(tag))type='text';
  else if(tag==='button'||el.role==='button')type='button';
  else if(tag==='a'&&comp.display?.includes('flex'))type='button';
  else if(tag==='a')type='link';
  else if(['img','picture','svg'].includes(tag))type='image';
  else if(tag==='video'||tag==='iframe')type='video';
  else if(['input','select','textarea'].includes(tag))type='input';
  else if(tag==='nav')type='nav';
  else if(['section','article','main','aside'].includes(tag))type='section';
  else if(tag==='hr')type='divider';
  let text='';
  if(['heading','text','button','link','badge'].includes(type))text=el.textContent?.trim().substring(0,200)||'';
  else if(type==='image')text=el.alt||el.title||'Image';
  else if(type==='input')text=el.placeholder||el.value||'';
  const s=[];
  const bg=comp.backgroundColor;
  if(bg&&bg!=='rgba(0, 0, 0, 0)')s.push('background:'+bg);
  const bgImg=comp.backgroundImage;
  if(bgImg&&bgImg!=='none')s.push('background-image:'+bgImg);
  if(comp.color)s.push('color:'+comp.color);
  if(comp.fontSize&&comp.fontSize!=='16px')s.push('font-size:'+comp.fontSize);
  if(+comp.fontWeight>400)s.push('font-weight:'+comp.fontWeight);
  if(comp.fontFamily)s.push('font-family:'+comp.fontFamily);
  if(comp.textAlign&&comp.textAlign!=='start')s.push('text-align:'+comp.textAlign);
  if(comp.lineHeight&&comp.lineHeight!=='normal')s.push('line-height:'+comp.lineHeight);
  if(comp.letterSpacing&&comp.letterSpacing!=='normal')s.push('letter-spacing:'+comp.letterSpacing);
  if(comp.borderRadius&&comp.borderRadius!=='0px')s.push('border-radius:'+comp.borderRadius);
  const bdr=comp.border;if(bdr&&!bdr.startsWith('0px'))s.push('border:'+bdr);
  if(comp.boxShadow&&comp.boxShadow!=='none')s.push('box-shadow:'+comp.boxShadow);
  if(comp.opacity!=='1')s.push('opacity:'+comp.opacity);
  if(comp.backdropFilter&&comp.backdropFilter!=='none')s.push('backdrop-filter:'+comp.backdropFilter);
  if(comp.display==='flex'||comp.display==='inline-flex'){
    s.push('display:'+comp.display);
    s.push('align-items:'+comp.alignItems);
    s.push('justify-content:'+comp.justifyContent);
    if(comp.gap&&comp.gap!=='normal'&&comp.gap!=='0px')s.push('gap:'+comp.gap);
  }
  if(comp.padding&&comp.padding!=='0px')s.push('padding:'+comp.padding);
  if(comp.overflow&&comp.overflow!=='visible')s.push('overflow:'+comp.overflow);
  return{x:Math.round(rect.left),y:Math.round(rect.top),w:Math.max(20,Math.round(rect.width)),h:Math.max(10,Math.round(rect.height)),type,text,extra:s.join(';')};
}

function projUpdateInfo(){
  const vp=document.getElementById('lp-viewport');
  const page=vp?.querySelector('.dk-page');
  if(!page)return;
  const blocks=page.querySelectorAll('.dk-block').length;
  const pageW=parseInt(vp.style.width)||1280;
  const pageH=parseInt(page.dataset.pageH||page.style.minHeight)||900;
  const types={};
  page.querySelectorAll('.dk-block').forEach(b=>{const t=b.dataset.type||'frame';types[t]=(types[t]||0)+1});
  const typeStr=Object.entries(types).map(([k,v])=>`${v}× ${k}`).join(', ');
  const info=document.getElementById('proj-info');
  if(info)info.innerHTML=`Canvas: ${pageW}×${pageH}px<br>Blocks: ${blocks}<br>Types: ${typeStr||'none'}`;
}

// ═══ EXPORT ═══
// ═══ EXPORT ═══
function _expBuild(){
  const vp=document.getElementById('lp-viewport');
  if(!vp)return null;
  const page=vp.querySelector('.dk-page');
  if(!page||!page.children.length)return null;
  const clone=page.cloneNode(true);
  const animStyle=document.getElementById('dk-anim-style');
  const codeStyle=document.getElementById('dk-code-style');
  const animCSS=(animStyle?animStyle.textContent:'')+(codeStyle?'\n'+codeStyle.textContent:'');
  const blockCount=clone.querySelectorAll('.dk-block').length;
  // Semantic tag map
  const tagMap={nav:'nav',section:'section',button:'button',link:'a',heading:'h2',image:'div',input:'div',frame:'div',text:'p',icon:'span',card:'div',badge:'span',divider:'hr',video:'div'};
  clone.querySelectorAll('.dk-block').forEach(b=>{
    const type=b.dataset.type||'frame';
    b.classList.remove('dk-block','selected');
    // Add semantic class
    b.classList.add('dk-'+type);
    b.removeAttribute('data-bid');b.removeAttribute('data-type');b.removeAttribute('data-label');b.removeAttribute('data-editing');
    b.removeAttribute('data-rot');b.removeAttribute('data-shape');
    b.removeAttribute('data-hover');b.removeAttribute('data-hoverName');
    b.removeAttribute('data-anim');b.removeAttribute('data-pageH');
    b.querySelectorAll('.dk-handle').forEach(h=>h.remove());
    // Convert image blocks with data-src to <img> tags
    if(b.dataset.src){
      const img=document.createElement('img');
      img.src=b.dataset.src;
      img.alt='';
      img.style.cssText='width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit';
      b.style.backgroundImage='';
      b.style.overflow='hidden';
      [...b.childNodes].forEach(n=>{if(!n.classList?.contains('dk-handle'))n.remove()});
      b.appendChild(img);
      b.removeAttribute('data-src');
    }
    b.querySelectorAll('.dk-text').forEach(t=>{
      t.removeAttribute('contenteditable');t.removeAttribute('class');
      if(t.dataset.textgrad!=='1')t.removeAttribute('style');
      t.removeAttribute('data-textgrad');
    });
  });
  clone.classList.remove('dk-page','mode-select','mode-draw','mode-text');
  clone.removeAttribute('class');
  const v=getLPVars();
  const pageW=parseInt(vp.style.width)||1280;
  const pageH=parseInt(page.dataset.pageH||page.style.minHeight)||900;
  // Capture page background (texture/pattern) for export
  const pageBgImg=page.style.backgroundImage||'';
  const pageBgSize=page.style.backgroundSize||'';
  let pageBgCSS='';
  if(pageBgImg&&pageBgImg!=='none')pageBgCSS+=';background-image:'+pageBgImg;
  if(pageBgSize)pageBgCSS+=';background-size:'+pageBgSize;
  return{clone,animCSS,v,pageW,pageH,blockCount,pageBgCSS};
}
function _expFullHTML(d){
  if(!d)return'';
  const triggerJS=`document.querySelectorAll('[data-anim-trigger="hover"],[data-anim-trigger="hover-loop"]').forEach(el=>{const loop=el.dataset.animTrigger==='hover-loop';el.addEventListener('mouseenter',()=>{const v=loop?el.dataset.animVal.replace(/\\\\d+\\\\s+both/,'infinite both'):el.dataset.animVal;el.style.animation='none';el.offsetHeight;el.style.animation=v});el.addEventListener('mouseleave',()=>{el.style.animation='none'})});document.querySelectorAll('[data-anim-trigger="click"]').forEach(el=>{el.addEventListener('click',()=>{el.style.animation='none';el.offsetHeight;el.style.animation=el.dataset.animVal})});document.querySelectorAll('[data-anim-trigger="dblclick"]').forEach(el=>{el.addEventListener('dblclick',()=>{el.style.animation='none';el.offsetHeight;el.style.animation=el.dataset.animVal})});document.querySelectorAll('[data-anim-trigger="view"]').forEach(el=>{el.style.opacity='0';const obs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting){el.style.opacity='';el.style.animation=el.dataset.animVal;obs.unobserve(el)}})},{threshold:0.15});obs.observe(el)});document.querySelectorAll('[data-anim-trigger="view-loop"]').forEach(el=>{el.style.opacity='0';const obs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting){el.style.opacity='';el.style.animation='none';el.offsetHeight;el.style.animation=el.dataset.animVal}else{el.style.animation='none';el.style.opacity='0'}})},{threshold:0.15});obs.observe(el)});document.querySelectorAll('[data-anim-trigger="scroll"]').forEach(el=>{const dur=parseFloat(el.dataset.animVal.match(/([\\\\d.]+)s/)?.[1]||1);const handler=()=>{const rect=el.getBoundingClientRect();const progress=(window.innerHeight-rect.top)/window.innerHeight;const c=Math.max(0,Math.min(1,progress));el.style.animation=el.dataset.animVal;el.style.animationPlayState='paused';el.style.animationDelay='-'+c*dur+'s'};window.addEventListener('scroll',handler);handler()})`;
  return`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>My Page</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--p:${d.v.primary};--s:${d.v.secondary};--a:${d.v.accent};--bg:${d.v.bg};--sf:${d.v.surface};--t:${d.v.text};--hf:${d.v.headfont};--bf:${d.v.bodyfont};--r:${d.v.radius}}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--bf);background:var(--bg);color:var(--t);font-size:15px;line-height:1.6;position:relative;width:${d.pageW}px;min-height:${d.pageH}px;margin:0 auto${d.pageBgCSS}}
${d.animCSS}
</style>
</head>
<body>
${d.clone.innerHTML}
<script>${triggerJS}<\/script>
</body>
</html>`;
}
function _expCSSOnly(d){
  if(!d)return'';
  let css=`:root {\n  --p: ${d.v.primary};\n  --s: ${d.v.secondary};\n  --a: ${d.v.accent};\n  --bg: ${d.v.bg};\n  --sf: ${d.v.surface};\n  --t: ${d.v.text};\n  --hf: ${d.v.headfont};\n  --bf: ${d.v.bodyfont};\n  --r: ${d.v.radius};\n}`;
  return css;
}

function expCopyHTML(){
  const d=_expBuild();
  if(!d)return toast('Canvas is empty');
  const html=_expFullHTML(d);
  navigator.clipboard.writeText(html);
  toast('Full HTML copied!');
  // Also populate preview
  const out=document.getElementById('exp-html-out');
  if(out)out.textContent=html.substring(0,3000)+(html.length>3000?'\n\n... (truncated, full version copied)':'');
}
function expCopyCSS(what){
  const d=_expBuild();
  if(!d)return toast('Canvas is empty');
  if(what==='vars'){
    const css=_expCSSOnly(d);
    navigator.clipboard.writeText(css);
    toast('CSS variables copied!');
  }else if(what==='blocks'){
    // Extract inline styles as classes
    let css='';let i=0;
    d.clone.querySelectorAll('[class*="dk-"]').forEach(b=>{
      i++;
      const cls=b.className.trim().replace(/\s+/g,'.');
      css+=`.${cls} {\n  ${b.style.cssText.split(';').filter(s=>s.trim()).join(';\n  ')};\n}\n\n`;
    });
    navigator.clipboard.writeText(css||'/* No blocks */');
    toast('Block styles copied!');
  }else if(what==='keyframes'){
    navigator.clipboard.writeText(d.animCSS||'/* No animations */');
    toast('Keyframes copied!');
  }
}
function expDownload(type){
  const d=_expBuild();
  if(!d)return toast('Canvas is empty');
  let content,filename,mime;
  if(type==='html'){
    content=_expFullHTML(d);
    filename='design.html';
    mime='text/html';
  }else{
    content=_expCSSOnly(d)+'\n\n'+d.animCSS;
    filename='design.css';
    mime='text/css';
  }
  const blob=new Blob([content],{type:mime});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
  URL.revokeObjectURL(a.href);
  toast(filename+' downloaded!');
}
function expUpdateInfo(){
  const vp=document.getElementById('lp-viewport');
  const page=vp?.querySelector('.dk-page');
  if(!page)return;
  const blocks=page.querySelectorAll('.dk-block').length;
  const pageW=parseInt(vp.style.width)||1280;
  const pageH=parseInt(page.dataset.pageH||page.style.minHeight)||900;
  const animated=page.querySelectorAll('[data-anim]').length;
  const types={};
  page.querySelectorAll('.dk-block').forEach(b=>{const t=b.dataset.type||'frame';types[t]=(types[t]||0)+1});
  const typeStr=Object.entries(types).map(([k,v])=>`${v} ${k}`).join(', ');
  const info=document.getElementById('exp-info');
  if(info)info.innerHTML=`Canvas: ${pageW} × ${pageH}px<br>Blocks: ${blocks}<br>Animated: ${animated}<br>Types: ${typeStr||'none'}`;
}
function expInitHTML(){
  const d=_expBuild();
  if(!d)return;
  const out=document.getElementById('exp-html-out');
  const html=_expFullHTML(d);
  if(out)out.textContent=html.substring(0,3000)+(html.length>3000?'\n\n... (truncated)':'');
}
function expInitCSS(){
  const d=_expBuild();
  if(!d)return;
  const vars=document.getElementById('exp-css-vars');
  if(vars)vars.textContent=_expCSSOnly(d);
  const blocks=document.getElementById('exp-css-blocks');
  if(blocks){
    let css='';let i=0;
    d.clone.querySelectorAll('[class*="dk-"]').forEach(b=>{
      i++;
      const cls=b.className.trim().replace(/\s+/g,'.');
      css+=`.${cls} {\n  ${b.style.cssText.split(';').filter(s=>s.trim()).join(';\n  ')};\n}\n\n`;
    });
    blocks.textContent=css||'/* No blocks */';
  }
  const kf=document.getElementById('exp-css-kf');
  if(kf)kf.textContent=d.animCSS||'/* No animations */';
}

// Legacy wrapper
function exportPage(){expCopyHTML()}
// ═══ CUSTOM WORKSPACE SCROLLBARS ═══
(function(){
const ws=document.getElementById('workspace');
const inner=document.getElementById('wsI');
const scrollH=document.getElementById('wsScrollH');
const scrollV=document.getElementById('wsScrollV');
const thumbH=document.getElementById('wsThumbH');
const thumbV=document.getElementById('wsThumbV');
if(!ws||!inner)return;
let sX=0,sY=0,_wsZoom=1;
const barSize=()=>window.matchMedia('(pointer:coarse)').matches?22:14;

function update(){
  inner.style.transform=`translate(${-sX}px,${-sY}px) scale(${_wsZoom})`;
  inner.style.transformOrigin='0 0';
  const bs=barSize();
  const vw=ws.clientWidth-bs, vh=ws.clientHeight-bs;
  const iw=(inner.scrollWidth||3000)*_wsZoom, ih=(inner.scrollHeight||2000)*_wsZoom;
  const hR=vw/iw, vR=vh/ih;
  const tW=scrollH.clientWidth, tH=scrollV.clientHeight;
  const tw=Math.max(30,tW*hR), th=Math.max(30,tH*vR);
  thumbH.style.width=tw+'px'; thumbV.style.height=th+'px';
  const maxSX=Math.max(0,iw-vw), maxSY=Math.max(0,ih-vh);
  thumbH.style.left=Math.round((maxSX>0?sX/maxSX:0)*(tW-tw))+'px';
  thumbV.style.top=Math.round((maxSY>0?sY/maxSY:0)*(tH-th))+'px';
  scrollH.style.display=hR>=1?'none':'';
  scrollV.style.display=vR>=1?'none':'';
}
window._wsSetZoom=(z)=>{_wsZoom=z;update()};

function initDrag(thumb,track,isH){
  let drag=null;
  const start=(pos)=>{drag={startPos:pos,startScroll:isH?sX:sY};thumb.classList.add('active')};
  const move=(pos)=>{
    if(!drag)return;
    const bs=barSize();
    const vw=ws.clientWidth-bs, vh=ws.clientHeight-bs;
    const iw=inner.scrollWidth||3000, ih=inner.scrollHeight||2000;
    const maxScroll=isH?(iw-vw):(ih-vh);
    const tSize=isH?track.clientWidth:track.clientHeight;
    const thSize=isH?thumb.offsetWidth:thumb.offsetHeight;
    const maxTravel=tSize-thSize;
    if(maxTravel<=0)return;
    const delta=pos-drag.startPos;
    const ns=Math.max(0,Math.min(maxScroll,drag.startScroll+delta*(maxScroll/maxTravel)));
    if(isH)sX=ns;else sY=ns;
    update();
  };
  const end=()=>{drag=null;thumb.classList.remove('active')};
  thumb.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();start(isH?e.clientX:e.clientY);
    const onM=ev=>move(isH?ev.clientX:ev.clientY);
    const onU=()=>{window.removeEventListener('mousemove',onM);window.removeEventListener('mouseup',onU);end()};
    window.addEventListener('mousemove',onM);window.addEventListener('mouseup',onU)});
  thumb.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();start(isH?e.touches[0].clientX:e.touches[0].clientY);
    const onM=ev=>{ev.preventDefault();move(isH?ev.touches[0].clientX:ev.touches[0].clientY)};
    const onU=()=>{window.removeEventListener('touchmove',onM);window.removeEventListener('touchend',onU);end()};
    window.addEventListener('touchmove',onM,{passive:false});window.addEventListener('touchend',onU)},{passive:false});
  // Click track to jump
  track.addEventListener('mousedown',e=>{if(e.target===thumb)return;
    const rect=track.getBoundingClientRect();const pos=isH?(e.clientX-rect.left):(e.clientY-rect.top);
    const bs=barSize();const vw=ws.clientWidth-bs,vh=ws.clientHeight-bs;
    const iw=inner.scrollWidth||3000,ih=inner.scrollHeight||2000;
    const maxScroll=isH?(iw-vw):(ih-vh);const tSize=isH?track.clientWidth:track.clientHeight;
    const thSize=isH?thumb.offsetWidth:thumb.offsetHeight;
    const ratio=(pos-thSize/2)/(tSize-thSize);
    if(isH)sX=Math.max(0,Math.min(maxScroll,ratio*maxScroll));else sY=Math.max(0,Math.min(maxScroll,ratio*maxScroll));
    update()});
  track.addEventListener('touchstart',e=>{if(e.target===thumb)return;e.preventDefault();
    const rect=track.getBoundingClientRect();const t=e.touches[0];const pos=isH?(t.clientX-rect.left):(t.clientY-rect.top);
    const bs=barSize();const vw=ws.clientWidth-bs,vh=ws.clientHeight-bs;
    const iw=inner.scrollWidth||3000,ih=inner.scrollHeight||2000;
    const maxScroll=isH?(iw-vw):(ih-vh);const tSize=isH?track.clientWidth:track.clientHeight;
    const thSize=isH?thumb.offsetWidth:thumb.offsetHeight;
    const ratio=(pos-thSize/2)/(tSize-thSize);
    if(isH)sX=Math.max(0,Math.min(maxScroll,ratio*maxScroll));else sY=Math.max(0,Math.min(maxScroll,ratio*maxScroll));
    update()},{passive:false});
}
initDrag(thumbH,scrollH,true);
initDrag(thumbV,scrollV,false);

// Mouse wheel
ws.addEventListener('wheel',e=>{e.preventDefault();
  const bs=barSize();const vw=ws.clientWidth-bs,vh=ws.clientHeight-bs;
  const iw=inner.scrollWidth||3000,ih=inner.scrollHeight||2000;
  if(e.shiftKey){sX=Math.max(0,Math.min(iw-vw,sX+e.deltaY))}
  else{sY=Math.max(0,Math.min(ih-vh,sY+e.deltaY));sX=Math.max(0,Math.min(iw-vw,sX+e.deltaX))}
  update();
},{passive:false});

const ro=new ResizeObserver(()=>update());
ro.observe(ws);ro.observe(inner);
requestAnimationFrame(update);
window._wsScrollX=()=>sX;
window._wsScrollY=()=>sY;
})();

// ═══ TOUCH / TABLET ENHANCEMENTS ═══
// Apple Pencil: prevent iPadOS Scribble/PencilKit on workspace elements
// Pencil should behave as a precise pointer in this app
document.addEventListener('touchstart',e=>{
  if(e.touches.length===1){
    const el=e.target;
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.tagName==='SELECT'||el.isContentEditable)return;
    // Only prevent on the canvas/page itself, not on module windows
    if(el.closest('.wbody,.wh,.wctrls,.ws-scroll-h,.ws-scroll-v'))return;
    if(el.closest('.dk-page,.dk-block'))e.preventDefault();
  }
},{passive:false});
(function(){
  const isTouch='ontouchstart'in window||navigator.maxTouchPoints>0;
  if(!isTouch)return;

  // -- Pinch-to-zoom on workspace --
  const ws=document.querySelector('.workspace');
  if(ws){
    let _pinch=null;
    ws.addEventListener('touchstart',e=>{
      if(e.touches.length===2){
        _pinch={d:Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY),
          scale:parseFloat(ws.dataset.zoom||1)};
        e.preventDefault();
      }
    },{passive:false});
    ws.addEventListener('touchmove',e=>{
      if(_pinch&&e.touches.length===2){
        e.preventDefault();
        const nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
        const ratio=nd/_pinch.d;
        let ns=Math.max(.25,Math.min(2,_pinch.scale*ratio));
        ws.dataset.zoom=ns;
        if(window._wsSetZoom)window._wsSetZoom(ns);
      }
    },{passive:false});
    ws.addEventListener('touchend',()=>{_pinch=null});
  }

  // -- Long press on block for context menu --
  let _longPress=null;
  document.addEventListener('touchstart',e=>{
    const blk=e.target.closest('.dk-block');
    if(blk){
      _longPress=setTimeout(()=>{
        // Select block on long press
        if(typeof selectBlock==='function')selectBlock(blk);
        // Haptic feedback if available
        if(navigator.vibrate)navigator.vibrate(10);
      },400);
    }
  });
  document.addEventListener('touchmove',()=>{clearTimeout(_longPress)});
  document.addEventListener('touchend',()=>{clearTimeout(_longPress)});

  // -- Prevent iOS overscroll/bounce --
  document.body.style.overscrollBehavior='none';
  document.body.style.webkitOverflowScrolling='touch';

  // -- Active states for touch buttons (CSS :active isn't reliable on touch) --
  document.addEventListener('touchstart',e=>{
    const btn=e.target.closest('.abtn,.xbtn,.btn,.chip,.pbtn,.wb,.mod-tab');
    if(btn){btn.style.opacity='.7';btn.style.transform='scale(.96)'}
  },{passive:true});
  document.addEventListener('touchend',e=>{
    const btn=e.target.closest('.abtn,.xbtn,.btn,.chip,.pbtn,.wb,.mod-tab');
    if(btn){btn.style.opacity='';btn.style.transform=''}
  },{passive:true});

  // -- Range slider touch polyfill: drag anywhere on the track --
  // iOS doesn't let you slide range inputs well because the thumb is tiny
  // This intercepts touch on ANY range input and manually sets value from finger position
  function rangeFromTouch(range,touch){
    const rect=range.getBoundingClientRect();
    const x=touch.clientX-rect.left;
    const ratio=Math.max(0,Math.min(1,x/rect.width));
    const min=parseFloat(range.min)||0;
    const max=parseFloat(range.max)||100;
    const step=parseFloat(range.step)||1;
    let val=min+ratio*(max-min);
    val=Math.round(val/step)*step;
    range.value=val;
    range.dispatchEvent(new Event('input',{bubbles:true}));
  }
  document.addEventListener('touchstart',e=>{
    const range=e.target.closest('input[type="range"]');
    if(!range)return;
    e.preventDefault();
    rangeFromTouch(range,e.touches[0]);
    const onM=ev=>{ev.preventDefault();rangeFromTouch(range,ev.touches[0])};
    const onU=()=>{
      window.removeEventListener('touchmove',onM);
      window.removeEventListener('touchend',onU);
      range.dispatchEvent(new Event('change',{bubbles:true}));
    };
    window.addEventListener('touchmove',onM,{passive:false});
    window.addEventListener('touchend',onU);
  },{passive:false});

})();

// ═══ INIT ═══
// Tap workspace background (outside any window) to deselect
document.getElementById('workspace').addEventListener('click',e=>{
  if(e.target.id==='workspace'||e.target.id==='wsI')clearSelection();
});
// ═══ LEARN MENU ═══
function openLearn(){
  let ov=document.getElementById('learn-overlay');
  if(ov){ov.remove();return}
  ov=document.createElement('div');ov.id='learn-overlay';
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)';
  const box=document.createElement('div');
  box.style.cssText='background:var(--surface);border:1px solid var(--border);border-radius:12px;max-width:600px;width:92%;max-height:85vh;overflow-y:auto;padding:24px 28px;box-shadow:0 20px 60px rgba(0,0,0,.6);-webkit-overflow-scrolling:touch;color:var(--text);font-family:var(--mono)';
  box.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:16px;font-weight:800;margin:0;letter-spacing:-.5px">WEBDEV.EXE <span style="color:var(--acc);font-weight:400">Guide</span></h2>
<button onclick="document.getElementById('learn-overlay').remove()" style="background:none;border:1px solid var(--border);color:var(--dim);width:32px;height:32px;border-radius:8px;font-size:16px;cursor:pointer">✕</button>
</div>

<div style="background:rgba(234,179,8,.08);border:1px solid rgba(234,179,8,.2);border-radius:8px;padding:12px 14px;margin-bottom:20px">
<div style="font-size:11px;font-weight:800;color:#eab308;margin-bottom:4px">⚠ APPLE PENCIL USERS</div>
<div style="font-size:11px;color:var(--dim);line-height:1.5">Disable Scribble for best results. Go to <b style="color:var(--text)">Settings → Apple Pencil → Scribble</b> and toggle it off. This prevents iPadOS from intercepting your drawing gestures.</div>
</div>

<div style="font-size:8px;font-weight:800;color:var(--dim);letter-spacing:1px;margin-bottom:8px">CANVAS MODES</div>
<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:20px">
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="color:#a855f7;font-size:11px">Select</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Tap blocks to select. Drag to move. Use corner handles to resize, top handle to rotate.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="color:#a855f7;font-size:11px">Draw</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Drag on the canvas to draw a new block. Change the ROLE dropdown to set what type (frame, text, heading, button, etc).</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="color:#a855f7;font-size:11px">Text</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Tap anywhere on the canvas to place a text block and start typing immediately.</span></div>
</div>

<div style="font-size:8px;font-weight:800;color:var(--dim);letter-spacing:1px;margin-bottom:8px">MODULES</div>
<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:20px">
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#8b8bf0;margin-right:6px"></span><b style="font-size:11px">Text</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Font family, size, weight, alignment, letter spacing, line height, text transform, and text shadow.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#d080a0;margin-right:6px"></span><b style="font-size:11px">Color</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Background color, gradient fills (linear/radial/conic), opacity, border radius. With no block selected, changes the page background.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#60b8c8;margin-right:6px"></span><b style="font-size:11px">Effects</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Box shadow, blur, drop shadow, border styles, and backdrop blur. Layer multiple effects.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#60c890;margin-right:6px"></span><b style="font-size:11px">Shape</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Insert SVG shapes (circles, stars, arrows, etc), clip paths, and shape fills with color or gradient.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#d0a860;margin-right:6px"></span><b style="font-size:11px">Layout</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Set page width/height, flexbox properties, padding, margin, and overflow on selected blocks.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#d07070;margin-right:6px"></span><b style="font-size:11px">Animate</b><span style="font-size:11px;color:var(--dim);margin-left:8px">CSS animations — fade in, slide, bounce, spin, pulse, glow, and more. Set duration, delay, and easing.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#9080d0;margin-right:6px"></span><b style="font-size:11px">Export</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Export clean HTML/CSS. Copy to clipboard or download as a file. Includes responsive meta tags.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#707880;margin-right:6px"></span><b style="font-size:11px">Code</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Inject custom CSS or HTML. Add Google Fonts, external scripts, or custom code blocks.</span></div>
</div>

<div style="font-size:8px;font-weight:800;color:var(--dim);letter-spacing:1px;margin-bottom:8px">TOOLBAR</div>
<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:20px">
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="font-size:11px">IMG</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Upload an image into the selected block or create a new image block.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="font-size:11px">SNAP / Grid</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Toggle 10px grid snapping for precise block placement and sizing.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="font-size:11px">↶ ↷</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Undo / Redo (also Ctrl+Z / Ctrl+Y on keyboard).</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="font-size:11px">↓ ↑</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Send block backward / bring forward in the layer stack.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="font-size:11px">+ ✕</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Duplicate or delete the selected block.</span></div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px"><b style="font-size:11px;color:#a855f7">ESC</b><span style="font-size:11px;color:var(--dim);margin-left:8px">Deselect the current block. Appears when a block is selected.</span></div>
</div>

<div style="font-size:8px;font-weight:800;color:var(--dim);letter-spacing:1px;margin-bottom:8px">TIPS</div>
<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">
<div style="background:var(--s2);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--dim);line-height:1.5">Double-click a text block to edit its content. Press ESC or tap outside to finish editing.</div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--dim);line-height:1.5">Use the ⚙ settings menu to change the editor theme, save/load projects, or import existing HTML pages.</div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--dim);line-height:1.5">Scroll the workspace using the slider bars on the right and bottom edges. Pinch to zoom on touch devices.</div>
<div style="background:var(--s2);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--dim);line-height:1.5">With no block selected, the Color module changes the page background. Select a block first to color it.</div>
</div>

<div style="text-align:center;padding-top:8px">
<button onclick="document.getElementById('learn-overlay').remove()" style="background:var(--acc);border:none;color:#fff;padding:10px 32px;border-radius:8px;font-family:var(--mono);font-size:12px;font-weight:700;cursor:pointer">GOT IT</button>
</div>
`;
  ov.appendChild(box);
  ov.addEventListener('click',e=>{if(e.target===ov)ov.remove()});
  document.body.appendChild(ov);
}

// ═══ SETTINGS & THEMES ═══
const EDITOR_THEMES={
  midnight:{name:'Midnight',bg:'#0a0a0e',surface:'#131318',s2:'#1a1a20',s3:'#222228',border:'#2a2a32',bl:'#3a3a44',text:'#b8b8c4',dim:'#5a5a68',acc:'#7c8af0'},
  obsidian:{name:'Obsidian',bg:'#0c0c0c',surface:'#141414',s2:'#1c1c1c',s3:'#242424',border:'#2e2e2e',bl:'#3e3e3e',text:'#b0b0b0',dim:'#606060',acc:'#90c0ff'},
  charcoal:{name:'Charcoal',bg:'#101214',surface:'#171a1d',s2:'#1e2124',s3:'#262a2e',border:'#303438',bl:'#404448',text:'#b4b8bc',dim:'#5c6068',acc:'#6cc4a0'},
  slate:{name:'Slate',bg:'#0e1018',surface:'#141620',s2:'#1a1c28',s3:'#222430',border:'#2c2e3a',bl:'#3c3e4a',text:'#b4b8c8',dim:'#585c70',acc:'#a090e0'},
  ember:{name:'Ember',bg:'#100c0c',surface:'#181212',s2:'#201a1a',s3:'#282020',border:'#342a2a',bl:'#443838',text:'#c4b4b4',dim:'#685858',acc:'#e08060'},
  arctic:{name:'Arctic',bg:'#0a0e10',surface:'#121820',s2:'#1a2028',s3:'#222a32',border:'#2a3240',bl:'#3a4250',text:'#b8c4d0',dim:'#586878',acc:'#60a8d8'},
  mono:{name:'Mono',bg:'#0a0a0a',surface:'#121212',s2:'#1a1a1a',s3:'#222222',border:'#2c2c2c',bl:'#3c3c3c',text:'#a8a8a8',dim:'#585858',acc:'#b0b0b0'},
  cream:{name:'Cream',bg:'#f4f0e8',surface:'#ebe6dc',s2:'#e0dbd0',s3:'#d6d0c4',border:'#c8c2b4',bl:'#b0a898',text:'#3a3630',dim:'#8a8478',acc:'#6a7a60'},
  neon:{name:'Neon',bg:'#0d1a0f',surface:'#0a2e10',s2:'#0c3a14',s3:'#10481a',border:'#1a5c28',bl:'#28703a',text:'#c0ffd0',dim:'#50a060',acc:'#00ff88'},
  cyber:{name:'Cyber',bg:'#1a0818',surface:'#2e0c28',s2:'#3c1038',s3:'#4c1848',border:'#602060',bl:'#783080',text:'#ffc0f0',dim:'#a05090',acc:'#ff3090'},
  electric:{name:'Electric',bg:'#04121e',surface:'#061e34',s2:'#082a48',s3:'#0c3660',border:'#104878',bl:'#185a90',text:'#b0e0ff',dim:'#4088b8',acc:'#00c8ff'},
  toxic:{name:'Toxic',bg:'#0c1204',surface:'#162008',s2:'#202e0c',s3:'#2c3e14',border:'#3c5020',bl:'#4c6430',text:'#d8ffa0',dim:'#6a9030',acc:'#a0ff20'},
  sunset:{name:'Sunset',bg:'#1c0a04',surface:'#301008',s2:'#44180c',s3:'#582012',border:'#6c2c18',bl:'#803820',text:'#ffd0b8',dim:'#a06040',acc:'#ff6040'},
  vapor:{name:'Vapor',bg:'#140820',surface:'#220e38',s2:'#30144e',s3:'#3e1c64',border:'#502880',bl:'#643898',text:'#e0c0ff',dim:'#8050b0',acc:'#c060ff'},
  sakura:{name:'Sakura',bg:'#1c080e',surface:'#300e1a',s2:'#441426',s3:'#581c34',border:'#6c2844',bl:'#803858',text:'#ffc8e0',dim:'#a05878',acc:'#ff80b0'},
  matrix:{name:'Matrix',bg:'#001a04',surface:'#002a08',s2:'#003c0e',s3:'#005016',border:'#006820',bl:'#00802c',text:'#60ff80',dim:'#20a040',acc:'#20ff40'},
  gold:{name:'Gold',bg:'#181004',surface:'#2c1e08',s2:'#402c0c',s3:'#543a12',border:'#68481a',bl:'#7c5824',text:'#ffe4a0',dim:'#a08030',acc:'#ffc040'},
  ice:{name:'Ice',bg:'#f0f4f8',surface:'#e4eaf0',s2:'#d8e0e8',s3:'#ccd4dc',border:'#b8c4d0',bl:'#a0acb8',text:'#283440',dim:'#708090',acc:'#2080d0'},
  coral:{name:'Coral',bg:'#fff0ec',surface:'#ffe0d8',s2:'#ffd0c4',s3:'#ffc0b0',border:'#f0a898',bl:'#e09080',text:'#4a2020',dim:'#b06050',acc:'#ff5040'},
  sky:{name:'Sky',bg:'#ecf6ff',surface:'#d8eeff',s2:'#c4e4ff',s3:'#b0d8ff',border:'#90c4f0',bl:'#70aee0',text:'#1a3048',dim:'#5088b0',acc:'#1898ff'},
  mint:{name:'Mint',bg:'#ecfff4',surface:'#d4ffe4',s2:'#bcf8d4',s3:'#a4f0c4',border:'#80dca8',bl:'#60c890',text:'#143028',dim:'#40906a',acc:'#10c870'},
  lavender:{name:'Lavender',bg:'#f4f0ff',surface:'#e8e0ff',s2:'#dcd0ff',s3:'#d0c0ff',border:'#bca8f0',bl:'#a890e0',text:'#282040',dim:'#7060a0',acc:'#7c50f0'},
  peach:{name:'Peach',bg:'#fff6ec',surface:'#ffecda',s2:'#ffe0c6',s3:'#ffd4b0',border:'#f0c098',bl:'#e0a878',text:'#3a2810',dim:'#a07840',acc:'#f09030'},
  rose:{name:'Rose',bg:'#fff0f4',surface:'#ffe0e8',s2:'#ffd0dc',s3:'#ffc0d0',border:'#f0a0b4',bl:'#e08098',text:'#3a1420',dim:'#a05068',acc:'#f04080'},
  lemon:{name:'Lemon',bg:'#fffde8',surface:'#fff8c8',s2:'#fff2a8',s3:'#ffe880',border:'#e8d460',bl:'#d0bc40',text:'#383010',dim:'#908030',acc:'#c8a800'},
  ocean:{name:'Ocean',bg:'#e8f8f8',surface:'#d0f0f0',s2:'#b8e8e8',s3:'#a0dede',border:'#80caca',bl:'#60b4b4',text:'#103838',dim:'#408888',acc:'#00a8a8'},
  lilac:{name:'Lilac',bg:'#f8f0ff',surface:'#f0e4ff',s2:'#e4d4ff',s3:'#d8c4ff',border:'#c4a8f0',bl:'#b090e0',text:'#2c1840',dim:'#7858a8',acc:'#9040e0'},
  lime:{name:'Lime',bg:'#f4ffe8',surface:'#e4ffd0',s2:'#d4ffb8',s3:'#c0f8a0',border:'#a0e478',bl:'#80d058',text:'#1c3010',dim:'#508828',acc:'#50b810'},
  warmnight:{name:'Warm Night',bg:'#1a1410',surface:'#231c16',s2:'#2c241e',s3:'#362e26',border:'#443a30',bl:'#544a3c',text:'#d4c8b0',dim:'#8a7e66',acc:'#d4a054'},
  candlelight:{name:'Candlelight',bg:'#1c1608',surface:'#28200e',s2:'#342a16',s3:'#40341e',border:'#504028',bl:'#604e34',text:'#e8d8b4',dim:'#9a8860',acc:'#e8b840'},
  sepia:{name:'Sepia',bg:'#2a2018',surface:'#362a20',s2:'#423428',s3:'#4e3e30',border:'#5e4c3c',bl:'#6e5c4c',text:'#dccca8',dim:'#9a886a',acc:'#c89860'},
  campfire:{name:'Campfire',bg:'#1a1008',surface:'#281a0e',s2:'#382414',s3:'#48301c',border:'#5c3e26',bl:'#6c4e34',text:'#e8d0a8',dim:'#987850',acc:'#e89040'},
  parchment:{name:'Parchment',bg:'#f0e8d8',surface:'#e6dcc8',s2:'#dcd0b8',s3:'#d0c4a8',border:'#c0b494',bl:'#aea27e',text:'#3a3020',dim:'#7a6e54',acc:'#8a7040'},
  amber:{name:'Amber',bg:'#181008',surface:'#241a0c',s2:'#302410',s3:'#3e2e18',border:'#503c22',bl:'#624c30',text:'#f0d898',dim:'#a08440',acc:'#f0b020'},
  nightowl:{name:'Night Owl',bg:'#171000',surface:'#201800',s2:'#2a2004',s3:'#342a08',border:'#443610',bl:'#564420',text:'#ccc0a0',dim:'#887858',acc:'#c89838'}
};
let _currentTheme='midnight';
function applyEditorTheme(id){
  const t=EDITOR_THEMES[id];if(!t)return;
  _currentTheme=id;
  const r=document.documentElement.style;
  r.setProperty('--bg',t.bg);r.setProperty('--surface',t.surface);
  r.setProperty('--s2',t.s2);r.setProperty('--s3',t.s3);
  r.setProperty('--border',t.border);r.setProperty('--bl',t.bl);
  r.setProperty('--text',t.text);r.setProperty('--dim',t.dim);
  r.setProperty('--acc',t.acc);
  r.setProperty('--ag',t.acc.replace('#','rgba(')+',.2)');
  // Update active state in list
  document.querySelectorAll('.theme-opt').forEach(el=>{
    el.style.borderColor=el.dataset.id===id?t.acc:'var(--border)';
    el.style.background=el.dataset.id===id?t.s3:'transparent';
  });
}
const THEME_CATS={
  midnight:'dark',obsidian:'dark',charcoal:'dark',slate:'dark',ember:'dark',arctic:'dark',mono:'dark',
  neon:'vibrant',cyber:'vibrant',electric:'vibrant',toxic:'vibrant',sunset:'vibrant',vapor:'vibrant',sakura:'vibrant',matrix:'vibrant',gold:'vibrant',
  cream:'light',ice:'light',coral:'light',sky:'light',mint:'light',lavender:'light',peach:'light',rose:'light',lemon:'light',ocean:'light',lilac:'light',lime:'light'
};
let _themeFilter='all';
function filterThemes(cat,btn){
  _themeFilter=cat;
  document.querySelectorAll('.theme-cat-btn').forEach(b=>{
    const active=b===btn;
    b.style.background=active?'rgba(124,138,240,.08)':'transparent';
    b.style.color=active?'var(--acc)':'var(--dim)';
    b.style.borderColor=active?'var(--acc)':'var(--border)';
  });
  renderThemes();renderWsPresets();
}
function renderThemes(){
  const list=document.getElementById('theme-list');if(!list)return;
  list.innerHTML='';
  Object.entries(EDITOR_THEMES).forEach(([id,t])=>{
    if(_themeFilter!=='all'&&THEME_CATS[id]!==_themeFilter)return;
    const active=id===_currentTheme;
    const el=document.createElement('div');
    el.className='theme-opt';el.dataset.id=id;
    el.style.cssText=`display:flex;flex-direction:column;gap:3px;padding:5px;border:1.5px solid ${active?t.acc:'transparent'};border-radius:6px;cursor:pointer;transition:all .15s;background:${t.bg};box-shadow:${active?'0 0 0 1px '+t.acc+'40':'inset 0 0 0 1px '+t.border}`;
    el.innerHTML=`<div style="display:flex;gap:2px;height:16px"><div style="flex:2;border-radius:3px;background:${t.surface}"></div><div style="flex:1;border-radius:3px;background:${t.s3}"></div></div><div style="display:flex;gap:2px;height:6px"><div style="flex:1;border-radius:2px;background:${t.acc}"></div><div style="flex:2;border-radius:2px;background:${t.border}"></div></div><div style="font-family:var(--mono);font-size:7px;color:${t.text};font-weight:500;letter-spacing:.2px;margin-top:1px;opacity:.7">${t.name}</div>`;
    el.addEventListener('click',()=>{applyEditorTheme(id);renderThemes()});
    el.addEventListener('mouseenter',()=>{if(!active)el.style.boxShadow='inset 0 0 0 1px '+t.bl});
    el.addEventListener('mouseleave',()=>{if(!active)el.style.boxShadow='inset 0 0 0 1px '+t.border});
    list.appendChild(el);
  });
}
function toggleSettings(){
  const p=document.getElementById('settings-panel');
  const o=document.getElementById('settings-overlay');
  const open=p.style.right==='0px';
  if(open){p.style.right='-280px';o.style.display='none'}
  else{p.style.right='0px';o.style.display='block';renderThemes();renderWsPresets()}
}
function toggleGrid(on){
  const ws=document.getElementById('wsI');
  if(ws)ws.style.backgroundImage=on?'radial-gradient(circle,rgba(255,255,255,.03) 1px,transparent 1px)':'none';
  if(ws)ws.style.backgroundSize=on?'20px 20px':'auto';
}
function setCanvasWidth(w){
  const vp=document.getElementById('lp-viewport');
  if(vp)vp.style.width=w+'px';
  if(window._updatePreviewSize)window._updatePreviewSize();
}
// Close settings on Escape
document.addEventListener('keydown',e=>{if(e.key==='Escape'){const p=document.getElementById('settings-panel');if(p.style.right==='0px')toggleSettings()}});

// ═══ WORKSPACE BACKGROUND ═══
let _wsTex='dots';
const WS_PRESETS=[
  {name:'Default',bg:'#0a0a0e',tex:'dots'},
  {name:'Blueprint',bg:'#0a1628',tex:'grid'},
  {name:'Paper',bg:'#f5f0e8',tex:'dots'},
  {name:'Dark Grid',bg:'#0c0c0c',tex:'grid'},
  {name:'Void',bg:'#000000',tex:'none'},
  {name:'Slate',bg:'#1a1d24',tex:'cross'},
  {name:'Forest',bg:'#0a120c',tex:'dots'},
  {name:'Warm',bg:'#16100c',tex:'dots'}
];
function setWsTex(tex,btn){
  _wsTex=tex;
  document.querySelectorAll('.ws-tex-opt').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  setWsBg();
}
function setWsBg(){
  const ws=document.getElementById('wsI');if(!ws)return;
  const color=document.getElementById('ws-bg-color')?.value||'#0a0a0e';
  const size=parseInt(document.getElementById('ws-tex-size')?.value||20);
  const op=(parseInt(document.getElementById('ws-tex-op')?.value||2)/100).toFixed(2);
  const c=`rgba(255,255,255,${op})`;
  ws.parentElement.style.backgroundColor=color;
  let img='none',bSize='auto';
  if(_wsTex==='dots'){img=`radial-gradient(circle,${c} 1px,transparent 1px)`;bSize=`${size}px ${size}px`}
  else if(_wsTex==='grid'){img=`linear-gradient(${c} 1px,transparent 1px),linear-gradient(90deg,${c} 1px,transparent 1px)`;bSize=`${size}px ${size}px`}
  else if(_wsTex==='cross'){img=`linear-gradient(${c} 1px,transparent 1px),linear-gradient(90deg,${c} 1px,transparent 1px)`;bSize=`${size}px ${size}px`}
  else if(_wsTex==='lines'){img=`linear-gradient(${c} 1px,transparent 1px)`;bSize=`${size}px ${size}px`}
  else if(_wsTex==='diag'){img=`repeating-linear-gradient(45deg,transparent,transparent ${size-1}px,${c} ${size-1}px,${c} ${size}px)`;bSize='auto'}
  else if(_wsTex==='iso'){const s=size*2;img=`linear-gradient(30deg,${c} 12%,transparent 12.5%,transparent 87%,${c} 87.5%),linear-gradient(150deg,${c} 12%,transparent 12.5%,transparent 87%,${c} 87.5%)`;bSize=`${s}px ${Math.round(s*.577)}px`}
  else if(_wsTex==='noise'){img=`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='${op}'/%3E%3C/svg%3E")`;bSize='200px 200px'}
  ws.style.backgroundImage=img;ws.style.backgroundSize=bSize;
}
function applyWsPreset(i){
  const p=WS_PRESETS[i];if(!p)return;
  document.getElementById('ws-bg-color').value=p.bg;
  _wsTex=p.tex;
  document.querySelectorAll('.ws-tex-opt').forEach(b=>b.classList.toggle('active',b.dataset.tex===p.tex));
  setWsBg();
}
function renderWsPresets(){
  const c=document.getElementById('ws-presets');if(!c)return;
  c.innerHTML=WS_PRESETS.map((p,i)=>`<button onclick="applyWsPreset(${i})" style="font-family:var(--mono);font-size:7px;padding:2px 6px;border:1px solid var(--border);border-radius:3px;background:${p.bg};color:${p.bg.startsWith('#f')||p.bg.startsWith('#e')?'#444':'#888'};cursor:pointer;transition:all .12s">${p.name}</button>`).join('');
}

document.addEventListener('DOMContentLoaded',()=>{
  openPreview();
  setTimeout(_saveStateNow,100);
  // Tab key support in code editors
  document.addEventListener('keydown',e=>{
    if(e.key==='Tab'&&e.target.tagName==='TEXTAREA'&&(e.target.id||'').startsWith('code-')){
      e.preventDefault();
      const ta=e.target,s=ta.selectionStart;
      ta.value=ta.value.substring(0,s)+'  '+ta.value.substring(ta.selectionEnd);
      ta.selectionStart=ta.selectionEnd=s+2;
    }
  });
});
</script>

<!-- ═══ TOOL TEMPLATES (hidden, cloned into windows) ═══ -->
<template id="tmpl-colormod">
<div class="field"><label>Background</label>
<div style="display:flex;gap:6px;align-items:center">
<input type="color" id="cm-bg" value="#1a1a2e" oninput="cmApply()" onchange="cmApply()" style="width:32px;height:24px;border-radius:4px;padding:1px">
<input type="text" id="cm-bg-hex" value="#1a1a2e" oninput="document.getElementById('cm-bg').value=this.value;cmApply()" onchange="document.getElementById('cm-bg').value=this.value;cmApply()" style="flex:1;font-family:var(--mono);font-size:10px">
<button class="tm-align" onclick="cmClearBg()" title="Clear background" style="font-size:8px;padding:3px 6px">✕</button>
</div>
<div style="display:flex;gap:3px;margin-top:6px" id="cm-bg-swatches">
<div class="tm-swatch" style="background:#0f0f1a" onclick="cmSetBg('#0f0f1a')"></div>
<div class="tm-swatch" style="background:#1a1a2e" onclick="cmSetBg('#1a1a2e')"></div>
<div class="tm-swatch" style="background:#ffffff" onclick="cmSetBg('#ffffff')"></div>
<div class="tm-swatch" style="background:#a855f7" onclick="cmSetBg('#a855f7')"></div>
<div class="tm-swatch" style="background:#ec4899" onclick="cmSetBg('#ec4899')"></div>
<div class="tm-swatch" style="background:#06b6d4" onclick="cmSetBg('#06b6d4')"></div>
<div class="tm-swatch" style="background:#10b981" onclick="cmSetBg('#10b981')"></div>
<div class="tm-swatch" style="background:#f59e0b" onclick="cmSetBg('#f59e0b')"></div>
<div class="tm-swatch" style="background:#ef4444" onclick="cmSetBg('#ef4444')"></div>
</div>
</div>
<div class="field"><label>Gradient Background</label>
<div style="display:flex;gap:4px;align-items:center">
<input type="checkbox" id="cm-grad-on" onchange="cmApply()">
<input type="color" id="cm-grad-c1" value="#a855f7" oninput="cmApply()" style="width:24px;height:20px;border-radius:3px;padding:1px">
<span style="font-size:8px;color:var(--dim)">→</span>
<input type="color" id="cm-grad-c2" value="#ec4899" oninput="cmApply()" style="width:24px;height:20px;border-radius:3px;padding:1px">
<input type="range" id="cm-grad-angle" min="0" max="360" value="135" oninput="document.getElementById('cm-grad-angle-v').textContent=this.value+'°';cmApply()" style="flex:1">
<span id="cm-grad-angle-v" style="font-size:8px;color:var(--acc);font-family:var(--mono);min-width:24px">135°</span>
</div>
<div style="display:flex;gap:4px;margin-top:4px;align-items:center">
<label style="font-size:8px;color:var(--dim);margin:0">Type</label>
<button class="tm-align active" data-v="linear" onclick="cmGradType(this)">Linear</button>
<button class="tm-align" data-v="radial" onclick="cmGradType(this)">Radial</button>
<button class="tm-align" data-v="conic" onclick="cmGradType(this)">Conic</button>
</div>
</div>
<div class="field"><label>Opacity <span id="cm-op-v" style="color:var(--acc)">1</span></label>
<input type="range" id="cm-op" min="0" max="100" value="100" oninput="cmApply()">
</div>
<div style="border-top:1px solid var(--bdr);margin-top:10px;padding-top:10px">
<div class="field"><label style="font-weight:700">Page Theme</label>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
<div style="display:flex;align-items:center;gap:4px"><input type="color" value="#a855f7" oninput="sv('lp-primary',this.value);updateLP()" id="th-p" style="width:20px;height:16px;border-radius:3px;padding:0"><label>Primary</label></div>
<div style="display:flex;align-items:center;gap:4px"><input type="color" value="#ec4899" oninput="sv('lp-secondary',this.value);updateLP()" id="th-s" style="width:20px;height:16px;border-radius:3px;padding:0"><label>Second</label></div>
<div style="display:flex;align-items:center;gap:4px"><input type="color" value="#06b6d4" oninput="sv('lp-accent',this.value);updateLP()" id="th-a" style="width:20px;height:16px;border-radius:3px;padding:0"><label>Accent</label></div>
<div style="display:flex;align-items:center;gap:4px"><input type="color" value="#09090f" oninput="sv('lp-bgc',this.value);updateLP()" id="th-bg" style="width:20px;height:16px;border-radius:3px;padding:0"><label>BG</label></div>
<div style="display:flex;align-items:center;gap:4px"><input type="color" value="#12121a" oninput="sv('lp-surface',this.value);updateLP()" id="th-sf" style="width:20px;height:16px;border-radius:3px;padding:0"><label>Surface</label></div>
<div style="display:flex;align-items:center;gap:4px"><input type="color" value="#f0f0f5" oninput="sv('lp-text',this.value);updateLP()" id="th-tx" style="width:20px;height:16px;border-radius:3px;padding:0"><label>Text</label></div>
</div>
</div>
<div class="field">
<div style="display:flex;gap:6px;align-items:center">
<div style="flex:1;display:flex;align-items:center;gap:4px"><label>Head</label><select onchange="document.getElementById('lp-headfont').value=this.value;updateLP()" style="flex:1;font-size:9px;padding:2px"><option value="Syne">Syne</option><option value="Space Grotesk">Space Grotesk</option><option value="Playfair Display">Playfair</option><option value="Outfit">Outfit</option><option value="Poppins">Poppins</option><option value="system-ui,sans-serif">System</option></select></div>
<div style="flex:1;display:flex;align-items:center;gap:4px"><label>Body</label><select onchange="document.getElementById('lp-bodyfont').value=this.value;updateLP()" style="flex:1;font-size:9px;padding:2px"><option value="DM Sans">DM Sans</option><option value="Inter">Inter</option><option value="Nunito">Nunito</option><option value="system-ui,sans-serif">System</option></select></div>
</div>
</div>
<div class="field"><label>Radius</label>
<input type="range" min="0" max="24" value="12" oninput="sv('lp-radius',this.value);updateLP()" style="width:100%">
</div>
</div>
</template>

<template id="tmpl-stylemod">
<div class="field"><label>Border</label>
<div style="display:flex;gap:6px;align-items:center">
<input type="checkbox" id="cm-border-on" onchange="cmApply()">
<input type="range" id="cm-border-w" min="1" max="8" value="1" oninput="cmApply()" style="flex:1">
<span id="cm-border-w-v" style="font-size:8px;color:var(--acc);font-family:var(--mono);min-width:16px">1px</span>
<input type="color" id="cm-border-c" value="#a855f7" oninput="cmApply()" style="width:24px;height:20px;border-radius:3px;padding:1px">
</div>
<div style="display:flex;gap:4px;margin-top:4px">
<button class="tm-align active" data-v="solid" onclick="cmBorderStyle(this)">Solid</button>
<button class="tm-align" data-v="dashed" onclick="cmBorderStyle(this)">Dashed</button>
<button class="tm-align" data-v="dotted" onclick="cmBorderStyle(this)">Dotted</button>
</div>
</div>
<div class="field"><label>Border Radius <span id="cm-rad-v" style="color:var(--acc)">8px</span></label>
<input type="range" id="cm-rad" min="0" max="100" value="8" oninput="cmApply()">
</div>
<div class="field"><label>Box Shadow</label>
<div style="display:flex;gap:4px;align-items:center">
<input type="checkbox" id="cm-shad-on" onchange="cmApply()">
<input type="color" id="cm-shad-c" value="#a855f7" oninput="cmApply()" style="width:24px;height:20px;border-radius:3px;padding:1px">
<label style="font-size:8px;color:var(--dim);margin:0">Blur</label>
<input type="range" id="cm-shad-blur" min="0" max="60" value="20" oninput="cmApply()" style="flex:1">
<label style="font-size:8px;color:var(--dim);margin:0">Spread</label>
<input type="range" id="cm-shad-spread" min="-20" max="40" value="0" oninput="cmApply()" style="flex:1">
</div>
<div style="display:flex;gap:4px;margin-top:4px;align-items:center">
<label style="font-size:8px;color:var(--dim);margin:0">X</label>
<input type="range" id="cm-shad-x" min="-40" max="40" value="0" oninput="cmApply()" style="flex:1">
<label style="font-size:8px;color:var(--dim);margin:0">Y</label>
<input type="range" id="cm-shad-y" min="-40" max="40" value="8" oninput="cmApply()" style="flex:1">
</div>
</div>
<div class="field"><label>Backdrop Blur <span id="cm-blur-v" style="color:var(--acc)">0px</span></label>
<input type="range" id="cm-blur" min="0" max="30" value="0" oninput="cmApply()">
</div>
</template>
<template id="tmpl-palette">
<div class="field"><label>Harmony Rule</label><div class="chips" id="pal-mode" data-fn="genPalette">
<div class="chip on" data-v="random">Random</div><div class="chip" data-v="analogous">Analogous</div><div class="chip" data-v="complementary">Complementary</div><div class="chip" data-v="triadic">Triadic</div><div class="chip" data-v="monochromatic">Mono</div><div class="chip" data-v="pastel">Pastel</div><div class="chip" data-v="dark">Dark</div><div class="chip" data-v="neon">Neon</div>
</div></div>
<div class="palette-row" id="pal-row"></div>
<div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap" id="pal-locks"></div>
<div class="actions">
<button class="btn btn-primary" onclick="genPalette()">Generate</button>
<button class="btn btn-secondary" onclick="genPalette()">↻ Shuffle</button>
<button class="btn btn-secondary" onclick="applyPaletteAsTheme()" style="border-color:rgba(16,185,129,.4);color:#10b981">Apply as Theme</button>
</div>
<div class="output"><div class="output-bar"><span>CSS Variables</span><button class="btn btn-copy btn-sm" onclick="copyFrom('pal-out',this)">Copy</button></div><div class="output-body" id="pal-out"></div></div>
</template>

<template id="tmpl-gradient">
<div class="field"><label>Type</label><div class="chips" id="grad-type" data-fn="updateGrad">
<div class="chip on" data-v="linear">Linear</div><div class="chip" data-v="radial">Radial</div><div class="chip" data-v="conic">Conic</div>
</div></div>
<div class="row">
<div class="field"><label>Color 1</label><div style="display:flex;gap:8px;align-items:center"><input type="color" id="grad-c1" value="#a855f7"><input type="text" id="grad-c1t" value="#a855f7" style="flex:1" oninput="document.getElementById('grad-c1').value=this.value;updateGrad()"></div></div>
<div class="field"><label>Color 2</label><div style="display:flex;gap:8px;align-items:center"><input type="color" id="grad-c2" value="#ec4899"><input type="text" id="grad-c2t" value="#ec4899" style="flex:1" oninput="document.getElementById('grad-c2').value=this.value;updateGrad()"></div></div>
</div>
<div class="row">
<div class="field"><label>Color 3 (optional)</label><div style="display:flex;gap:8px;align-items:center"><input type="color" id="grad-c3" value="#06b6d4"><input type="text" id="grad-c3t" value="" style="flex:1" placeholder="leave empty for 2 colors"></div></div>
<div class="field"><label>Angle <span id="grad-angle-val" style="color:var(--acc)">135°</span></label><input type="range" id="grad-angle" min="0" max="360" value="135" oninput="updateGrad()"></div>
</div>
<div class="preview-box preview-lg" id="grad-preview" style="border-radius:16px"></div>
<div class="actions">
<button class="btn btn-primary" onclick="randomGrad()">Random</button>
<button class="btn btn-secondary" onclick="copyFrom('grad-out',event.target)">Copy CSS</button>
</div>
<div class="output"><div class="output-bar"><span>CSS Code</span><button class="btn btn-copy btn-sm" onclick="copyFrom('grad-out',this)">Copy</button></div><div class="output-body" id="grad-out"></div></div>
</template>

<template id="tmpl-effectsmod">
<div class="field"><label>Filter: Blur <span id="fx-blur-v" style="color:var(--acc)">0px</span></label>
<input type="range" id="fx-blur" min="0" max="20" value="0" oninput="fxApply()">
</div>
<div class="field"><label>Brightness <span id="fx-bright-v" style="color:var(--acc)">100%</span></label>
<input type="range" id="fx-bright" min="0" max="300" value="100" oninput="fxApply()">
</div>
<div class="field"><label>Contrast <span id="fx-contrast-v" style="color:var(--acc)">100%</span></label>
<input type="range" id="fx-contrast" min="0" max="300" value="100" oninput="fxApply()">
</div>
<div class="field"><label>Saturate <span id="fx-sat-v" style="color:var(--acc)">100%</span></label>
<input type="range" id="fx-sat" min="0" max="300" value="100" oninput="fxApply()">
</div>
<div class="field"><label>Hue Rotate <span id="fx-hue-v" style="color:var(--acc)">0°</span></label>
<input type="range" id="fx-hue" min="0" max="360" value="0" oninput="fxApply()">
</div>
<div style="display:flex;gap:8px">
<div class="field" style="flex:1"><label>Grayscale <span id="fx-gray-v" style="color:var(--acc)">0%</span></label>
<input type="range" id="fx-gray" min="0" max="100" value="0" oninput="fxApply()">
</div>
<div class="field" style="flex:1"><label>Sepia <span id="fx-sepia-v" style="color:var(--acc)">0%</span></label>
<input type="range" id="fx-sepia" min="0" max="100" value="0" oninput="fxApply()">
</div>
<div class="field" style="flex:1"><label>Invert <span id="fx-invert-v" style="color:var(--acc)">0%</span></label>
<input type="range" id="fx-invert" min="0" max="100" value="0" oninput="fxApply()">
</div>
</div>
<div class="field"><label>Transform</label>
<div style="display:flex;gap:6px">
<div style="flex:1"><label style="font-size:8px;color:var(--dim);margin:0">Rotate <span id="fx-rot-v" style="color:var(--acc)">0°</span></label>
<input type="range" id="fx-rot" min="-180" max="180" value="0" oninput="fxApply()">
</div>
<div style="flex:1"><label style="font-size:8px;color:var(--dim);margin:0">Scale <span id="fx-scale-v" style="color:var(--acc)">1.0</span></label>
<input type="range" id="fx-scale" min="10" max="300" value="100" oninput="fxApply()">
</div>
</div>
<div style="display:flex;gap:6px;margin-top:4px">
<div style="flex:1"><label style="font-size:8px;color:var(--dim);margin:0">Skew X <span id="fx-skewx-v" style="color:var(--acc)">0°</span></label>
<input type="range" id="fx-skewx" min="-45" max="45" value="0" oninput="fxApply()">
</div>
<div style="flex:1"><label style="font-size:8px;color:var(--dim);margin:0">Skew Y <span id="fx-skewy-v" style="color:var(--acc)">0°</span></label>
<input type="range" id="fx-skewy" min="-45" max="45" value="0" oninput="fxApply()">
</div>
</div>
</div>
<div class="field"><label>Mix Blend Mode</label>
<select id="fx-blend" onchange="fxApply()">
<option value="normal">Normal</option>
<option value="multiply">Multiply</option>
<option value="screen">Screen</option>
<option value="overlay">Overlay</option>
<option value="darken">Darken</option>
<option value="lighten">Lighten</option>
<option value="color-dodge">Color Dodge</option>
<option value="color-burn">Color Burn</option>
<option value="hard-light">Hard Light</option>
<option value="soft-light">Soft Light</option>
<option value="difference">Difference</option>
<option value="exclusion">Exclusion</option>
<option value="luminosity">Luminosity</option>
</select>
</div>
<div class="field"><label>Overflow</label>
<div style="display:flex;gap:4px">
<button class="tm-align active" data-v="visible" onclick="fxOverflow(this)">Visible</button>
<button class="tm-align" data-v="hidden" onclick="fxOverflow(this)">Hidden</button>
<button class="tm-align" data-v="auto" onclick="fxOverflow(this)">Scroll</button>
</div>
</div>
<div class="field"><label>Quick Presets</label>
<div style="display:flex;gap:4px;flex-wrap:wrap">
<button class="tm-align" onclick="fxPreset('glass')">Glass</button>
<button class="tm-align" onclick="fxPreset('neumorph')">Neumorph</button>
<button class="tm-align" onclick="fxPreset('inset')">⬛ Inset</button>
<button class="tm-align" onclick="fxPreset('glow')">Glow</button>
<button class="tm-align" onclick="fxPreset('frost')">❄️ Frost</button>
<button class="tm-align" onclick="fxPreset('reset')">↺ Reset</button>
</div>
</div>
</template>
<template id="tmpl-shadow">
<div class="preview-box preview-lg" id="shad-preview-wrap">
<div id="shad-target" style="width:200px;height:140px;background:var(--bg4);border-radius:16px;transition:box-shadow .15s"></div>
</div>
<div class="fs" style="margin-top:20px"><div class="fst">Shadow Controls</div>
<div class="row">
<div class="field"><label>X Offset <span id="shad-x-val" style="color:var(--acc)">0px</span></label><input type="range" id="shad-x" min="-60" max="60" value="0" oninput="updateShadow()"></div>
<div class="field"><label>Y Offset <span id="shad-y-val" style="color:var(--acc)">8px</span></label><input type="range" id="shad-y" min="-60" max="60" value="8" oninput="updateShadow()"></div>
</div>
<div class="row">
<div class="field"><label>Blur <span id="shad-blur-val" style="color:var(--acc)">24px</span></label><input type="range" id="shad-blur" min="0" max="120" value="24" oninput="updateShadow()"></div>
<div class="field"><label>Spread <span id="shad-spread-val" style="color:var(--acc)">0px</span></label><input type="range" id="shad-spread" min="-40" max="40" value="0" oninput="updateShadow()"></div>
</div>
<div class="row">
<div class="field"><label>Color</label><div style="display:flex;gap:8px;align-items:center"><input type="color" id="shad-color" value="#000000" oninput="updateShadow()"><input type="text" id="shad-color-t" value="#000000" style="flex:1" oninput="document.getElementById('shad-color').value=this.value;updateShadow()"></div></div>
<div class="field"><label>Opacity <span id="shad-op-val" style="color:var(--acc)">0.25</span></label><input type="range" id="shad-op" min="0" max="100" value="25" oninput="updateShadow()"></div>
</div>
<div class="field"><label>Presets</label><div class="chips" id="shad-presets">
<div class="chip" data-v="subtle" onclick="shadowPreset('subtle')">Subtle</div>
<div class="chip" data-v="medium" onclick="shadowPreset('medium')">Medium</div>
<div class="chip" data-v="heavy" onclick="shadowPreset('heavy')">Heavy</div>
<div class="chip" data-v="neon" onclick="shadowPreset('neon')">Neon Glow</div>
<div class="chip" data-v="layered" onclick="shadowPreset('layered')">Layered</div>
<div class="chip" data-v="inset" onclick="shadowPreset('inset')">Inset</div>
</div></div>
</div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('shad-out',this)">Copy</button></div><div class="output-body" id="shad-out"></div></div>
</template>

<template id="tmpl-glass">
<div class="preview-box preview-lg" id="glass-preview-wrap" style="background:linear-gradient(135deg,#a855f7,#ec4899,#06b6d4);position:relative;overflow:hidden">
<div style="position:absolute;top:20px;left:30px;width:80px;height:80px;background:rgba(255,255,255,.15);border-radius:50%"></div>
<div style="position:absolute;bottom:30px;right:40px;width:120px;height:60px;background:rgba(255,255,255,.1);border-radius:12px"></div>
<div id="glass-target" style="width:280px;padding:28px;border-radius:16px;z-index:2;text-align:center">
<div style="font-family:var(--head);font-weight:700;font-size:18px;margin-bottom:6px">Glass Card</div>
<div style="font-size:12px;color:rgba(255,255,255,.7)">Adjust the sliders below to customize the frosted glass effect</div>
</div>
</div>
<div class="fs" style="margin-top:20px"><div class="fst">Controls</div>
<div class="row">
<div class="field"><label>Blur <span id="glass-blur-val" style="color:var(--acc)">12px</span></label><input type="range" id="glass-blur" min="0" max="40" value="12" oninput="updateGlass()"></div>
<div class="field"><label>Opacity <span id="glass-op-val" style="color:var(--acc)">0.15</span></label><input type="range" id="glass-op" min="0" max="100" value="15" oninput="updateGlass()"></div>
</div>
<div class="row">
<div class="field"><label>Border Opacity <span id="glass-bdr-val" style="color:var(--acc)">0.2</span></label><input type="range" id="glass-bdr" min="0" max="100" value="20" oninput="updateGlass()"></div>
<div class="field"><label>Border Radius <span id="glass-rad-val" style="color:var(--acc)">16px</span></label><input type="range" id="glass-rad" min="0" max="40" value="16" oninput="updateGlass()"></div>
</div>
<div class="row">
<div class="field"><label>Glass Color</label><div class="chips" id="glass-clr" data-fn="updateGlass"><div class="chip on" data-v="white">White</div><div class="chip" data-v="dark">Dark</div><div class="chip" data-v="accent">Accent</div></div></div>
<div class="field"><label>Background</label><div class="chips" id="glass-bg" data-fn="updateGlass"><div class="chip on" data-v="gradient">Gradient</div><div class="chip" data-v="image">Mesh</div><div class="chip" data-v="dark">Dark</div></div></div>
</div>
</div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('glass-out',this)">Copy</button></div><div class="output-body" id="glass-out"></div></div>
</template>

<template id="tmpl-textmod">
<div class="mod-insert">
<button onclick="createBlock(100,100,300,50,'heading');setMode('select')">+ Heading</button>
<button onclick="createBlock(100,170,400,30,'text');setMode('select')">+ Paragraph</button>
<button onclick="createBlock(100,220,140,44,'button');setMode('select')">+ Button</button>
<button onclick="createBlock(100,280,120,28,'link');setMode('select')">+ Link</button>
</div>
<div class="field"><label>Font Family</label>
<select id="tm-font" onchange="tmApply()">
<option value="Inter">Inter</option>
<option value="DM Sans">DM Sans</option>
<option value="Syne" selected>Syne</option>
<option value="Space Grotesk">Space Grotesk</option>
<option value="Outfit">Outfit</option>
<option value="Poppins">Poppins</option>
<option value="Playfair Display">Playfair Display</option>
<option value="Libre Baskerville">Libre Baskerville</option>
<option value="Oswald">Oswald</option>
<option value="Bebas Neue">Bebas Neue</option>
<option value="Montserrat">Montserrat</option>
<option value="Lora">Lora</option>
<option value="Nunito">Nunito</option>
<option value="Work Sans">Work Sans</option>
<option value="Raleway">Raleway</option>
<option value="Crimson Pro">Crimson Pro</option>
<option value="Source Code Pro">Source Code Pro</option>
<option value="JetBrains Mono">JetBrains Mono</option>
<option value="system-ui,sans-serif">System UI</option>
</select>
</div>
<div class="row">
<div class="field"><label>Size <span id="tm-size-v" style="color:var(--acc)">16px</span></label><input type="range" id="tm-size" min="8" max="120" value="16" oninput="tmApply()"></div>
<div class="field"><label>Weight</label>
<select id="tm-weight" onchange="tmApply()" style="width:100%">
<option value="300">Light</option>
<option value="400">Regular</option>
<option value="500">Medium</option>
<option value="600">Semi Bold</option>
<option value="700" selected>Bold</option>
<option value="800">Extra Bold</option>
<option value="900">Black</option>
</select>
</div>
</div>
<div class="row">
<div class="field"><label>Line Height <span id="tm-lh-v" style="color:var(--acc)">1.5</span></label><input type="range" id="tm-lh" min="8" max="30" value="15" oninput="tmApply()"></div>
<div class="field"><label>Letter Space <span id="tm-ls-v" style="color:var(--acc)">0px</span></label><input type="range" id="tm-ls" min="-5" max="20" value="0" oninput="tmApply()"></div>
</div>
<div class="field"><label>Color</label>
<div style="display:flex;gap:6px;align-items:center">
<input type="color" id="tm-color" value="#f0f0f5" oninput="tmApply()" style="width:32px;height:24px;border-radius:4px;padding:1px">
<input type="text" id="tm-color-hex" value="#f0f0f5" oninput="document.getElementById('tm-color').value=this.value;tmApply()" style="flex:1;font-family:var(--mono);font-size:10px">
<div style="display:flex;gap:3px" id="tm-color-swatches">
<div class="tm-swatch" style="background:#f0f0f5" onclick="tmSetColor('#f0f0f5')"></div>
<div class="tm-swatch" style="background:#a855f7" onclick="tmSetColor('#a855f7')"></div>
<div class="tm-swatch" style="background:#ec4899" onclick="tmSetColor('#ec4899')"></div>
<div class="tm-swatch" style="background:#06b6d4" onclick="tmSetColor('#06b6d4')"></div>
<div class="tm-swatch" style="background:rgba(255,255,255,.5)" onclick="tmSetColor('rgba(255,255,255,.5)')"></div>
</div>
</div>
</div>
<div class="field"><label>Align</label>
<div style="display:flex;gap:4px">
<button class="tm-align active" data-v="left" onclick="tmAlign(this)">⫷</button>
<button class="tm-align" data-v="center" onclick="tmAlign(this)">☰</button>
<button class="tm-align" data-v="right" onclick="tmAlign(this)">⫸</button>
</div>
</div>
<div class="field"><label>Transform</label>
<div style="display:flex;gap:4px">
<button class="tm-align" data-v="none" onclick="tmTransform(this)">—</button>
<button class="tm-align" data-v="uppercase" onclick="tmTransform(this)">AB</button>
<button class="tm-align" data-v="lowercase" onclick="tmTransform(this)">ab</button>
<button class="tm-align" data-v="capitalize" onclick="tmTransform(this)">Ab</button>
</div>
</div>
<div class="field"><label>Text Gradient</label>
<div style="display:flex;gap:4px;align-items:center">
<input type="checkbox" id="tm-grad-on" onchange="tmApply()">
<input type="color" id="tm-grad-c1" value="#a855f7" oninput="tmApply()" style="width:24px;height:20px;border-radius:3px;padding:1px">
<span style="font-size:8px;color:var(--dim)">→</span>
<input type="color" id="tm-grad-c2" value="#ec4899" oninput="tmApply()" style="width:24px;height:20px;border-radius:3px;padding:1px">
<input type="range" id="tm-grad-angle" min="0" max="360" value="135" oninput="document.getElementById('tm-grad-angle-v').textContent=this.value+'°';tmApply()" style="flex:1">
<span id="tm-grad-angle-v" style="font-size:8px;color:var(--acc);font-family:var(--mono);min-width:24px">135°</span>
</div>
</div>
<div class="field"><label>Text Shadow</label>
<div style="display:flex;gap:4px;align-items:center">
<input type="checkbox" id="tm-shad-on" onchange="tmApply()">
<input type="range" id="tm-shad-blur" min="0" max="40" value="10" oninput="tmApply()" style="flex:1">
<input type="color" id="tm-shad-color" value="#a855f7" oninput="tmApply()" style="width:24px;height:20px;border-radius:3px;padding:1px">
</div>
</div>
<div class="field"><label>Opacity <span id="tm-op-v" style="color:var(--acc)">1</span></label><input type="range" id="tm-op" min="0" max="100" value="100" oninput="tmApply()"></div>
</template>
<template id="tmpl-type">
<div class="row">
<div class="field"><label>Heading Font</label><select id="type-h-font" onchange="updateType()"><option>Syne</option><option>Playfair Display</option><option>Space Grotesk</option><option>Outfit</option><option>Libre Baskerville</option><option>Archivo Black</option><option>DM Serif Display</option><option>Oswald</option><option>Poppins</option><option>Bebas Neue</option><option>Merriweather</option><option>Montserrat</option><option>Lora</option><option>Raleway</option><option>Crimson Pro</option></select></div>
<div class="field"><label>Body Font</label><select id="type-b-font" onchange="updateType()"><option>DM Sans</option><option>Source Sans 3</option><option>Nunito</option><option>Work Sans</option><option>Lato</option><option>Open Sans</option><option>Rubik</option><option>IBM Plex Sans</option><option>Karla</option><option>Mulish</option><option>Cabin</option><option>Manrope</option></select></div>
</div>
<div class="row3">
<div class="field"><label>Heading Size <span id="type-hs-val" style="color:var(--acc)">48px</span></label><input type="range" id="type-hs" min="20" max="96" value="48" oninput="updateType()"></div>
<div class="field"><label>Body Size <span id="type-bs-val" style="color:var(--acc)">16px</span></label><input type="range" id="type-bs" min="10" max="32" value="16" oninput="updateType()"></div>
<div class="field"><label>Line Height <span id="type-lh-val" style="color:var(--acc)">1.6</span></label><input type="range" id="type-lh" min="10" max="30" value="16" oninput="updateType()"></div>
</div>
<div class="row">
<div class="field"><label>Weight</label><div class="chips" id="type-wt" data-fn="updateType"><div class="chip" data-v="400">Regular</div><div class="chip" data-v="500">Medium</div><div class="chip on" data-v="700">Bold</div><div class="chip" data-v="900">Black</div></div></div>
<div class="field"><label>Letter Spacing <span id="type-ls-val" style="color:var(--acc)">0px</span></label><input type="range" id="type-ls" min="-5" max="20" value="0" oninput="updateType()"></div>
</div>
<div class="preview-box preview-lg" style="flex-direction:column;align-items:flex-start;padding:32px" id="type-preview">
<div id="type-heading" style="margin-bottom:12px">The Quick Brown Fox</div>
<div id="type-body">Jumps over the lazy dog. Typography is the art and technique of arranging type to make written language legible, readable, and appealing when displayed.</div>
</div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('type-out',this)">Copy</button></div><div class="output-body" id="type-out"></div></div>
</template>

<template id="tmpl-pattern">
<div class="field"><label>Pattern</label><div class="chips" id="pat-type" data-fn="updatePattern">
<div class="chip on" data-v="dots">Dots</div><div class="chip" data-v="grid">Grid</div><div class="chip" data-v="diagonal">Diagonal</div><div class="chip" data-v="zigzag">Zigzag</div><div class="chip" data-v="checkerboard">Checker</div><div class="chip" data-v="triangles">Triangles</div><div class="chip" data-v="hexagons">Hexagons</div><div class="chip" data-v="waves">Waves</div>
</div></div>
<div class="row3">
<div class="field"><label>Size <span id="pat-size-val" style="color:var(--acc)">20px</span></label><input type="range" id="pat-size" min="5" max="80" value="20" oninput="updatePattern()"></div>
<div class="field"><label>Color</label><input type="color" id="pat-color" value="#a855f7" oninput="updatePattern()"></div>
<div class="field"><label>BG Color</label><input type="color" id="pat-bg" value="#0a0a0f" oninput="updatePattern()"></div>
</div>
<div class="field"><label>Opacity <span id="pat-op-val" style="color:var(--acc)">0.3</span></label><input type="range" id="pat-op" min="0" max="100" value="30" oninput="updatePattern()"></div>
<div class="preview-box preview-full" id="pat-preview" style="min-height:200px"></div>
<div class="actions"><button class="btn btn-primary" onclick="applyPattern()">Apply</button><button class="btn btn-secondary" onclick="insertPattern()">+ Insert</button><button class="btn btn-secondary" onclick="copyFrom('pat-out',this)">Copy CSS</button></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('pat-out',this)">Copy</button></div><div class="output-body" id="pat-out"></div></div>
</template>

<template id="tmpl-texture">
<div class="field"><label>Texture Type</label><div class="chips" id="tex-type" data-fn="genTexture">
<div class="chip on" data-v="marble">Marble</div><div class="chip" data-v="wood">Wood</div><div class="chip" data-v="stone">Stone</div><div class="chip" data-v="crack">Cracks</div><div class="chip" data-v="voronoi">Voronoi</div><div class="chip" data-v="organic">Organic</div><div class="chip" data-v="crystal">Crystal</div><div class="chip" data-v="lava">Lava</div>
</div></div>
<div class="row">
<div class="field"><label>Scale <span id="tex-scale-v" style="color:var(--acc)">1.0</span></label><input type="range" id="tex-scale" min="5" max="50" value="10" oninput="genTexture()"></div>
<div class="field"><label>Detail <span id="tex-detail-v" style="color:var(--acc)">4</span></label><input type="range" id="tex-detail" min="1" max="8" value="4" oninput="genTexture()"></div>
</div>
<div class="row">
<div class="field"><label>Contrast <span id="tex-contrast-v" style="color:var(--acc)">1.0</span></label><input type="range" id="tex-contrast" min="5" max="30" value="10" oninput="genTexture()"></div>
<div class="field"><label>Opacity <span id="tex-op-v" style="color:var(--acc)">0.5</span></label><input type="range" id="tex-op" min="0" max="100" value="50" oninput="genTexture()"></div>
</div>
<div class="row3">
<div class="field"><label>Color 1</label><input type="color" id="tex-c1" value="#a855f7" oninput="genTexture()"></div>
<div class="field"><label>Color 2</label><input type="color" id="tex-c2" value="#1a1a2e" oninput="genTexture()"></div>
<div class="field"><label>BG</label><input type="color" id="tex-bg" value="#0a0a12" oninput="genTexture()"></div>
</div>
<canvas id="tex-canvas" width="400" height="260" style="width:100%;border-radius:12px;border:1px solid var(--bdr)"></canvas>
<div class="actions">
<button class="btn btn-primary" onclick="applyTexture()">Apply</button>
<button class="btn btn-secondary" onclick="insertTexture()">+ Insert</button>
<button class="btn btn-secondary" onclick="randomizeTexture()">Randomize</button>
</div>
<div class="output"><div class="output-bar"><span>Data URL</span><button class="btn btn-copy btn-sm" onclick="copyFrom('tex-out',this)">Copy</button></div><div class="output-body" id="tex-out" style="max-height:40px;overflow:hidden;font-size:8px"></div></div>
</template>

<template id="tmpl-noise">
<div class="field"><label>Texture</label><div class="chips" id="noise-type" data-fn="updateNoise">
<div class="chip on" data-v="grain">Film Grain</div><div class="chip" data-v="noise">Digital Noise</div><div class="chip" data-v="paper">Paper</div><div class="chip" data-v="fabric">Fabric</div>
</div></div>
<div class="row3">
<div class="field"><label>Intensity <span id="noise-int-val" style="color:var(--acc)">0.5</span></label><input type="range" id="noise-int" min="0" max="100" value="50" oninput="updateNoise()"></div>
<div class="field"><label>Scale <span id="noise-sc-val" style="color:var(--acc)">100%</span></label><input type="range" id="noise-sc" min="20" max="300" value="100" oninput="updateNoise()"></div>
<div class="field"><label>BG Color</label><input type="color" id="noise-bg" value="#1a1a26" oninput="updateNoise()"></div>
</div>
<div class="preview-box preview-full" id="noise-preview" style="min-height:200px"></div>
<div class="actions"><button class="btn btn-primary" onclick="insertNoise()">+ Insert</button><button class="btn btn-secondary" onclick="copyFrom('noise-out',this)">Copy CSS</button></div>
<div class="output"><div class="output-bar"><span>CSS + SVG</span><button class="btn btn-copy btn-sm" onclick="copyFrom('noise-out',this)">Copy</button></div><div class="output-body" id="noise-out"></div></div>
</template>

<template id="tmpl-mesh">
<div class="row4">
<div class="field"><label>Color 1</label><input type="color" id="mesh-c1" value="#a855f7" oninput="updateMesh()"></div>
<div class="field"><label>Color 2</label><input type="color" id="mesh-c2" value="#ec4899" oninput="updateMesh()"></div>
<div class="field"><label>Color 3</label><input type="color" id="mesh-c3" value="#06b6d4" oninput="updateMesh()"></div>
<div class="field"><label>Color 4</label><input type="color" id="mesh-c4" value="#10b981" oninput="updateMesh()"></div>
</div>
<div class="preview-box preview-full" id="mesh-preview" style="min-height:260px;border-radius:16px"></div>
<div class="actions"><button class="btn btn-primary" onclick="applyMesh()">Apply</button><button class="btn btn-secondary" onclick="insertMesh()">+ Insert</button><button class="btn btn-secondary" onclick="randomMesh()">Random</button></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('mesh-out',this)">Copy</button></div><div class="output-body" id="mesh-out"></div></div>
</template>

<template id="tmpl-sizes">
<div class="field"><label>Filter</label><div class="chips" id="size-filter" data-fn="renderSizes">
<div class="chip on" data-v="all">All</div><div class="chip" data-v="social">Social</div><div class="chip" data-v="video">Video</div><div class="chip" data-v="print">Print</div><div class="chip" data-v="web">Web</div>
</div></div>
<div id="sizes-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:16px"></div>
</template>

<template id="tmpl-contrast">
<div class="row">
<div class="field"><label>Text Color</label><div style="display:flex;gap:8px;align-items:center"><input type="color" id="con-fg" value="#ffffff" oninput="updateContrast()"><input type="text" id="con-fg-t" value="#ffffff" style="flex:1" oninput="document.getElementById('con-fg').value=this.value;updateContrast()"></div></div>
<div class="field"><label>Background</label><div style="display:flex;gap:8px;align-items:center"><input type="color" id="con-bg" value="#1a1a26" oninput="updateContrast()"><input type="text" id="con-bg-t" value="#1a1a26" style="flex:1" oninput="document.getElementById('con-bg').value=this.value;updateContrast()"></div></div>
</div>
<button class="btn btn-secondary btn-sm" onclick="const a=gv('con-fg');document.getElementById('con-fg').value=gv('con-bg');document.getElementById('con-bg').value=a;document.getElementById('con-fg-t').value=gv('con-fg');document.getElementById('con-bg-t').value=gv('con-bg');updateContrast()" style="margin-bottom:16px">Swap</button>
<div class="preview-box preview-lg" id="con-preview" style="flex-direction:column;gap:8px;padding:32px">
<div id="con-large" style="font-size:24px;font-weight:700;font-family:var(--head)">Large Text (24px)</div>
<div id="con-normal" style="font-size:16px">Normal body text at 16px for readability testing</div>
<div id="con-small" style="font-size:12px">Small text at 12px — fine print and captions</div>
</div>
<div class="score-grid" style="margin-top:16px" id="con-results"></div>
</template>

<template id="tmpl-colorconv">
<div class="row">
<div class="field"><label>Pick a Color</label><input type="color" id="cc-picker" value="#a855f7" oninput="convertColor(this.value)" style="width:100%;height:60px"></div>
<div class="field"><label>Or Enter HEX</label><input type="text" id="cc-hex" value="#a855f7" oninput="convertColor(this.value)"></div>
</div>
<div class="preview-box" id="cc-preview" style="min-height:80px;border-radius:12px;margin-bottom:16px"></div>
<div class="score-grid" id="cc-results"></div>
</template>

<template id="tmpl-radius">
<div class="preview-box preview-lg" style="padding:40px"><div id="rad-target" style="width:200px;height:140px;background:linear-gradient(135deg,var(--acc),var(--pink));transition:border-radius .2s"></div></div>
<div class="row" style="margin-top:16px">
<div class="field"><label>Top Left <span id="rad-tl-val" style="color:var(--acc)">16px</span></label><input type="range" id="rad-tl" min="0" max="100" value="16" oninput="updateRadius()"></div>
<div class="field"><label>Top Right <span id="rad-tr-val" style="color:var(--acc)">16px</span></label><input type="range" id="rad-tr" min="0" max="100" value="16" oninput="updateRadius()"></div>
</div>
<div class="row">
<div class="field"><label>Bottom Right <span id="rad-br-val" style="color:var(--acc)">16px</span></label><input type="range" id="rad-br" min="0" max="100" value="16" oninput="updateRadius()"></div>
<div class="field"><label>Bottom Left <span id="rad-bl-val" style="color:var(--acc)">16px</span></label><input type="range" id="rad-bl" min="0" max="100" value="16" oninput="updateRadius()"></div>
</div>
<div class="field"><label>Presets</label><div class="chips" id="rad-presets">
<div class="chip" onclick="setRadius(16,16,16,16)">Rounded</div><div class="chip" onclick="setRadius(50,50,50,50)">Pill</div><div class="chip" onclick="setRadius(0,0,0,0)">Sharp</div><div class="chip" onclick="setRadius(30,0,30,0)">Leaf</div><div class="chip" onclick="setRadius(50,0,50,0)">Blob</div><div class="chip" onclick="setRadius(0,20,0,20)">Slant</div>
</div></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('rad-out',this)">Copy</button></div><div class="output-body" id="rad-out"></div></div>
</template>

<template id="tmpl-filters">
<div class="preview-box preview-lg" style="padding:20px"><div id="filter-target" style="width:260px;height:160px;background:linear-gradient(135deg,#a855f7,#ec4899,#06b6d4);border-radius:16px;display:flex;align-items:center;justify-content:center;font-family:var(--head);font-size:20px;font-weight:700;transition:filter .15s">Preview</div></div>
<div class="row" style="margin-top:16px">
<div class="field"><label>Blur <span id="f-blur-v" style="color:var(--acc)">0px</span></label><input type="range" id="f-blur" min="0" max="20" value="0" oninput="updateFilters()"></div>
<div class="field"><label>Brightness <span id="f-bright-v" style="color:var(--acc)">100%</span></label><input type="range" id="f-bright" min="0" max="300" value="100" oninput="updateFilters()"></div>
</div>
<div class="row">
<div class="field"><label>Contrast <span id="f-contrast-v" style="color:var(--acc)">100%</span></label><input type="range" id="f-contrast" min="0" max="300" value="100" oninput="updateFilters()"></div>
<div class="field"><label>Saturate <span id="f-sat-v" style="color:var(--acc)">100%</span></label><input type="range" id="f-sat" min="0" max="300" value="100" oninput="updateFilters()"></div>
</div>
<div class="row">
<div class="field"><label>Hue Rotate <span id="f-hue-v" style="color:var(--acc)">0°</span></label><input type="range" id="f-hue" min="0" max="360" value="0" oninput="updateFilters()"></div>
<div class="field"><label>Grayscale <span id="f-gray-v" style="color:var(--acc)">0%</span></label><input type="range" id="f-gray" min="0" max="100" value="0" oninput="updateFilters()"></div>
</div>
<div class="row">
<div class="field"><label>Sepia <span id="f-sepia-v" style="color:var(--acc)">0%</span></label><input type="range" id="f-sepia" min="0" max="100" value="0" oninput="updateFilters()"></div>
<div class="field"><label>Invert <span id="f-inv-v" style="color:var(--acc)">0%</span></label><input type="range" id="f-inv" min="0" max="100" value="0" oninput="updateFilters()"></div>
</div>
<button class="btn btn-secondary btn-sm" onclick="document.querySelectorAll('#tool-filters input[type=range]').forEach(r=>{r.value=r.id==='f-bright'||r.id==='f-contrast'||r.id==='f-sat'?100:0});updateFilters()" style="margin-top:8px">↻ Reset All</button>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('filter-out',this)">Copy</button></div><div class="output-body" id="filter-out"></div></div>
</template>

<template id="tmpl-textgrad">
<div class="field"><label>Your Text</label><input type="text" id="tg-text" value="Gradient Text" oninput="updateTextGrad()"></div>
<div class="row">
<div class="field"><label>Color 1</label><input type="color" id="tg-c1" value="#a855f7" oninput="updateTextGrad()"></div>
<div class="field"><label>Color 2</label><input type="color" id="tg-c2" value="#ec4899" oninput="updateTextGrad()"></div>
</div>
<div class="row">
<div class="field"><label>Color 3 (optional)</label><input type="color" id="tg-c3" value="#06b6d4"><label style="margin-top:4px"><input type="checkbox" id="tg-c3on" onchange="updateTextGrad()"> Enable</label></div>
<div class="field"><label>Angle <span id="tg-angle-val" style="color:var(--acc)">90°</span></label><input type="range" id="tg-angle" min="0" max="360" value="90" oninput="updateTextGrad()"></div>
</div>
<div class="field"><label>Font Size <span id="tg-size-val" style="color:var(--acc)">64px</span></label><input type="range" id="tg-size" min="24" max="120" value="64" oninput="updateTextGrad()"></div>
<div class="preview-box preview-lg" style="padding:24px"><div id="tg-preview" style="font-family:var(--head);font-weight:800;text-align:center;line-height:1.2"></div></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('tg-out',this)">Copy</button></div><div class="output-body" id="tg-out"></div></div>
</template>

<template id="tmpl-icons">
<div class="field"><input type="text" id="icon-search" placeholder="🔍 Search icons..." oninput="renderIcons()"></div>
<div class="row">
<div class="field"><label>Size <span id="icon-sz-val" style="color:var(--acc)">24px</span></label><input type="range" id="icon-sz" min="16" max="64" value="24" oninput="renderIcons()"></div>
<div class="field"><label>Stroke Width <span id="icon-sw-val" style="color:var(--acc)">2</span></label><input type="range" id="icon-sw" min="1" max="4" value="2" step="0.5" oninput="renderIcons()"></div>
</div>
<div id="icon-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(64px,1fr));gap:6px;margin-top:8px;max-height:300px;overflow-y:auto"></div>
</template>

<template id="tmpl-blob">
<div class="row3">
<div class="field"><label>Complexity <span id="blob-comp-val" style="color:var(--acc)">6</span></label><input type="range" id="blob-comp" min="3" max="12" value="6" oninput="genBlob()"></div>
<div class="field"><label>Randomness <span id="blob-rand-val" style="color:var(--acc)">50%</span></label><input type="range" id="blob-rand" min="10" max="100" value="50" oninput="genBlob()"></div>
<div class="field"><label>Fill Color</label><input type="color" id="blob-fill" value="#a855f7" oninput="genBlob()"></div>
</div>
<div class="preview-box preview-lg" style="padding:20px"><svg id="blob-svg" viewBox="0 0 200 200" width="240" height="240"></svg></div>
<div class="actions"><button class="btn btn-primary" onclick="insertBlob()">+ Insert</button><button class="btn btn-secondary" onclick="genBlob()">Randomize</button><button class="btn btn-secondary" onclick="copyFrom('blob-out',event.target)">Copy SVG</button></div>
<div class="output"><div class="output-bar"><span>SVG</span><button class="btn btn-copy btn-sm" onclick="copyFrom('blob-out',this)">Copy</button></div><div class="output-body" id="blob-out"></div></div>
</template>

<template id="tmpl-wave">
<div class="row">
<div class="field"><label>Frequency <span id="wave-freq-val" style="color:var(--acc)">2.0</span></label><input type="range" id="wave-freq" min="5" max="80" value="20" oninput="genWave()"></div>
<div class="field"><label>Amplitude <span id="wave-amp-val" style="color:var(--acc)">30px</span></label><input type="range" id="wave-amp" min="0" max="100" value="30" oninput="genWave()"></div>
</div>
<div class="row">
<div class="field"><label>Phase <span id="wave-phase-val" style="color:var(--acc)">0°</span></label><input type="range" id="wave-phase" min="0" max="360" value="0" oninput="genWave()"></div>
<div class="field"><label>Y Offset <span id="wave-yoff-val" style="color:var(--acc)">50%</span></label><input type="range" id="wave-yoff" min="10" max="90" value="50" oninput="genWave()"></div>
</div>
<div class="row3">
<div class="field"><label>Height <span id="wave-h-val" style="color:var(--acc)">150px</span></label><input type="range" id="wave-h" min="60" max="300" value="150" oninput="genWave()"></div>
<div class="field"><label>Layers <span id="wave-n-val" style="color:var(--acc)">2</span></label><input type="range" id="wave-n" min="1" max="4" value="2" oninput="genWave()"></div>
<div class="field"><label>Color</label><input type="color" id="wave-color" value="#a855f7" oninput="genWave()"></div>
</div>
<div class="row">
<div class="field"><label>Waveform</label><select id="wave-style" onchange="genWave()"><option value="sine">Sine</option><option value="triangle">Triangle</option><option value="square">Square</option><option value="sawtooth">Sawtooth</option></select></div>
<div class="field"><label>Flip</label><select id="wave-flip" onchange="genWave()"><option value="no">Normal</option><option value="flipY">Flip ↕</option><option value="flipX">Flip ↔</option><option value="flipXY">Flip Both</option><option value="rot90">Rotate 90°</option><option value="rot270">Rotate 270°</option></select></div>
</div>
<div style="background:var(--bg3);border:1px solid var(--bdr);border-radius:12px;overflow:hidden;margin-top:12px;line-height:0;position:relative" id="wave-preview"></div>
<div class="actions"><button class="btn btn-primary" onclick="insertWave()">+ Insert</button><button class="btn btn-secondary" onclick="randomizeWave()">Randomize</button></div>
<div class="output"><div class="output-bar"><span>SVG</span><button class="btn btn-copy btn-sm" onclick="copyFrom('wave-out',this)">Copy</button></div><div class="output-body" id="wave-out"></div></div>
</template>

<template id="tmpl-align">
<div class="field"><label>Position</label>
<div style="display:flex;gap:8px;align-items:start">
<div style="display:grid;grid-template-columns:repeat(3,28px);grid-template-rows:repeat(3,28px);gap:2px;flex-shrink:0">
<button class="tm-align" onclick="alignBlock('top');alignBlock('left')" title="Top Left" style="font-size:10px;padding:0">↖</button>
<button class="tm-align" onclick="alignBlock('top');alignBlock('centerH')" title="Top Center" style="font-size:10px;padding:0">↑</button>
<button class="tm-align" onclick="alignBlock('top');alignBlock('right')" title="Top Right" style="font-size:10px;padding:0">↗</button>
<button class="tm-align" onclick="alignBlock('centerV');alignBlock('left')" title="Middle Left" style="font-size:10px;padding:0">←</button>
<button class="tm-align" onclick="alignBlock('centerV');alignBlock('centerH')" title="Center" style="font-size:10px;padding:0;color:var(--acc)">+</button>
<button class="tm-align" onclick="alignBlock('centerV');alignBlock('right')" title="Middle Right" style="font-size:10px;padding:0">→</button>
<button class="tm-align" onclick="alignBlock('bottom');alignBlock('left')" title="Bottom Left" style="font-size:10px;padding:0">↙</button>
<button class="tm-align" onclick="alignBlock('bottom');alignBlock('centerH')" title="Bottom Center" style="font-size:10px;padding:0">↓</button>
<button class="tm-align" onclick="alignBlock('bottom');alignBlock('right')" title="Bottom Right" style="font-size:10px;padding:0">↘</button>
</div>
<div style="flex:1;display:grid;grid-template-columns:1fr 1fr;gap:3px">
<div><label style="font-size:7px;color:var(--dim);display:block">X</label><input type="number" id="al-x" value="0" oninput="setBlockPos()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
<div><label style="font-size:7px;color:var(--dim);display:block">Y</label><input type="number" id="al-y" value="0" oninput="setBlockPos()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
<div><label style="font-size:7px;color:var(--dim);display:block">W</label><input type="number" id="al-w" value="100" oninput="setBlockSize()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
<div><label style="font-size:7px;color:var(--dim);display:block">H</label><input type="number" id="al-h" value="100" oninput="setBlockSize()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
</div>
</div>
</div>
<div class="field"><label>Quick Size</label>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="sizeBlock('fullW')">Full W</button>
<button class="tm-align" onclick="sizeBlock('fullH')">Full H</button>
<button class="tm-align" onclick="sizeBlock('full')">Fill</button>
<button class="tm-align" onclick="sizeBlock('half')">½</button>
<button class="tm-align" onclick="sizeBlock('third')">⅓</button>
<button class="tm-align" onclick="sizeBlock('square')">1:1</button>
</div>
</div>
<div class="field"><label>Distribute All Blocks</label>
<div style="display:flex;gap:4px">
<button class="tm-align" onclick="distributeBlocks('h')" style="flex:1">↔ Horizontal</button>
<button class="tm-align" onclick="distributeBlocks('v')" style="flex:1">↕ Vertical</button>
</div>
</div>
</template>

<template id="tmpl-padmar">
<div class="field"><label>Padding</label>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;align-items:end">
<div><label style="font-size:7px;color:var(--dim);text-align:center;display:block">Top</label><input type="number" id="pm-pt" value="0" min="0" oninput="pmApply()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
<div><label style="font-size:7px;color:var(--dim);text-align:center;display:block">Right</label><input type="number" id="pm-pr" value="0" min="0" oninput="pmApply()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
<div><label style="font-size:7px;color:var(--dim);text-align:center;display:block">Bottom</label><input type="number" id="pm-pb" value="0" min="0" oninput="pmApply()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
<div><label style="font-size:7px;color:var(--dim);text-align:center;display:block">Left</label><input type="number" id="pm-pl" value="0" min="0" oninput="pmApply()" style="width:100%;font-family:var(--mono);font-size:10px;text-align:center"></div>
</div>
<div style="display:flex;gap:4px;margin-top:6px">
<button class="tm-align" onclick="pmPadAll(0)">0</button>
<button class="tm-align" onclick="pmPadAll(8)">8</button>
<button class="tm-align" onclick="pmPadAll(16)">16</button>
<button class="tm-align" onclick="pmPadAll(24)">24</button>
<button class="tm-align" onclick="pmPadAll(32)">32</button>
<button class="tm-align" onclick="pmPadAll(48)">48</button>
</div>
</div>
<div class="field"><label>Display</label>
<div style="display:flex;gap:4px;flex-wrap:wrap">
<button class="tm-align" onclick="pmDisplay('block')">Block</button>
<button class="tm-align" onclick="pmDisplay('flex')">Flex</button>
<button class="tm-align" onclick="pmDisplay('grid')">Grid</button>
<button class="tm-align" onclick="pmDisplay('inline-flex')">Inline Flex</button>
</div>
</div>
<div class="field" id="pm-flex-ctrls" style="display:none"><label>Flex Direction</label>
<div style="display:flex;gap:4px">
<button class="tm-align" onclick="pmFlex('row')">→ Row</button>
<button class="tm-align" onclick="pmFlex('column')">↓ Column</button>
<button class="tm-align" onclick="pmFlex('row-reverse')">← Row Rev</button>
<button class="tm-align" onclick="pmFlex('column-reverse')">↑ Col Rev</button>
</div>
</div>
<div class="field" id="pm-justify-ctrls" style="display:none"><label>Justify</label>
<div style="display:flex;gap:4px;flex-wrap:wrap">
<button class="tm-align" onclick="pmJustify('flex-start')">Start</button>
<button class="tm-align" onclick="pmJustify('center')">Center</button>
<button class="tm-align" onclick="pmJustify('flex-end')">End</button>
<button class="tm-align" onclick="pmJustify('space-between')">Between</button>
<button class="tm-align" onclick="pmJustify('space-around')">Around</button>
</div>
</div>
<div class="field" id="pm-items-ctrls" style="display:none"><label>Align Items</label>
<div style="display:flex;gap:4px">
<button class="tm-align" onclick="pmAlignItems('flex-start')">Start</button>
<button class="tm-align" onclick="pmAlignItems('center')">Center</button>
<button class="tm-align" onclick="pmAlignItems('flex-end')">End</button>
<button class="tm-align" onclick="pmAlignItems('stretch')">Stretch</button>
</div>
</div>
<div class="field"><label>Gap <span id="pm-gap-v" style="color:var(--acc)">0px</span></label>
<input type="range" id="pm-gap" min="0" max="40" value="0" oninput="pmApply()">
</div>
<div class="field"><label>Overflow</label>
<div style="display:flex;gap:4px">
<button class="tm-align" onclick="pmOverflow('visible')">Visible</button>
<button class="tm-align" onclick="pmOverflow('hidden')">Hidden</button>
<button class="tm-align" onclick="pmOverflow('auto')">Scroll</button>
</div>
</div>
</template>

<template id="tmpl-pagesize">
<div class="field"><label>Canvas Size</label>
<div style="display:flex;gap:6px;align-items:end">
<div><label style="font-size:7px;color:var(--dim);display:block">Width</label><input type="number" id="pg-w" value="1280" oninput="resizePage()" style="width:80px;font-family:var(--mono);font-size:10px;text-align:center"></div>
<span style="font-size:10px;color:var(--dim);padding-bottom:4px">×</span>
<div><label style="font-size:7px;color:var(--dim);display:block">Height</label><input type="number" id="pg-h" value="900" oninput="resizePage()" style="width:80px;font-family:var(--mono);font-size:10px;text-align:center"></div>
</div>
</div>
<div class="field"><label>Page Templates</label>
<div style="display:flex;flex-direction:column;gap:3px">
<div style="font-size:7px;color:var(--dim);font-weight:700;letter-spacing:1px;margin-top:4px">WEBPAGE</div>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="scaffoldPage('landing')">Landing Page</button>
<button class="tm-align" onclick="scaffoldPage('hero')">Hero Section</button>
<button class="tm-align" onclick="scaffoldPage('blog')">Blog Post</button>
<button class="tm-align" onclick="scaffoldPage('portfolio')">Portfolio</button>
<button class="tm-align" onclick="scaffoldPage('email')">Email</button>
<button class="tm-align" onclick="scaffoldPage('pricing')">Pricing</button>
</div>
<div style="font-size:7px;color:var(--dim);font-weight:700;letter-spacing:1px;margin-top:8px">DEVICE</div>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="scaffoldPage('mobile')">Mobile App</button>
<button class="tm-align" onclick="scaffoldPage('tablet')">Tablet</button>
<button class="tm-align" onclick="scaffoldPage('desktop')">Desktop HD</button>
</div>
<div style="font-size:7px;color:var(--dim);font-weight:700;letter-spacing:1px;margin-top:8px">SOCIAL</div>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="scaffoldPage('igpost')">IG Post</button>
<button class="tm-align" onclick="scaffoldPage('igstory')">IG Story</button>
<button class="tm-align" onclick="scaffoldPage('ogimage')">OG Image</button>
<button class="tm-align" onclick="scaffoldPage('ytthumb')">YT Thumb</button>
</div>
<div style="font-size:7px;color:var(--dim);font-weight:700;letter-spacing:1px;margin-top:8px">BLANK</div>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="setPageSize(1280,900)">1280×900</button>
<button class="tm-align" onclick="setPageSize(1920,1080)">1920×1080</button>
<button class="tm-align" onclick="setPageSize(390,844)">iPhone</button>
<button class="tm-align" onclick="setPageSize(1080,1080)">Square</button>
</div>
</div>
</div>
</template>

<template id="tmpl-grid">
<div class="row3">
<div class="field"><label>Columns <span id="grid-cols-val" style="color:var(--acc)">3</span></label><input type="range" id="grid-cols" min="1" max="8" value="3" oninput="updateGrid()"></div>
<div class="field"><label>Rows <span id="grid-rows-val" style="color:var(--acc)">2</span></label><input type="range" id="grid-rows" min="1" max="6" value="2" oninput="updateGrid()"></div>
<div class="field"><label>Gap <span id="grid-gap-val" style="color:var(--acc)">12px</span></label><input type="range" id="grid-gap" min="0" max="40" value="12" oninput="updateGrid()"></div>
</div>
<div class="row">
<div class="field"><label>Column Sizing</label><select id="grid-col-size" onchange="updateGrid()"><option value="1fr">Equal (1fr)</option><option value="auto">Auto</option><option value="minmax(150px,1fr)">Responsive</option></select></div>
<div class="field"><label>Row Height</label><select id="grid-row-size" onchange="updateGrid()"><option value="auto">Auto</option><option value="100px">100px</option><option value="150px">150px</option><option value="1fr">Equal (1fr)</option></select></div>
</div>
<div class="preview-box" style="padding:16px;min-height:200px"><div id="grid-preview" style="width:100%"></div></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('grid-out',this)">Copy</button></div><div class="output-body" id="grid-out"></div></div>
</template>

<template id="tmpl-ratio">
<div class="row3">
<div class="field"><label>Width</label><input type="number" id="ar-w" value="1920" oninput="calcRatio('w')"></div>
<div class="field"><label>Height</label><input type="number" id="ar-h" value="1080" oninput="calcRatio('h')"></div>
<div class="field"><label>Ratio</label><input type="text" id="ar-ratio" value="16:9" readonly style="text-align:center;font-family:var(--mono);font-size:16px;font-weight:700;color:var(--acc)"></div>
</div>
<div class="fs" style="margin-top:20px"><div class="fst">Resize Keeping Ratio</div>
<div class="row">
<div class="field"><label>New Width</label><input type="number" id="ar-nw" placeholder="Enter width..." oninput="resizeRatio('w')"></div>
<div class="field"><label>New Height</label><input type="number" id="ar-nh" placeholder="Enter height..." oninput="resizeRatio('h')"></div>
</div></div>
<div class="field"><label>Common Ratios</label><div class="chips" id="ar-presets">
<div class="chip" onclick="setRatio(1,1)">1:1</div><div class="chip" onclick="setRatio(4,3)">4:3</div><div class="chip" onclick="setRatio(16,9)">16:9</div><div class="chip" onclick="setRatio(21,9)">21:9</div><div class="chip" onclick="setRatio(9,16)">9:16</div><div class="chip" onclick="setRatio(3,2)">3:2</div>
</div></div>
</template>

<template id="tmpl-units">
<div class="field"><label>Base Font Size <span id="unit-base-val" style="color:var(--acc)">16px</span></label><input type="range" id="unit-base" min="10" max="24" value="16" oninput="convertUnits()"></div>
<div class="field"><label>Viewport Width (for vw)</label><input type="number" id="unit-vw" value="1920" oninput="convertUnits()" style="width:160px"></div>
<div class="row">
<div class="field"><label>Enter Value</label><input type="number" id="unit-val" value="16" oninput="convertUnits()"></div>
<div class="field"><label>Unit</label><select id="unit-from" onchange="convertUnits()"><option>px</option><option>rem</option><option>em</option><option>pt</option><option>vw</option></select></div>
</div>
<div class="score-grid" id="unit-results" style="margin-top:16px"></div>
</template>

<template id="tmpl-placeholder">
<div class="row3">
<div class="field"><label>Width</label><input type="number" id="ph-w" value="600" oninput="updatePlaceholder()"></div>
<div class="field"><label>Height</label><input type="number" id="ph-h" value="400" oninput="updatePlaceholder()"></div>
<div class="field"><label>Text</label><input type="text" id="ph-text" value="" placeholder="auto: 600×400" oninput="updatePlaceholder()"></div>
</div>
<div class="row3">
<div class="field"><label>BG Color</label><input type="color" id="ph-bg" value="#2a2a38" oninput="updatePlaceholder()"></div>
<div class="field"><label>Text Color</label><input type="color" id="ph-fg" value="#8888a0" oninput="updatePlaceholder()"></div>
<div class="field"><label>Font Size <span id="ph-fs-val" style="color:var(--acc)">24px</span></label><input type="range" id="ph-fs" min="10" max="80" value="24" oninput="updatePlaceholder()"></div>
</div>
<div class="preview-box preview-lg" style="padding:16px"><canvas id="ph-canvas" style="max-width:100%;border-radius:8px"></canvas></div>
<div class="actions"><button class="btn btn-primary" onclick="downloadPlaceholder()">⬇ Download PNG</button></div>
</template>

<template id="tmpl-neumorph">
<div class="preview-box preview-lg" id="neu-wrap" style="padding:40px">
<div id="neu-target" style="width:200px;height:140px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-family:var(--head);font-weight:700;color:var(--t3)">Element</div>
</div>
<div class="row" style="margin-top:16px">
<div class="field"><label>BG Color</label><input type="color" id="neu-bg" value="#1a1a26" oninput="updateNeu()"></div>
<div class="field"><label>Intensity <span id="neu-int-val" style="color:var(--acc)">15</span></label><input type="range" id="neu-int" min="2" max="40" value="15" oninput="updateNeu()"></div>
</div>
<div class="row">
<div class="field"><label>Blur <span id="neu-blur-val" style="color:var(--acc)">30px</span></label><input type="range" id="neu-blur" min="5" max="80" value="30" oninput="updateNeu()"></div>
<div class="field"><label>Distance <span id="neu-dist-val" style="color:var(--acc)">10px</span></label><input type="range" id="neu-dist" min="2" max="30" value="10" oninput="updateNeu()"></div>
</div>
<div class="field"><label>Shape</label><div class="chips" id="neu-shape" data-fn="updateNeu"><div class="chip on" data-v="flat">Flat</div><div class="chip" data-v="concave">Concave</div><div class="chip" data-v="convex">Convex</div><div class="chip" data-v="inset">Pressed</div></div></div>
<div class="field"><label>Radius <span id="neu-rad-val" style="color:var(--acc)">20px</span></label><input type="range" id="neu-rad" min="0" max="50" value="20" oninput="updateNeu()"></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('neu-out',this)">Copy</button></div><div class="output-body" id="neu-out"></div></div>
</template>

<template id="tmpl-animblock">
<div class="field"><label>Trigger</label>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align ab-trig active" data-v="load" onclick="abTrigger('load')">Load</button>
<button class="tm-align ab-trig" data-v="view" onclick="abTrigger('view')">In View</button>
<button class="tm-align ab-trig" data-v="view-loop" onclick="abTrigger('view-loop')">View Loop</button>
<button class="tm-align ab-trig" data-v="hover" onclick="abTrigger('hover')">Hover</button>
<button class="tm-align ab-trig" data-v="hover-loop" onclick="abTrigger('hover-loop')">Hover Loop</button>
<button class="tm-align ab-trig" data-v="click" onclick="abTrigger('click')">Click</button>
<button class="tm-align ab-trig" data-v="dblclick" onclick="abTrigger('dblclick')">Dbl Click</button>
<button class="tm-align ab-trig" data-v="scroll" onclick="abTrigger('scroll')">Scroll</button>
</div>
</div>
<div class="field"><label>Animation</label>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="abApply('fadeIn')">Fade In</button>
<button class="tm-align" onclick="abApply('fadeOut')">Fade Out</button>
<button class="tm-align" onclick="abApply('slideUp')">Slide Up</button>
<button class="tm-align" onclick="abApply('slideDown')">Slide Down</button>
<button class="tm-align" onclick="abApply('slideLeft')">Slide Left</button>
<button class="tm-align" onclick="abApply('slideRight')">Slide Right</button>
<button class="tm-align" onclick="abApply('scaleIn')">Scale In</button>
<button class="tm-align" onclick="abApply('bounce')">Bounce</button>
<button class="tm-align" onclick="abApply('pulse')">Pulse</button>
<button class="tm-align" onclick="abApply('shake')">Shake</button>
<button class="tm-align" onclick="abApply('rotate')">Rotate</button>
<button class="tm-align" onclick="abApply('flip')">Flip</button>
<button class="tm-align" onclick="abApply('swing')">Swing</button>
<button class="tm-align" onclick="abApply('rubberBand')">Rubber</button>
<button class="tm-align" onclick="abApply('jello')">Jello</button>
<button class="tm-align" onclick="abApply('heartbeat')">Heartbeat</button>
<button class="tm-align" onclick="abApply('flash')">Flash</button>
<button class="tm-align" onclick="abApply('float')">Float</button>
</div>
</div>
<div class="field"><label>Duration <span id="ab-dur-v" style="color:var(--acc)">0.6s</span></label>
<input type="range" id="ab-dur" min="1" max="40" value="6" oninput="abUpdate()">
</div>
<div class="field"><label>Delay <span id="ab-delay-v" style="color:var(--acc)">0s</span></label>
<input type="range" id="ab-delay" min="0" max="30" value="0" oninput="abUpdate()">
</div>
<div class="field"><label>Loop</label>
<div style="display:flex;gap:3px">
<button class="tm-align" onclick="abIter('1')">Once</button>
<button class="tm-align" onclick="abIter('2')">2×</button>
<button class="tm-align" onclick="abIter('3')">3×</button>
<button class="tm-align" onclick="abIter('infinite')">∞ Loop</button>
</div>
</div>
<div class="field"><label>Easing</label>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="abEase('ease')">Ease</button>
<button class="tm-align" onclick="abEase('ease-out')">Ease Out</button>
<button class="tm-align" onclick="abEase('ease-in-out')">In-Out</button>
<button class="tm-align" onclick="abEase('linear')">Linear</button>
<button class="tm-align" onclick="abEase('cubic-bezier(0.68,-0.55,0.27,1.55)')">Spring</button>
</div>
</div>
<div style="display:flex;gap:4px;margin-top:8px">
<button class="btn btn-primary" onclick="abReplay()" style="flex:1">▶ Replay</button>
<button class="btn btn-secondary" onclick="abRemove()" style="flex:1">✕ Remove</button>
</div>
</template>

<template id="tmpl-transitions">
<div class="field"><label>Hover Effect</label>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="trApply('scale','transform:scale(1.05)')">Grow</button>
<button class="tm-align" onclick="trApply('shrink','transform:scale(0.95)')">Shrink</button>
<button class="tm-align" onclick="trApply('lift','transform:translateY(-4px);box-shadow:0 8px 25px rgba(0,0,0,.3)')">Lift</button>
<button class="tm-align" onclick="trApply('glow','box-shadow:0 0 20px var(--p)')">Glow</button>
<button class="tm-align" onclick="trApply('bright','filter:brightness(1.2)')">Brighten</button>
<button class="tm-align" onclick="trApply('dim','opacity:0.7')">Dim</button>
<button class="tm-align" onclick="trApply('tiltL','transform:rotate(-3deg)')">Tilt Left</button>
<button class="tm-align" onclick="trApply('tiltR','transform:rotate(3deg)')">Tilt Right</button>
</div>
</div>
<div class="field"><label>Transition Speed <span id="tr-speed-v" style="color:var(--acc)">0.3s</span></label>
<input type="range" id="tr-speed" min="1" max="10" value="3" oninput="st('tr-speed-v',(this.value/10).toFixed(1)+'s');trUpdate()">
</div>
<div class="field"><label>Cursor on Hover</label>
<div style="display:flex;gap:3px;flex-wrap:wrap">
<button class="tm-align" onclick="trCursor('pointer')">Pointer</button>
<button class="tm-align" onclick="trCursor('grab')">Grab</button>
<button class="tm-align" onclick="trCursor('crosshair')">Crosshair</button>
<button class="tm-align" onclick="trCursor('default')">Default</button>
</div>
</div>
<div style="margin-top:8px">
<button class="btn btn-secondary" onclick="trRemove()" style="width:100%">✕ Remove Hover Effects</button>
</div>
</template>

<template id="tmpl-animate">
<div class="field"><label>Animation Preset</label><select id="anim-preset" onchange="updateAnim()">
<option value="fadeIn">Fade In</option><option value="fadeOut">Fade Out</option><option value="slideUp">Slide Up</option><option value="slideDown">Slide Down</option><option value="slideLeft">Slide Left</option><option value="slideRight">Slide Right</option>
<option value="scaleIn">Scale In</option><option value="scaleOut">Scale Out</option><option value="rotate">Rotate 360</option><option value="bounce">Bounce</option><option value="pulse">Pulse</option><option value="shake">Shake</option>
<option value="flip">Flip</option><option value="swing">Swing</option><option value="rubberBand">Rubber Band</option><option value="jello">Jello</option><option value="heartbeat">Heartbeat</option><option value="flash">Flash</option>
</select></div>
<div class="row3">
<div class="field"><label>Duration <span id="anim-dur-val" style="color:var(--acc)">0.6s</span></label><input type="range" id="anim-dur" min="1" max="30" value="6" oninput="updateAnim()"></div>
<div class="field"><label>Delay <span id="anim-delay-val" style="color:var(--acc)">0s</span></label><input type="range" id="anim-delay" min="0" max="20" value="0" oninput="updateAnim()"></div>
<div class="field"><label>Iterations</label><select id="anim-iter" onchange="updateAnim()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="infinite">Infinite</option></select></div>
</div>
<div class="row">
<div class="field"><label>Easing</label><select id="anim-ease" onchange="updateAnim()"><option value="ease">ease</option><option value="ease-in">ease-in</option><option value="ease-out">ease-out</option><option value="ease-in-out">ease-in-out</option><option value="linear">linear</option><option value="cubic-bezier(0.68,-0.55,0.27,1.55)">spring</option></select></div>
<div class="field"><label>Fill Mode</label><select id="anim-fill" onchange="updateAnim()"><option value="forwards">forwards</option><option value="backwards">backwards</option><option value="both">both</option><option value="none">none</option></select></div>
</div>
<div class="preview-box preview-lg" style="padding:30px"><div id="anim-target" style="width:120px;height:80px;background:linear-gradient(135deg,var(--acc),var(--pink));border-radius:14px;display:flex;align-items:center;justify-content:center;font-family:var(--head);font-weight:700;font-size:14px">Preview</div></div>
<div class="actions"><button class="btn btn-primary" onclick="replayAnim()">▶ Replay</button></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('anim-out',this)">Copy</button></div><div class="output-body" id="anim-out"></div></div>
</template>

<template id="tmpl-cursor">
<div class="field"><label>Cursor Type</label><select id="cur-type" onchange="updateCursor()">
<option value="default">default</option><option value="pointer">pointer</option><option value="crosshair">crosshair</option><option value="move">move</option><option value="text">text</option><option value="wait">wait</option><option value="help">help</option><option value="not-allowed">not-allowed</option><option value="grab">grab</option><option value="grabbing">grabbing</option><option value="zoom-in">zoom-in</option><option value="zoom-out">zoom-out</option><option value="col-resize">col-resize</option><option value="row-resize">row-resize</option><option value="n-resize">n-resize</option><option value="e-resize">e-resize</option><option value="nesw-resize">nesw-resize</option><option value="nwse-resize">nwse-resize</option><option value="none">none (hidden)</option><option value="emoji">Custom Emoji</option>
</select></div>
<div class="field" id="cur-emoji-field" style="display:none"><label>Emoji / Text</label><input type="text" id="cur-emoji" value="→" oninput="updateCursor()" maxlength="2"></div>
<div class="field" id="cur-size-field" style="display:none"><label>Size <span id="cur-size-val" style="color:var(--acc)">32</span></label><input type="range" id="cur-size" min="16" max="64" value="32" oninput="updateCursor()"></div>
<div class="preview-box preview-lg" id="cur-preview" style="cursor:default;flex-direction:column;gap:8px">
<div style="font-family:var(--head);font-weight:700;font-size:18px">Hover here</div>
<div style="font-size:12px;color:var(--t3)">Move your cursor over this area to preview</div>
</div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('cur-out',this)">Copy</button></div><div class="output-body" id="cur-out"></div></div>
</template>

<template id="tmpl-clip">
<div class="field"><label>Shape Preset</label><select id="clip-preset" onchange="updateClip()">
<option value="triangle">Triangle</option><option value="trapezoid">Trapezoid</option><option value="parallelogram">Parallelogram</option><option value="rhombus">Rhombus</option><option value="pentagon">Pentagon</option><option value="hexagon">Hexagon</option><option value="octagon">Octagon</option><option value="star">Star</option>
<option value="arrow-right">Arrow Right</option><option value="arrow-left">Arrow Left</option><option value="chevron">Chevron</option><option value="cross">Cross</option><option value="frame">Frame</option>
<option value="circle">Circle</option><option value="ellipse">Ellipse</option><option value="inset">Inset/Rounded</option>
</select></div>
<div class="row" id="clip-inset-ctrls" style="display:none">
<div class="field"><label>Inset <span id="clip-inset-val" style="color:var(--acc)">10%</span></label><input type="range" id="clip-inset" min="0" max="45" value="10" oninput="updateClip()"></div>
<div class="field"><label>Radius <span id="clip-round-val" style="color:var(--acc)">10px</span></label><input type="range" id="clip-round" min="0" max="50" value="10" oninput="updateClip()"></div>
</div>
<div class="preview-box preview-lg" style="padding:20px"><div id="clip-target" style="width:260px;height:180px;background:linear-gradient(135deg,var(--acc),var(--pink),var(--cyan));transition:clip-path .3s"></div></div>
<div class="actions"><button class="btn btn-primary" onclick="applyClip()">Apply</button><button class="btn btn-secondary" onclick="insertClip()">+ Insert Shape</button><button class="btn btn-secondary" onclick="copyFrom('clip-out',event.target)">Copy CSS</button></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('clip-out',this)">Copy</button></div><div class="output-body" id="clip-out"></div></div>
</template>

<template id="tmpl-easing">
<div class="field"><label>Presets</label><div style="display:flex;flex-wrap:wrap;gap:6px">
<button class="btn btn-secondary btn-sm" onclick="setEase(0.25,0.1,0.25,1)">ease</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0.42,0,1,1)">ease-in</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0,0,0.58,1)">ease-out</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0.42,0,0.58,1)">ease-in-out</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0,0,1,1)">linear</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0.68,-0.55,0.27,1.55)">spring</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0.5,1.5,0.5,-0.5)">elastic</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0.76,0,0.24,1)">smooth</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0.22,1,0.36,1)">expo-out</button>
<button class="btn btn-secondary btn-sm" onclick="setEase(0.87,0,0.13,1)">expo-in-out</button>
</div></div>
<div class="row4" style="margin-top:12px">
<div class="field"><label>X1</label><input type="number" id="ez-x1" value="0.25" step="0.01" min="-0.5" max="1.5" oninput="drawEase()"></div>
<div class="field"><label>Y1</label><input type="number" id="ez-y1" value="0.1" step="0.01" min="-2" max="2" oninput="drawEase()"></div>
<div class="field"><label>X2</label><input type="number" id="ez-x2" value="0.25" step="0.01" min="-0.5" max="1.5" oninput="drawEase()"></div>
<div class="field"><label>Y2</label><input type="number" id="ez-y2" value="1" step="0.01" min="-2" max="2" oninput="drawEase()"></div>
</div>
<div class="preview-box" style="padding:20px;flex-direction:column;gap:16px">
<canvas id="ease-canvas" width="280" height="280" style="border-radius:8px"></canvas>
<div id="ease-ball-wrap" style="width:280px;height:30px;position:relative;background:var(--bg4);border-radius:15px;overflow:hidden"><div id="ease-ball" style="width:26px;height:26px;background:var(--acc);border-radius:50%;position:absolute;top:2px;left:2px;transition:left 1s"></div></div>
</div>
<div class="actions"><button class="btn btn-primary" onclick="playEase()">▶ Preview</button></div>
<div class="output"><div class="output-bar"><span>CSS</span><button class="btn btn-copy btn-sm" onclick="copyFrom('ease-out',this)">Copy</button></div><div class="output-body" id="ease-out"></div></div>
</template>

<template id="tmpl-spacing">
<div class="row3">
<div class="field"><label>Base Unit</label><input type="number" id="sp-base" value="8" min="1" max="20" oninput="genSpacing()"></div>
<div class="field"><label>Scale Type</label><select id="sp-type" onchange="genSpacing()"><option value="linear">Linear (×1,×2,×3...)</option><option value="fibonacci">Fibonacci</option><option value="golden">Golden Ratio (×1.618)</option><option value="power2">Power of 2</option></select></div>
<div class="field"><label>Steps</label><input type="number" id="sp-steps" value="10" min="4" max="16" oninput="genSpacing()"></div>
</div>
<div id="sp-preview" style="margin-top:16px"></div>
<div class="output"><div class="output-bar"><span>CSS Variables</span><button class="btn btn-copy btn-sm" onclick="copyFrom('sp-out',this)">Copy</button></div><div class="output-body" id="sp-out"></div></div>
</template>

<template id="tmpl-cbsim">
<div class="row">
<div class="field"><label>Color 1</label><input type="color" id="cb-c1" value="#a855f7" oninput="updateCBSim()"></div>
<div class="field"><label>Color 2</label><input type="color" id="cb-c2" value="#10b981" oninput="updateCBSim()"></div>
<div class="field"><label>Color 3</label><input type="color" id="cb-c3" value="#ef4444" oninput="updateCBSim()"></div>
<div class="field"><label>Color 4</label><input type="color" id="cb-c4" value="#f59e0b" oninput="updateCBSim()"></div>
</div>
<div id="cb-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px"></div>
</template>

<template id="tmpl-breakpoint">
<div class="field"><label>Framework</label><select id="bp-fw" onchange="renderBreakpoints()"><option value="tailwind">Tailwind CSS</option><option value="bootstrap">Bootstrap</option><option value="custom">Custom / Common</option></select></div>
<div id="bp-grid" style="margin-top:16px"></div>
<div class="output"><div class="output-bar"><span>CSS Media Queries</span><button class="btn btn-copy btn-sm" onclick="copyFrom('bp-out',this)">Copy</button></div><div class="output-body" id="bp-out"></div></div>
</template>

<template id="tmpl-codeeditor">
<div style="display:flex;flex-direction:column;height:100%">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<div style="display:flex;gap:4px;align-items:center">
<button class="tm-align" onclick="codeSyncFrom()" title="Pull current canvas into editor" style="font-size:8px">⬇ Pull from Canvas</button>
<button class="tm-align" onclick="codeRun()" title="Push code into canvas" style="background:rgba(16,185,129,.15);color:#10b981;border-color:rgba(16,185,129,.3);font-size:8px">⬆ Push to Canvas</button>
</div>
<div style="display:flex;gap:3px;align-items:center">
<label style="font-size:8px;color:var(--dim);cursor:pointer;display:flex;align-items:center;gap:3px"><input type="checkbox" id="code-autosync" style="width:10px;height:10px"> Auto-sync</label>
<button class="tm-align" onclick="codeClear()" style="font-size:8px">Clear</button>
</div>
</div>
<textarea id="code-editor" spellcheck="false" oninput="codeEditorChanged()" style="flex:1;min-height:360px;background:#0d1117;color:#e6edf3;border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.6;resize:none;tab-size:2;white-space:pre;overflow:auto" placeholder="Write HTML + CSS + JS, then Push to Canvas.
Or use the visual tools and Pull from Canvas to see generated code.

Auto-sync keeps both in sync automatically."></textarea>
<div style="display:flex;gap:3px;margin-top:6px;flex-wrap:wrap">
<button class="tm-align" onclick="codeSnippet('nav')">+ Nav</button>
<button class="tm-align" onclick="codeSnippet('hero')">+ Hero</button>
<button class="tm-align" onclick="codeSnippet('cards')">+ Cards</button>
<button class="tm-align" onclick="codeSnippet('cta')">+ CTA</button>
<button class="tm-align" onclick="codeSnippet('footer')">+ Footer</button>
<button class="tm-align" onclick="codeSnippet('form')">+ Form</button>
<button class="tm-align" onclick="codeSnippet('grid')">+ Grid</button>
</div>
<div id="code-console" style="margin-top:6px;background:#0d1117;border:1px solid rgba(255,255,255,.06);border-radius:6px;padding:8px;font-family:'JetBrains Mono',monospace;font-size:9px;color:rgba(255,255,255,.4);max-height:60px;overflow:auto;display:none"></div>
</div>
</template>

<template id="tmpl-expproject">
<div class="field"><label>Save Project</label>
<div style="font-size:9px;color:var(--dim);margin-bottom:8px">Save your full project (blocks, styles, theme, animations) as a .wdx file. Re-import anytime to continue editing.</div>
<div style="display:flex;gap:4px;align-items:center;margin-bottom:8px">
<input type="text" id="proj-name" value="my-project" placeholder="Project name" style="flex:1;font-size:10px;padding:4px 8px;background:var(--bg2);border:1px solid var(--bdr);border-radius:4px;color:var(--t2);font-family:var(--mono)">
<span style="font-size:9px;color:var(--dim)">.wdx</span>
</div>
<button class="btn btn-primary" onclick="projSave()" style="width:100%">⬇ Save Project</button>
</div>
<div class="field" style="margin-top:16px"><label>Load Project</label>
<div style="font-size:9px;color:var(--dim);margin-bottom:8px">Import a saved .wdx project file. This will replace your current canvas.</div>
<button class="btn btn-secondary" onclick="document.getElementById('proj-file').click()" style="width:100%">📂 Open Project File</button>
<input type="file" id="proj-file" accept=".wdx,.json" onchange="projLoad(this)" style="display:none">
</div>
<div class="field" style="margin-top:16px"><label>Import HTML</label>
<div style="font-size:9px;color:var(--dim);margin-bottom:8px">Import an existing .html file. Elements are converted to editable blocks.</div>
<button class="btn btn-secondary" onclick="document.getElementById('html-file').click()" style="width:100%">📄 Import .html File</button>
<input type="file" id="html-file" accept=".html,.htm" onchange="htmlImport(this)" style="display:none">
</div>
<div class="field" style="margin-top:16px"><label>Project Info</label>
<div id="proj-info" style="font-family:var(--mono);font-size:9px;color:var(--dim);line-height:1.8"></div>
</div>
</template>

<template id="tmpl-exphtml">
<div class="field"><label>Full Page HTML</label>
<div style="font-size:9px;color:var(--dim);margin-bottom:8px">Complete standalone HTML file with all styles, fonts, and animation triggers.</div>
<button class="btn btn-primary" onclick="expCopyHTML()" style="width:100%;margin-bottom:6px">Copy Full HTML</button>
<div style="position:relative">
<pre id="exp-html-out" style="background:var(--bg2);border:1px solid var(--bdr);border-radius:8px;padding:12px;font-family:var(--mono);font-size:9px;color:var(--t3);max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;line-height:1.5;margin:0"></pre>
</div>
</div>
</template>

<template id="tmpl-expcss">
<div class="field"><label>CSS Variables</label>
<button class="btn btn-secondary btn-sm" onclick="expCopyCSS('vars')" style="float:right;margin-top:-4px">Copy</button>
<pre id="exp-css-vars" style="background:var(--bg2);border:1px solid var(--bdr);border-radius:8px;padding:12px;font-family:var(--mono);font-size:9px;color:var(--t3);max-height:120px;overflow:auto;white-space:pre-wrap;margin:0;line-height:1.5"></pre>
</div>
<div class="field"><label>Block Styles</label>
<button class="btn btn-secondary btn-sm" onclick="expCopyCSS('blocks')" style="float:right;margin-top:-4px">Copy</button>
<pre id="exp-css-blocks" style="background:var(--bg2);border:1px solid var(--bdr);border-radius:8px;padding:12px;font-family:var(--mono);font-size:9px;color:var(--t3);max-height:200px;overflow:auto;white-space:pre-wrap;margin:0;line-height:1.5"></pre>
</div>
<div class="field"><label>Keyframes</label>
<button class="btn btn-secondary btn-sm" onclick="expCopyCSS('keyframes')" style="float:right;margin-top:-4px">Copy</button>
<pre id="exp-css-kf" style="background:var(--bg2);border:1px solid var(--bdr);border-radius:8px;padding:12px;font-family:var(--mono);font-size:9px;color:var(--t3);max-height:120px;overflow:auto;white-space:pre-wrap;margin:0;line-height:1.5"></pre>
</div>
</template>

<template id="tmpl-expdownload">
<div class="field"><label>Download</label>
<div style="font-size:9px;color:var(--dim);margin-bottom:12px">Download your design as a standalone file.</div>
<div style="display:flex;flex-direction:column;gap:6px">
<button class="btn btn-primary" onclick="expDownload('html')" style="width:100%">⬇ Download .html</button>
<button class="btn btn-secondary" onclick="expDownload('css')" style="width:100%">⬇ Download .css only</button>
</div>
</div>
<div class="field" style="margin-top:12px"><label>Page Info</label>
<div id="exp-info" style="font-family:var(--mono);font-size:9px;color:var(--dim);line-height:1.8"></div>
</div>
</template>

<template id="tmpl-favicon">
<div class="row3">
<div class="field"><label>Emoji / Letter</label><input type="text" id="fav-text" value="A" maxlength="2" oninput="genFavicon()"></div>
<div class="field"><label>BG Color</label><input type="color" id="fav-bg" value="#1a1a26" oninput="genFavicon()"></div>
<div class="field"><label>Shape</label><select id="fav-shape" onchange="genFavicon()"><option value="square">Square</option><option value="rounded">Rounded</option><option value="circle">Circle</option></select></div>
</div>
<div class="field"><label>Font Size <span id="fav-fs-val" style="color:var(--acc)">64px</span></label><input type="range" id="fav-fs" min="24" max="100" value="64" oninput="genFavicon()"></div>
<div style="display:flex;gap:16px;align-items:flex-end;margin-top:16px;flex-wrap:wrap">
<div style="text-align:center"><canvas id="fav-128" width="128" height="128" style="border-radius:8px;border:1px solid var(--bdr)"></canvas><div style="font-family:var(--mono);font-size:10px;color:var(--t4);margin-top:4px">128×128</div></div>
<div style="text-align:center"><canvas id="fav-64" width="64" height="64" style="border-radius:6px;border:1px solid var(--bdr)"></canvas><div style="font-family:var(--mono);font-size:10px;color:var(--t4);margin-top:4px">64×64</div></div>
<div style="text-align:center"><canvas id="fav-32" width="32" height="32" style="border-radius:4px;border:1px solid var(--bdr)"></canvas><div style="font-family:var(--mono);font-size:10px;color:var(--t4);margin-top:4px">32×32</div></div>
<div style="text-align:center"><canvas id="fav-16" width="16" height="16" style="border-radius:2px;border:1px solid var(--bdr)"></canvas><div style="font-family:var(--mono);font-size:10px;color:var(--t4);margin-top:4px">16×16</div></div>
</div>
<div class="actions" style="margin-top:16px"><button class="btn btn-primary" onclick="downloadFav()">⬇ Download 128px PNG</button></div>
</template>

<template id="tmpl-qr">
<div class="field"><label>Content</label><textarea id="qr-text" rows="2" placeholder="https://your-site.com" oninput="genQR()"></textarea></div>
<div class="row3">
<div class="field"><label>Size <span id="qr-size-val" style="color:var(--acc)">200px</span></label><input type="range" id="qr-size" min="100" max="400" value="200" oninput="genQR()"></div>
<div class="field"><label>FG Color</label><input type="color" id="qr-fg" value="#ffffff" oninput="genQR()"></div>
<div class="field"><label>BG Color</label><input type="color" id="qr-bg" value="#0a0a0f" oninput="genQR()"></div>
</div>
<div class="preview-box" style="padding:20px"><canvas id="qr-canvas"></canvas></div>
<div class="actions"><button class="btn btn-primary" onclick="downloadQR()">⬇ Download PNG</button></div>
</template>

<template id="tmpl-mockup">
<div class="field"><label>Device</label><select id="mock-device" onchange="updateMockup()"><option value="phone">iPhone / Phone</option><option value="laptop">Laptop</option><option value="tablet">Tablet</option><option value="watch">Watch</option><option value="monitor">Desktop Monitor</option></select></div>
<div class="row">
<div class="field"><label>Screen Content</label><select id="mock-content" onchange="updateMockup()"><option value="gradient">Gradient</option><option value="solid">Solid Color</option><option value="mesh">Mesh Gradient</option></select></div>
<div class="field"><label>Screen Color</label><input type="color" id="mock-color" value="#a855f7" oninput="updateMockup()"></div>
</div>
<div class="preview-box preview-lg" style="padding:24px;flex-direction:column;gap:8px" id="mock-preview"></div>
</template>

<template id="tmpl-cheat">
<div class="field"><label>Topic</label><select id="cheat-topic" onchange="renderCheat()"><option value="flex">Flexbox</option><option value="grid">Grid</option><option value="position">Position</option><option value="display">Display</option></select></div>
<div id="cheat-content" style="margin-top:16px"></div>
</template>

</body></html>
